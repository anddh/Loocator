<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Loocator">
    
    <title>Loocator</title>

    <!-- Link to the Manifest File -->
    <link rel="manifest" href="manifest.json">

    <!-- Fonts & Performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">

    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <!-- Google Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- GOOGLE ANALYTICS START -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-C5W3F59SDX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-C5W3F59SDX');
    </script>
    <!-- GOOGLE ANALYTICS END -->

    <style>
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f8fafc; font-family: 'Fredoka', sans-serif; }
        #root { height: 100%; display: flex; flex-direction: column; }
        
        .map-wrapper { position: relative; flex-grow: 1; width: 100%; height: 100%; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; }
        .list-wrapper { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 50; background: #f8fafc; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        /* Updated map tile background color to match Voyager style */
        .leaflet-container { background: #d4dadc; }

        .pie-icon { text-shadow: 0 1px 3px rgba(0,0,0,0.4); }

        .user-pin-ring { position: absolute; width: 20px; height: 20px; border-radius: 50%; background-color: #475569; opacity: 0.7; animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        .user-pin-dot { position: absolute; width: 10px; height: 10px; border-radius: 50%; background-color: white; border: 2px solid #475569; top: 5px; left: 5px; animation: pulse-dot 1.25s cubic-bezier(0.455, 0.03, 0.515, 0.955) -0.4s infinite; }
        @keyframes pulse-ring { 0% { transform: scale(0.33); opacity: 1; } 80%, 100% { opacity: 0; } }
        @keyframes pulse-dot { 0% { transform: scale(0.8); } 50% { transform: scale(1); } 100% { transform: scale(0.8); } }

        .safe-pt { padding-top: env(safe-area-inset-top); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Hide scrollbar for inputs */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Custom Shake Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10% { transform: translateX(-2px); }
            20% { transform: translateX(2px); }
            30% { transform: translateX(-2px); }
            40% { transform: translateX(2px); }
            50% { transform: translateX(0); }
        }
        /* Applied to wrapper, not button, so active:scale works */
        .animate-shake-wrapper { animation: shake 3s cubic-bezier(.36,.07,.19,.97) infinite; }
    </style>

    <!-- Reliable React CDN -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div id="root">
        <div class="h-full w-full flex flex-col items-center justify-center bg-slate-50 text-slate-400 p-6 text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-slate-600 mb-4"></div>
            <h2 class="text-xl font-bold font-brand text-slate-600">Starting Loocator...</h2>
        </div>
    </div>

    <script>
        const html = htm.bind(React.createElement);
        const { useState, useEffect, useRef, useMemo } = React;

        const ICONS = {
            toilet: `<span class="material-symbols-rounded icon-sm">wc</span>`,
            water: `<span class="material-symbols-rounded icon-sm">water_drop</span>`,
            baby: `<span class="material-symbols-rounded icon-sm">child_care</span>`,
            target: `<span class="material-symbols-rounded icon-md">my_location</span>`,
            list: `<span class="material-symbols-rounded icon-sm">format_list_bulleted</span>`,
            map: `<span class="material-symbols-rounded icon-sm">map</span>`,
            search: `<span class="material-symbols-rounded icon-sm">search</span>`,
            nav: `<span class="material-symbols-rounded icon-md">near_me</span>`,
            x: `<span class="material-symbols-rounded icon-md">close</span>`,
            check: `<span class="material-symbols-rounded icon-sm">check</span>`,
            pin: `<span class="material-symbols-rounded icon-sm">location_on</span>`,
            van: `<span class="material-symbols-rounded icon-sm">airport_shuttle</span>`,
            eye: `<span class="material-symbols-rounded icon-md">streetview</span>`,
            shower: `<span class="material-symbols-rounded icon-sm">shower</span>`,
            filter: `<span class="material-symbols-rounded icon-sm">tune</span>`,
            download: `<span class="material-symbols-rounded icon-sm">download</span>`,
            plus: `<span class="material-symbols-rounded icon-md">add</span>`,
            edit: `<span class="material-symbols-rounded icon-sm">edit</span>`,
            note: `<span class="material-symbols-rounded icon-sm">rate_review</span>`,
            send: `<span class="material-symbols-rounded icon-sm">send</span>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M19 19c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V9c0-1.1.9-2 2-2h12c1.1 0 2 .9 2 2v10zM7 5h4V3h2v2h4v2H7V5z"/><circle cx="12" cy="14" r="3" fill="white" opacity="0.3"/></svg>`,
            drop: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M3 3h18v18H3V3zm16 16V5H5v14h14zM7 7h2v10H7V7zm4 0h2v10h-2V7zm4 0h2v10h-2V7zm4 0h2v10h-2V7zm4 0h2v10h-2V7z" clip-rule="evenodd"/></svg>`
        };

        const OVERPASS_SERVERS = ['https://overpass-api.de/api/interpreter', 'https://overpass.kumi.systems/api/interpreter'];
        
        // Colors mapping for the pie chart
        const TYPE_COLORS = {
            toilet: '#64748b', // slate-500
            water: '#14b8a6',  // teal-500
            baby: '#fb7185',   // rose-400
            shower: '#0ea5e9', // sky-500
            black: '#1e293b',  // slate-800
            grey: '#94a3b8'    // slate-400
        };

        // Global Cache to store addresses we've already fetched to avoid re-fetching on sort/filter
        const ADDRESS_CACHE = {};

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            if (!lat1 || !lon1 || !lat2 || !lon2) return { text: 'Unknown', km: 99999 };
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            const d = R * c; 
            return { text: d < 1 ? Math.round(d * 1000) + 'm' : d.toFixed(1) + 'km', km: d };
        }

        const Loader = () => html`<div class="flex items-center space-x-2 bg-slate-800/90 backdrop-blur px-4 py-2 rounded-full shadow-lg z-[1000] animate-bounce"><div class="w-4 h-4 border-2 border-slate-400 border-t-transparent rounded-full animate-spin"></div><span class="text-sm font-medium text-slate-200 font-brand">Scanning...</span></div>`;
        const AlertPill = ({ msg }) => html`<div class="px-4 py-2 rounded-full shadow-lg text-sm font-medium font-brand z-[1000] bg-orange-100 text-orange-800 border-2 border-white/50">${msg}</div>`;
        const Toast = ({ msg, visible }) => html`<div class=${'fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-slate-800/95 backdrop-blur text-slate-100 px-6 py-3 rounded-full shadow-xl transition-all duration-300 z-[2000] flex items-center space-x-2 font-brand ' + (visible ? 'opacity-100 translate-y-0 scale-100' : 'opacity-0 translate-y-4 scale-95 pointer-events-none')}><span>${msg}</span></div>`;

        const AboutModal = ({ onClose }) => html`
            <div class="fixed inset-0 z-[2000] flex items-center justify-center p-4">
                <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onClick=${onClose}></div>
                <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 relative transform transition-all scale-100">
                    <button onClick=${onClose} class="absolute top-4 right-4 p-2 bg-slate-50 rounded-full text-slate-400"><div class="w-5 h-5 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.x}}></div></button>
                    
                    <div class="text-center mb-6">
                        <div class="inline-block w-24 h-24 rounded-3xl bg-indigo-50 mb-4 shadow-sm overflow-hidden">
                            <img src="icon.png" class="w-full h-full object-cover" alt="Loocator" />
                        </div>
                        <h2 class="text-2xl font-bold font-brand text-slate-800">Loocator</h2>
                        <p class="text-slate-500 text-sm mt-1">v0.1</p>
                    </div>

                    <div class="space-y-4 text-center">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <p class="text-slate-600 font-medium text-sm">Made with love in England ❤️</p>
                        </div>

                        <div class="text-xs text-slate-400 space-y-2">
                            <p>Map Data © <a href="https://www.openstreetmap.org/copyright" target="_blank" class="underline hover:text-slate-600">OpenStreetMap</a> contributors</p>
                            <p>Tiles courtesy of <a href="https://carto.com/attributions" target="_blank" class="underline hover:text-slate-600">CARTO</a></p>
                            <p>Data available under ODbL.</p>
                            <p class="mt-4">© ${new Date().getFullYear()} Loocator</p>
                        </div>
                    </div>
                </div>
            </div>`;

        const FilterSheet = ({ freeOnly, setFreeOnly, bottleOnly, setBottleOnly, onClose }) => {
            const handleClose = () => { onClose(); };
            const toggleFree = () => { setFreeOnly(!freeOnly); };
            const toggleBottle = () => { setBottleOnly(!bottleOnly); };

            return html`
            <div class="fixed inset-0 z-[1600] flex flex-col justify-end pointer-events-none">
                <div class="absolute inset-0 bg-black/30 backdrop-blur-sm pointer-events-auto transition-opacity" onClick=${handleClose}></div>
                <div class="bg-white w-full rounded-t-3xl shadow-2xl p-6 pb-12 pointer-events-auto transform transition-transform duration-300">
                    <div class="flex justify-center mb-4"><div class="w-12 h-1.5 bg-slate-200 rounded-full"></div></div>
                    <div class="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold font-brand text-slate-800">Options</h2>
                        <button onClick=${handleClose} className="p-2 bg-slate-50 rounded-full text-slate-400"><div class="w-5 h-5 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.x}}></div></button>
                    </div>
                    <div class="space-y-4">
                        <label class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100" onClick=${toggleFree}>
                            <span class="font-medium text-slate-700">Free use only</span>
                            <div class=${'w-12 h-7 rounded-full relative transition-colors duration-200 ' + (freeOnly ? 'bg-emerald-500' : 'bg-slate-300')}><div class=${'absolute top-1 left-1 bg-white w-5 h-5 rounded-full shadow transition-transform duration-200 ' + (freeOnly ? 'translate-x-5' : 'translate-x-0')}></div></div>
                        </label>
                        <label class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100" onClick=${toggleBottle}>
                            <div><span class="font-medium text-slate-700 block">Bottle refill only</span><span class="text-xs text-slate-400">Only affects water points</span></div>
                            <div class=${'w-12 h-7 rounded-full relative transition-colors duration-200 ' + (bottleOnly ? 'bg-emerald-500' : 'bg-slate-300')}><div class=${'absolute top-1 left-1 bg-white w-5 h-5 rounded-full shadow transition-transform duration-200 ' + (bottleOnly ? 'translate-x-5' : 'translate-x-0')}></div></div>
                        </label>
                    </div>
                </div>
            </div>`;
        }

        const ContributeSheet = ({ lat, lon, onClose, onShowToast }) => {
            const [text, setText] = useState('');
            const [sending, setSending] = useState(false);
            const [sent, setSent] = useState(false);

            const handleClose = () => { onClose(); };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!text.trim()) return;
                setSending(true);

                try {
                    const formData = new FormData();
                    formData.append('lat', lat);
                    formData.append('lon', lon);
                    formData.append('text', text + ' #LoocatorApp');

                    // Post to OSM API (Anonymous note)
                    const res = await fetch('https://api.openstreetmap.org/api/0.6/notes.json', {
                        method: 'POST',
                        body: formData
                    });

                    if (res.ok) {
                        setSent(true);
                        onShowToast("Note sent to map editors!");
                        setTimeout(onClose, 2000);
                    } else {
                        throw new Error("Failed");
                    }
                } catch (err) {
                    onShowToast("Failed to send note. Try again.");
                    setSending(false);
                }
            };

            return html`
            <div class="fixed inset-0 z-[1600] flex flex-col justify-end pointer-events-none">
                <div class="absolute inset-0 bg-black/30 backdrop-blur-sm pointer-events-auto transition-opacity" onClick=${handleClose}></div>
                <div class="bg-white w-full rounded-t-3xl shadow-2xl p-6 pb-12 pointer-events-auto transform transition-transform duration-300">
                    <div class="flex justify-center mb-4"><div class="w-12 h-1.5 bg-slate-200 rounded-full"></div></div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold font-brand text-slate-800">Add Missing Spot</h2>
                        <button onClick=${handleClose} className="p-2 bg-slate-50 rounded-full text-slate-400"><div class="w-5 h-5 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.x}}></div></button>
                    </div>
                    
                    ${!sent ? html`
                        <div class="space-y-4">
                            <p class="text-slate-500 text-sm">Describe what is here (e.g. "Public toilet, 50p fee"). This will be sent anonymously to OpenStreetMap volunteers.</p>
                            <textarea 
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-slate-700 font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500 min-h-[100px]"
                                placeholder="Type description here..."
                                value=${text}
                                onInput=${(e) => setText(e.target.value)}
                                disabled=${sending}
                            ></textarea>
                            <button 
                                onClick=${handleSubmit}
                                disabled=${sending || !text.trim()}
                                class=${'w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 shadow-md transition-all ' + (sending || !text.trim() ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-indigo-600 text-white active:scale-95')}
                            >
                                ${sending ? html`<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>` : html`<div class="w-5 h-5 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.send}}></div>`}
                                <span>${sending ? 'Sending...' : 'Send Note'}</span>
                            </button>
                        </div>
                    ` : html`
                        <div class="flex flex-col items-center justify-center py-8 text-center animate-pulse">
                            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-4">
                                <span class="material-symbols-rounded text-3xl">check</span>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800">Thank you!</h3>
                            <p class="text-slate-500">Your contribution helps everyone.</p>
                        </div>
                    `}
                </div>
            </div>`;
        }

        const DetailsCard = ({ loc, userLoc, onClose }) => {
            if (!loc) return null;
            const [address, setAddress] = useState('Loading...');
            const [imageUrl, setImageUrl] = useState(null);

            const handleClose = () => { onClose(); };
            const handleAction = () => { };

            useEffect(() => {
                // If we already have a cached address from list view, use it immediately
                if (ADDRESS_CACHE[loc.id]) {
                    setAddress(ADDRESS_CACHE[loc.id]);
                    return;
                }

                const fetchAddr = async () => {
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${loc.lat}&lon=${loc.lon}&zoom=18&addressdetails=1`);
                        const data = await res.json();
                        const a = data.address || {};
                        const formatted = (a.road || a.pedestrian || '') + (a.house_number ? ', ' + a.house_number : '') + (a.suburb ? ' (' + a.suburb + ')' : '');
                        const finalAddr = formatted || "Address unavailable";
                        setAddress(finalAddr);
                        // Cache it for the list view to see later
                        ADDRESS_CACHE[loc.id] = finalAddr;
                    } catch (e) { setAddress("Address unavailable"); }
                };
                fetchAddr();
            }, [loc]);

            useEffect(() => {
                setImageUrl(null);
                const fetchImage = async () => {
                    if (loc.tags.image) { setImageUrl(loc.tags.image); return; }
                    if (loc.tags.wikidata) {
                        try {
                            const res = await fetch(`https://www.wikidata.org/w/api.php?action=wbgetclaims&property=P18&entity=${loc.tags.wikidata}&format=json&origin=*`);
                            const data = await res.json();
                            const claims = data.claims.P18;
                            if (claims && claims.length) setImageUrl(`https://commons.wikimedia.org/wiki/Special:FilePath/${encodeURIComponent(claims[0].mainsnak.datavalue.value)}?width=600`);
                        } catch (e) {}
                    }
                };
                fetchImage();
            }, [loc]);

            const distObj = userLoc ? calculateDistance(userLoc[0], userLoc[1], loc.lat, loc.lon) : null;
            const isPaid = loc.tags.fee === 'yes' || (loc.tags.fee && loc.tags.fee !== 'no');
            
            let headerBg = 'bg-slate-100 text-slate-600';
            if (loc.displayType === 'water') headerBg = 'bg-teal-50 text-teal-700';
            if (loc.displayType === 'baby') headerBg = 'bg-rose-50 text-rose-700';
            if (loc.displayType === 'grey') headerBg = 'bg-slate-200 text-slate-700';
            if (loc.displayType === 'black') headerBg = 'bg-slate-700 text-slate-100';
            if (loc.displayType === 'shower') headerBg = 'bg-sky-50 text-sky-700';

            return html`
                <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl z-[1500] sheet-transition transform translate-y-0 flex flex-col max-h-[85vh] safe-pb">
                    <div class="w-full flex justify-center pt-3 pb-1" onClick=${handleClose}><div class="w-12 h-1.5 bg-slate-200 rounded-full"></div></div>
                    ${imageUrl ? html`<div class="w-full h-48 bg-slate-100 relative overflow-hidden"><img src=${imageUrl} class="w-full h-full object-cover img-fade-in"/><div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div><button onClick=${handleClose} class="absolute top-4 right-4 p-2 bg-black/30 backdrop-blur rounded-full text-white"><div class="w-5 h-5 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.x}}></div></button></div>` : html`<div class="absolute top-2 right-4 z-10"><button onClick=${handleClose} class="p-2 bg-slate-50 rounded-full text-slate-400 hover:bg-slate-100"><div class="w-5 h-5 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.x}}></div></button></div>`}
                    <div class="p-6 pt-2 overflow-y-auto">
                        <div class="mb-4">
                            <div class="flex space-x-2 mb-2">
                                <div class=${'inline-flex items-center px-2.5 py-1 rounded-full text-[10px] uppercase font-bold tracking-wide ' + headerBg}>${loc.displayType.toUpperCase()}</div>
                                ${distObj && html`<div class="inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-bold tracking-wide bg-slate-100 text-slate-500">${distObj.text} AWAY</div>`}
                            </div>
                            <h2 class="text-2xl font-brand font-semibold text-slate-800 leading-tight">${loc.name}</h2>
                        </div>
                        <div class="mb-5 flex items-start space-x-2 text-slate-500"><div class="w-4 h-4 mt-0.5 shrink-0 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.pin}}></div><p class="text-sm font-medium leading-tight">${address}</p></div>
                        <div class="flex flex-wrap gap-2 mb-6">
                            <div class=${'px-3 py-1.5 rounded-lg text-sm font-semibold flex items-center gap-1 ' + (isPaid ? 'bg-orange-50 text-orange-700 border border-orange-100' : 'bg-emerald-50 text-emerald-700 border border-emerald-100')}>${isPaid ? 'Pay to use' : 'Free entry'}</div>
                            ${loc.isToilet && html`<div class="px-3 py-1.5 rounded-lg text-sm font-semibold bg-slate-100 text-slate-700 border border-slate-200 flex items-center gap-1"><span class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.toilet}}></span> Toilet</div>`}
                            ${loc.isWater && html`<div class="px-3 py-1.5 rounded-lg text-sm font-semibold bg-teal-50 text-teal-700 border border-teal-100 flex items-center gap-1"><span class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.water}}></span> Water</div>`}
                            ${loc.hasBaby && html`<div class="px-3 py-1.5 rounded-lg text-sm font-semibold bg-rose-50 text-rose-700 border border-rose-100 flex items-center gap-1"><span class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.baby}}></span> Baby Change</div>`}
                            ${loc.hasShower && html`<div class="px-3 py-1.5 rounded-lg text-sm font-semibold bg-sky-50 text-sky-700 border border-sky-100 flex items-center gap-1"><span class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.shower}}></span> Shower</div>`}
                            ${loc.isBlack && html`<div class="px-3 py-1.5 rounded-lg text-sm font-semibold bg-slate-800 text-slate-100 border border-slate-700 flex items-center gap-1"><span class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.trash}}></span> Black Waste</div>`}
                            ${loc.isGrey && html`<div class="px-3 py-1.5 rounded-lg text-sm font-semibold bg-slate-200 text-slate-700 border border-slate-300 flex items-center gap-1"><span class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.drop}}></span> Grey Waste</div>`}
                        </div>
                        <div class="space-y-3 mb-4">
                            <a href=${`https://www.google.com/maps/search/?api=1&query=${loc.lat},${loc.lon}`} target="_blank" onClick=${handleAction} class="w-full bg-slate-800 text-white font-semibold font-brand text-lg py-4 rounded-2xl flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform"><div class="w-6 h-6 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.nav}}></div><span>Navigate Here</span></a>
                            <a href=${`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${loc.lat},${loc.lon}`} target="_blank" onClick=${handleAction} class="w-full bg-indigo-50 text-indigo-700 font-semibold font-brand text-lg py-4 rounded-2xl flex items-center justify-center gap-2 shadow-sm active:scale-95 transition-transform border border-indigo-100"><div class="w-6 h-6 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.eye}}></div><span>Street Preview</span></a>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const ListItem = ({ loc, onClick, userPos, index }) => {
            let iconHtml = loc.displayType === 'black' ? ICONS.trash : loc.displayType === 'grey' ? ICONS.drop : ICONS[loc.displayType] || ICONS.toilet;
            
            // Pie Chart Logic
            const types = [];
            if (loc.isToilet) types.push('toilet');
            if (loc.isWater) types.push('water');
            if (loc.hasBaby) types.push('baby');
            if (loc.hasShower) types.push('shower');
            if (loc.isBlack) types.push('black');
            if (loc.isGrey) types.push('grey');
            
            if (types.length === 0) types.push('toilet');

            let backgroundStyle = '';
            if (types.length === 1) {
                 backgroundStyle = `background-color: ${TYPE_COLORS[types[0]]};`;
            } else {
                const segmentSize = 100 / types.length;
                const gradientParts = types.map((t, i) => {
                    const color = TYPE_COLORS[t];
                    const start = i * segmentSize;
                    const end = (i + 1) * segmentSize;
                    return `${color} ${start}% ${end}%`;
                });
                backgroundStyle = `background: conic-gradient(${gradientParts.join(', ')});`;
            }

            // Local state for fetched address
            const [fetchedAddr, setFetchedAddr] = useState(ADDRESS_CACHE[loc.id] || null);
            const [displayName, setDisplayName] = useState(loc.name);

            useEffect(() => {
                // If we already have it in cache, ensure state is synced
                if (ADDRESS_CACHE[loc.id]) {
                    setFetchedAddr(ADDRESS_CACHE[loc.id]);
                    return;
                }
            }, [loc.id, index]);

            const displayAddress = fetchedAddr || loc.rawAddress;

            return html`
                <div onClick=${() => { onClick(); }} class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between mb-3 active:scale-[0.98] transition-transform">
                    <div class="flex items-center space-x-4 overflow-hidden">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white shrink-0 shadow-sm pie-icon" style=${{ cssText: backgroundStyle }} dangerouslySetInnerHTML=${{__html: iconHtml}}></div>
                        <div class="flex flex-col overflow-hidden">
                            <h4 class="font-semibold text-slate-700 font-brand text-base leading-tight truncate">${displayName}</h4>
                            ${displayAddress && html`<p class="text-xs text-slate-400 truncate mt-0.5">${displayAddress}</p>`}
                        </div>
                    </div>
                    <span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full ml-2 shrink-0">${calculateDistance(userPos[0], userPos[1], loc.lat, loc.lon).text}</span>
                </div>
            `;
        }

        function App() {
            const [view, setView] = useState('map');
            const [allLocations, setAllLocations] = useState([]);
            const [selectedLoc, setSelectedLoc] = useState(null);
            const [loading, setLoading] = useState(false);
            const [toast, setToast] = useState({ msg: '', visible: false });
            const [zoomWarning, setZoomWarning] = useState(false);
            const [showFilters, setShowFilters] = useState(false);
            const [isCamperMode, setIsCamperMode] = useState(false);
            const [stdFilters, setStdFilters] = useState({ toilet: true, water: true, baby: true });
            const [vanFilters, setVanFilters] = useState({ black: true, grey: true, water: true, shower: true });
            const [freeOnly, setFreeOnly] = useState(false);
            const [bottleOnly, setBottleOnly] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [mapCenter, setMapCenter] = useState([51.505, -0.09]); 
            const [userPos, setUserPos] = useState([51.505, -0.09]); 
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [searchBounds, setSearchBounds] = useState(null); 
            const [isInstalled, setIsInstalled] = useState(false);
            const [showAbout, setShowAbout] = useState(false);
            
            // Contribution States
            const [showContribute, setShowContribute] = useState(false);
            const [isPickingLocation, setIsPickingLocation] = useState(false);
            const [contributeCoords, setContributeCoords] = useState(null);

            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef(null);
            const userMarkerRef = useRef(null);
            const camperModeRef = useRef(isCamperMode); // Ref to hold current state
            const fetchController = useRef(null); // Ref for AbortController

            useEffect(() => { 
                if (view === 'map' && mapInstanceRef.current) setTimeout(() => mapInstanceRef.current.invalidateSize(), 100); 
            }, [view]);

            // Sync Ref with State and Rescan
            useEffect(() => {
                camperModeRef.current = isCamperMode;
                // Trigger rescan when mode changes to ensure we hit the correct radius/waterfall logic
                if (mapInstanceRef.current) {
                    setLoading(true);
                    debouncedFetch(mapInstanceRef.current.getBounds());
                }
            }, [isCamperMode]);

            const showToast = (msg) => { setToast({ msg, visible: true }); setTimeout(() => setToast(prev => ({ ...prev, visible: false })), 3000); };
            
            const toggleMode = () => {
                setIsCamperMode(!isCamperMode);
            };
            
            const handleFilterClick = () => {
                setShowFilters(true);
            };
            
            const handleViewToggle = () => {
                setView(view === 'map' ? 'list' : 'map');
            };

            const visibleLocations = useMemo(() => {
                return allLocations.filter(loc => {
                    if (freeOnly && (loc.tags.fee === 'yes' || (loc.tags.fee && loc.tags.fee !== 'no'))) return false;
                    if (bottleOnly && loc.isWater && !loc.isToilet && !loc.hasBaby) {
                        if (loc.tags.amenity !== 'drinking_water' && loc.tags.bottle !== 'yes') return false;
                    }
                    return isCamperMode ? (vanFilters.black && loc.isBlack) || (vanFilters.grey && loc.isGrey) || (vanFilters.water && loc.isWater) || (vanFilters.shower && loc.hasShower) : (stdFilters.toilet && loc.isToilet) || (stdFilters.water && loc.isWater) || (stdFilters.baby && loc.hasBaby);
                }).map(loc => {
                    let displayType = loc.baseType;
                    if (isCamperMode) {
                        if (vanFilters.black && loc.isBlack) displayType = 'black';
                        else if (vanFilters.grey && loc.isGrey) displayType = 'grey';
                        else if (vanFilters.shower && loc.hasShower) displayType = 'shower';
                        else if (vanFilters.water && loc.isWater) displayType = 'water';
                    } else if (stdFilters.baby && loc.hasBaby && !stdFilters.toilet) displayType = 'baby';
                    return { ...loc, displayType };
                }).sort((a, b) => calculateDistance(userPos[0], userPos[1], a.lat, a.lon).km - calculateDistance(userPos[0], userPos[1], b.lat, b.lon).km);
            }, [allLocations, isCamperMode, stdFilters, vanFilters, userPos, freeOnly, bottleOnly]);
            
            const [inAreaLocs, furtherLocs] = useMemo(() => {
                if (!searchBounds) return [visibleLocations, []];
                const inArea = [];
                const further = [];
                visibleLocations.forEach(loc => {
                    if (searchBounds.contains([loc.lat, loc.lon])) {
                        inArea.push(loc);
                    } else {
                        further.push(loc);
                    }
                });
                return [inArea, further];
            }, [visibleLocations, searchBounds]);
            
            // Calculate if we should show the "Nothing nearby" hint
            const showListHint = !loading && view === 'map' && visibleLocations.length > 0 && inAreaLocs.length === 0;

            // UPDATED: Radius-based Fetch Logic with AbortController
            const fetchOverpass = async (bounds, retryRadius = null) => {
                // Abort previous request
                if (fetchController.current) {
                    fetchController.current.abort();
                }
                // Create new controller
                fetchController.current = new AbortController();
                const signal = fetchController.current.signal;

                const isVan = camperModeRef.current;
                const center = bounds.getCenter();
                
                let radius;

                if (retryRadius) {
                    radius = retryRadius;
                } else {
                    // Calculate visible radius from center to NorthEast corner
                    const ne = bounds.getNorthEast();
                    const dist = calculateDistance(center.lat, center.lng, ne.lat, ne.lng);
                    const visibleRadiusMeters = dist.km * 1000;

                    // Set minimums to ensure "Further Afield" is populated
                    // Standard: at least 2km or 1.5x view
                    // Van: at least 15km or 1.5x view (Vans travel further)
                    const minRadius = isVan ? 15000 : 2000; 
                    radius = Math.max(visibleRadiusMeters * 1.5, minRadius);
                }

                // Construct Query using around:radius
                const queryArea = `(around:${radius},${center.lat},${center.lng})`;
                const query = `[out:json][timeout:25];(nwr["amenity"="toilets"]${queryArea};nwr["amenity"="drinking_water"]${queryArea};nwr["amenity"="water_point"]${queryArea};nwr["amenity"="sanitary_dump_station"]${queryArea};nwr["amenity"="shower"]${queryArea};nwr["diaper"]${queryArea};nwr["changing_table"]${queryArea};);out center;`;
                
                try {
                    const res = await fetch('https://overpass-api.de/api/interpreter', { 
                        method: 'POST', 
                        body: 'data=' + encodeURIComponent(query),
                        signal: signal 
                    });
                    const data = await res.json();
                    
                    // Recursive Step: If empty, try next level
                    if (data.elements.length === 0) {
                         const nextRadius = radius * 2;
                         if (nextRadius <= 50000) { // Cap at 50km
                             showToast(`Scanning ${Math.round(nextRadius/1000)}km...`);
                             fetchOverpass(bounds, nextRadius);
                             return;
                         }
                         setLoading(false);
                         return; // Give up
                    }
                    
                    setAllLocations(data.elements.map(el => {
                        const lat = el.lat || (el.center && el.center.lat);
                        const lon = el.lon || (el.center && el.center.lon);
                        
                        if (!lat || !lon) return null;

                        let baseName = "Service Point";
                        if (el.tags.amenity === 'toilets') baseName = "Public Toilet";
                        else if (el.tags.amenity === 'drinking_water' || el.tags.amenity === 'water_point') baseName = "Water Point";
                        else if (el.tags.amenity === 'shower') baseName = "Public Shower";
                        else if (el.tags.amenity === 'sanitary_dump_station') baseName = "Chemical Disposal";
                        else if (el.tags.diaper === 'yes') baseName = "Baby Change";

                        const street = el.tags['addr:street'] || el.tags['addr:place'];
                        const city = el.tags['addr:city'] || el.tags['addr:town'] || el.tags['addr:village'];
                        const house = el.tags['addr:housenumber'];

                        let rawAddress = '';
                        if (house) rawAddress += house + ' ';
                        if (street) rawAddress += street;
                        if (city) rawAddress += (rawAddress ? ', ' : '') + city;

                        let finalName = el.tags.name;
                        if (!finalName) {
                            const operator = el.tags.operator;
                            if (street) {
                                finalName = `${street} ${baseName}`;
                            } else if (operator) {
                                finalName = `${operator} ${baseName}`;
                            } else if (el.tags.ref) {
                                finalName = `${baseName} (${el.tags.ref})`;
                            } else if (el.tags.fee) {
                                const feeText = el.tags.fee === 'no' ? 'Free' : 'Paid';
                                finalName = `${feeText} ${baseName}`;
                            } else if (el.tags.description) {
                                // Use first 4 words of description if available
                                const descWords = el.tags.description.split(' ');
                                if (descWords.length > 0) {
                                    finalName = descWords.slice(0, 4).join(' ') + (descWords.length > 4 ? '...' : '');
                                } else {
                                    finalName = baseName;
                                }
                            } else {
                                finalName = baseName;
                            }
                        }

                        return {
                            id: el.id, lat: lat, lon: lon, tags: el.tags,
                            isToilet: el.tags.amenity === 'toilets',
                            isWater: el.tags.amenity === 'drinking_water' || el.tags.amenity === 'water_point',
                            hasBaby: el.tags.diaper === 'yes' || el.tags.changing_table === 'yes',
                            hasShower: el.tags.amenity === 'shower' || el.tags.shower === 'yes',
                            isBlack: (el.tags.amenity === 'sanitary_dump_station' && el.tags['sanitary_dump_station:chemical_toilet'] !== 'no') || (el.tags.amenity === 'toilets' && el.tags.sanitary_dump_station === 'yes'),
                            isGrey: el.tags.amenity === 'sanitary_dump_station' && el.tags['sanitary_dump_station:grey_water'] !== 'no',
                            baseType: el.tags.amenity === 'sanitary_dump_station' ? 'dump' : el.tags.amenity === 'shower' ? 'shower' : el.tags.amenity === 'drinking_water' ? 'water' : 'toilet',
                            name: finalName,
                            rawAddress: rawAddress
                        };
                    }).filter(Boolean)); 
                    setLoading(false);
                } catch (e) { 
                    if (e.name !== 'AbortError') {
                        setLoading(false); 
                    }
                }
            };

            const debouncedFetch = useMemo(() => debounce((b) => fetchOverpass(b), 1000), []);

            const updateUserLocation = (coords, source) => {
                setUserPos(coords);
                setMapCenter(coords);
                
                // CRITICAL FIX: Clear old IP-based data if we are switching to GPS to avoid "Further Afield" artifact
                if (source === 'GPS') {
                    setAllLocations([]);
                }

                if (mapInstanceRef.current) {
                    const zoom = source === 'GPS' ? 17 : source === 'IP' ? 13 : 13;
                    mapInstanceRef.current.setView(coords, zoom);
                    if (!userMarkerRef.current) {
                        userMarkerRef.current = L.marker(coords, { icon: L.divIcon({ className: '', html: '<div class="user-pin-ring"></div><div class="user-pin-dot"></div>', iconSize: [20, 20] }) }).addTo(mapInstanceRef.current);
                    } else {
                        userMarkerRef.current.setLatLng(coords);
                    }
                    setSearchBounds(mapInstanceRef.current.getBounds());
                    debouncedFetch(mapInstanceRef.current.getBounds());
                }
                showToast(source === 'GPS' ? "Location found!" : source === 'IP' ? "Approximate location found" : "Using default location");
            };

            // PWA Logic: Check if installed, and handle install prompt
            useEffect(() => {
                // Check if already in standalone mode
                if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                    setIsInstalled(true);
                }

                // Listen for install event
                const handler = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                };
                window.addEventListener('beforeinstallprompt', handler);
                window.addEventListener('appinstalled', () => setIsInstalled(true));
                return () => {
                    window.removeEventListener('beforeinstallprompt', handler);
                    window.removeEventListener('appinstalled', () => setIsInstalled(true));
                }
            }, []);

            const handleInstall = () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            setDeferredPrompt(null);
                            setIsInstalled(true);
                        }
                    });
                } else {
                    // Fallback instructions
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                    if (isIOS) {
                        showToast("Tap 'Share' then 'Add to Home Screen'");
                    } else {
                        showToast("Use browser menu to Install App");
                    }
                }
            };

            useEffect(() => {
                if (!mapRef.current || mapInstanceRef.current) return;
                const map = L.map(mapRef.current, { zoomControl: false }).setView(mapCenter, 13);
                mapInstanceRef.current = map;
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '', // Attribution moved to About modal
                    subdomains: 'abcd',
                    maxZoom: 20
                }).addTo(map);
                markersRef.current = L.layerGroup().addTo(map);
                
                const handleMove = () => {
                     if (map.getZoom() < 13) { 
                        setZoomWarning(true); 
                        setAllLocations([]); 
                        markersRef.current.clearLayers(); 
                    } else { 
                        setZoomWarning(false); 
                        setLoading(true); 
                        const b = map.getBounds();
                        setSearchBounds(b);
                        debouncedFetch(b); 
                    }
                };

                map.on('moveend', handleMove);
                setLoading(true);

                const findLocation = async () => {
                    let gpsResolved = false;

                    // 1. Race to see if we can get IP location fast
                    try {
                        const res = await fetch('https://ipapi.co/json/');
                        if (res.ok) {
                            const data = await res.json();
                            if (!gpsResolved && data.latitude && data.longitude) {
                                updateUserLocation([data.latitude, data.longitude], 'IP');
                            }
                        }
                    } catch (e) { console.log('IP Loc failed'); }

                    // 2. Simultaneously try GPS (High Accuracy)
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            gpsResolved = true;
                            updateUserLocation([pos.coords.latitude, pos.coords.longitude], 'GPS');
                        },
                        (err) => { console.log('GPS denied'); },
                        { enableHighAccuracy: true, timeout: 10000 }
                    );
                };

                findLocation();

            }, []);

            useEffect(() => {
                if (!markersRef.current) return;
                markersRef.current.clearLayers();
                visibleLocations.forEach(loc => {
                    let iconHtml = loc.displayType === 'black' ? ICONS.trash : loc.displayType === 'grey' ? ICONS.drop : ICONS[loc.displayType] || ICONS.toilet;
                    
                    const types = [];
                    if (loc.isToilet) types.push('toilet');
                    if (loc.isWater) types.push('water');
                    if (loc.hasBaby) types.push('baby');
                    if (loc.hasShower) types.push('shower');
                    if (loc.isBlack) types.push('black');
                    if (loc.isGrey) types.push('grey');
                    
                    if (types.length === 0) types.push('toilet');

                    let backgroundStyle = '';
                    if (types.length === 1) {
                         backgroundStyle = `background-color: ${TYPE_COLORS[types[0]]};`;
                    } else {
                        const segmentSize = 100 / types.length;
                        const gradientParts = types.map((t, i) => {
                            const color = TYPE_COLORS[t];
                            const start = i * segmentSize;
                            const end = (i + 1) * segmentSize;
                            return `${color} ${start}% ${end}%`;
                        });
                        backgroundStyle = `background: conic-gradient(${gradientParts.join(', ')});`;
                    }

                    L.marker([loc.lat, loc.lon], { 
                        icon: L.divIcon({ 
                            className: '', 
                            html: `<div class="relative w-9 h-9"><div class="w-9 h-9 rounded-full flex items-center justify-center border-2 border-white text-white z-10 relative shadow-sm" style="${backgroundStyle}"><div class="pie-icon flex items-center justify-center">${iconHtml}</div></div></div>`, 
                            iconSize: [36, 36], 
                            iconAnchor: [18, 36] 
                        }) 
                    }).addTo(markersRef.current).on('click', () => { setSelectedLoc(loc); });
                });
            }, [visibleLocations]);

            const handleSearch = async (e) => { e.preventDefault(); if (!searchTerm) return; setLoading(true); try { const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(searchTerm)); const data = await res.json(); if (data && data.length > 0) { const result = data[0]; mapInstanceRef.current.flyTo([result.lat, result.lon], 16); setSearchTerm(''); showToast(`Welcome to ${result.display_name.split(',')[0]}`); } else { showToast('Place not found.'); } } catch (err) { showToast('Search failed.'); } finally { setLoading(false); } };
            const handleGPS = () => { if (!navigator.geolocation) { showToast('GPS not supported'); return; } showToast('Locating you...'); navigator.geolocation.getCurrentPosition((pos) => { const coords = [pos.coords.latitude, pos.coords.longitude]; updateUserLocation(coords, 'GPS'); }, (err) => showToast('GPS Access Denied'), { enableHighAccuracy: true }); };

            const startPickingLocation = () => {
                setIsPickingLocation(true);
                if (mapInstanceRef.current && mapInstanceRef.current.getZoom() < 18) {
                    mapInstanceRef.current.flyTo(mapInstanceRef.current.getCenter(), 18, { duration: 0.5 });
                }
            };

            const confirmLocation = () => {
                if (mapInstanceRef.current) {
                    const center = mapInstanceRef.current.getCenter();
                    setContributeCoords({ lat: center.lat, lon: center.lng });
                    setIsPickingLocation(false);
                    setShowContribute(true);
                }
            };

            const cancelPicking = () => {
                setIsPickingLocation(false);
            };

            const FilterBtn = ({ type, label, active, onClick, color = 'slate' }) => {
                const colors = { slate: 'bg-slate-600', teal: 'bg-teal-500', rose: 'bg-rose-400', black: 'bg-slate-800', grey: 'bg-slate-400', sky: 'bg-sky-500' };
                return html`<button onClick=${() => { onClick(); }} class=${'flex items-center space-x-2 px-4 py-2.5 rounded-full text-xs font-semibold shrink-0 ' + (active ? colors[color] + ' text-white shadow-sm' : 'bg-slate-100 text-slate-400')}><div class="flex items-center justify-center w-5 h-5" dangerouslySetInnerHTML=${{__html: ICONS[type]}}></div><span>${label}</span></button>`;
            };

            const goToLoc = (loc) => {
                setSelectedLoc(loc); 
                setView('map'); 
                
                const map = mapInstanceRef.current;
                if (map) {
                    const targetZoom = 17;
                    const point = map.project([loc.lat, loc.lon], targetZoom);
                    const offsetY = map.getSize().y * 0.25; 
                    const targetPoint = L.point(point.x, point.y + offsetY);
                    const newCenter = map.unproject(targetPoint, targetZoom);
                    
                    map.flyTo(newCenter, targetZoom);
                }
            }
            
            const handleViewChange = () => {
                setView('list');
            }

            return html`
                <div class="bg-white/95 backdrop-blur z-[100] shadow-sm safe-pt">
                    <div class="flex items-center justify-between px-5 pt-4 pb-2">
                        <h1 onClick=${() => setShowAbout(true)} class="text-2xl font-brand font-semibold text-slate-700 tracking-tight cursor-pointer hover:text-slate-900 transition-colors">Loocator</h1>
                        <div class="flex gap-2">
                            ${!isInstalled && html`<button onClick=${handleInstall} class="bg-indigo-100 text-indigo-600 px-3 py-2 rounded-full text-xs font-bold flex items-center gap-2"><div class="flex items-center justify-center w-4 h-4" dangerouslySetInnerHTML=${{__html: ICONS.download}}></div><span>Install</span></button>`}
                            <button onClick=${toggleMode} class=${'px-3 py-2 rounded-full text-xs font-bold flex items-center gap-2 transition-colors ' + (isCamperMode ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-100 text-slate-500')}><div class="flex items-center justify-center w-4 h-4" dangerouslySetInnerHTML=${{__html: ICONS.van}}></div><span>${isCamperMode ? 'Van On' : 'Van Mode'}</span></button>
                            <button onClick=${handleFilterClick} class="bg-slate-100 text-slate-500 px-3 py-2 rounded-full text-xs font-bold"><div class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.filter}}></div></button>
                            <button onClick=${handleViewToggle} class="bg-slate-100 text-slate-500 px-3 py-2 rounded-full text-xs font-bold"><div class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: view === 'map' ? ICONS.list : ICONS.map}}></div></button>
                        </div>
                    </div>
                    <div class="px-4 pb-2"><form onSubmit=${handleSearch} class="relative"><input type="text" placeholder="Search city..." class="w-full bg-slate-50 rounded-2xl py-3 pl-10 pr-4 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-slate-400 focus:bg-white shadow-inner text-slate-600 placeholder-slate-400" value=${searchTerm} onInput=${e => setSearchTerm(e.target.value)} /><button type="submit" class="absolute left-3.5 top-3 text-slate-400 w-5 h-5 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.search}}></button></form></div>
                    <div class="px-4 flex space-x-2 overflow-x-auto no-scrollbar pb-1">
                        ${!isCamperMode ? html`<${FilterBtn} type="toilet" label="Toilets" active=${stdFilters.toilet} onClick=${() => setStdFilters({...stdFilters, toilet: !stdFilters.toilet})} /><${FilterBtn} type="water" label="Water" active=${stdFilters.water} color="teal" onClick=${() => setStdFilters({...stdFilters, water: !stdFilters.water})} /><${FilterBtn} type="baby" label="Baby" active=${stdFilters.baby} color="rose" onClick=${() => setStdFilters({...stdFilters, baby: !stdFilters.baby})} />` : html`<${FilterBtn} type="trash" label="Black" active=${vanFilters.black} color="black" onClick=${() => setVanFilters({...vanFilters, black: !vanFilters.black})} /><${FilterBtn} type="drop" label="Grey" active=${vanFilters.grey} color="grey" onClick=${() => setVanFilters({...vanFilters, grey: !vanFilters.grey})} /><${FilterBtn} type="water" label="Tank" active=${vanFilters.water} color="teal" onClick=${() => setVanFilters({...vanFilters, water: !vanFilters.water})} /><${FilterBtn} type="shower" label="Shower" active=${vanFilters.shower} color="sky" onClick=${() => setVanFilters({...vanFilters, shower: !vanFilters.shower})} />`}
                    </div>
                </div>
                <div class="map-wrapper relative">
                    <div class="absolute top-4 left-0 right-0 flex justify-center z-[1000] pointer-events-none">
                        ${loading && html`<${Loader} />`}
                        ${zoomWarning && !loading && html`<${AlertPill} msg="Zoom in to find spots" />`}
                        
                        <!-- NEW LIST VIEW BUTTON -->
                        ${showListHint && html`
                            <div class="animate-shake-wrapper">
                                <button 
                                    onClick=${handleViewChange} 
                                    class="bg-white text-indigo-600 px-5 py-2.5 rounded-full shadow-lg text-sm font-bold font-brand z-[1000] pointer-events-auto active:scale-95 transition-transform flex items-center gap-2 mt-2"
                                >
                                    <span>Nothing nearby. View List</span>
                                    <div class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.list}}></div>
                                </button>
                            </div>
                        `}
                    </div>
                    
                    ${isPickingLocation && html`
                        <div class="absolute inset-0 z-[1100] pointer-events-none flex items-center justify-center">
                            <div class="text-indigo-600 drop-shadow-xl -translate-y-1/2">
                                <span class="material-symbols-rounded text-6xl">location_on</span>
                            </div>
                        </div>
                        <div class="absolute bottom-10 left-0 right-0 z-[1200] flex flex-col items-center space-y-3 px-6 pointer-events-auto">
                            <div class="bg-slate-800/80 backdrop-blur text-white px-4 py-2 rounded-full text-sm font-semibold shadow-lg">Move map to position pin</div>
                            <div class="flex w-full gap-3 max-w-sm">
                                <button onClick=${cancelPicking} class="flex-1 bg-white text-slate-600 font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-transform">Cancel</button>
                                <button onClick=${confirmLocation} class="flex-[2] bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-transform">Confirm Location</button>
                            </div>
                        </div>
                    `}

                    <div id="map" ref=${mapRef}></div>
                    
                    ${view === 'list' && html`<div class="list-wrapper p-4 pb-24 safe-pb">
                        ${inAreaLocs.length === 0 && furtherLocs.length === 0 && html`<div class="text-center text-slate-400 mt-20"><div class="w-16 h-16 mx-auto mb-4 text-slate-300 opacity-50 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.search}}></div><p class="font-brand text-lg">No spots visible.</p></div>`}
                        
                        ${inAreaLocs.map(loc => html`<${ListItem} key=${loc.id} loc=${loc} userPos=${userPos} onClick=${() => goToLoc(loc)} />`)}

                        ${furtherLocs.length > 0 && html`
                            <div class="py-4 flex items-center gap-4">
                                <div class="h-px bg-slate-200 flex-1"></div>
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Further Afield</span>
                                <div class="h-px bg-slate-200 flex-1"></div>
                            </div>
                            ${furtherLocs.map(loc => html`<${ListItem} key=${loc.id} loc=${loc} userPos=${userPos} onClick=${() => goToLoc(loc)} />`)}
                        `}
                    </div>`}
                </div>
                
                ${!isPickingLocation && !selectedLoc && html`
                    <button onClick=${startPickingLocation} class="absolute right-5 w-14 h-14 bg-white text-indigo-600 rounded-full shadow-lg flex items-center justify-center z-[1000] active:scale-90 transition-all duration-300 bottom-24" dangerouslySetInnerHTML=${{__html: ICONS.plus}}></button>

                    <button onClick=${handleGPS} class="absolute right-5 w-14 h-14 bg-slate-800 text-white rounded-full shadow-2xl flex items-center justify-center z-[1000] active:scale-90 transition-all duration-300 bottom-8" dangerouslySetInnerHTML=${{__html: ICONS.target}}></button>
                `}
                
                ${showFilters && html`<${FilterSheet} freeOnly=${freeOnly} setFreeOnly=${setFreeOnly} bottleOnly=${bottleOnly} setBottleOnly=${setBottleOnly} onClose=${() => setShowFilters(false)} />`}
                ${showAbout && html`<${AboutModal} onClose=${() => setShowAbout(false)} />`}
                ${showContribute && contributeCoords && html`<${ContributeSheet} lat=${contributeCoords.lat} lon=${contributeCoords.lon} onClose=${() => setShowContribute(false)} onShowToast=${showToast} />`}
                ${selectedLoc && html`<${DetailsCard} loc=${selectedLoc} userLoc=${userPos} onClose=${() => setSelectedLoc(null)} />`}
                <${Toast} msg=${toast.msg} visible=${toast.visible} />
            `;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(html`<${App} />`);
    </script>
</body>
</html>
