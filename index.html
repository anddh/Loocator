<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#18181b" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#f8fafc" media="(prefers-color-scheme: light)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Loocator">
    
    <title>Loocator</title>

    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media', 
            theme: {
                extend: {
                    fontFamily: { sans: ['Fredoka', 'sans-serif'], brand: ['Fredoka', 'sans-serif'] },
                    animation: {
                        'scale-in': 'scaleIn 0.2s ease-out forwards',
                        'scale-out': 'scaleOut 0.2s ease-in forwards',
                        'slide-up-card': 'slideUpCard 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-down-card': 'slideDownCard 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'stagger-fade': 'staggerFade 0.4s ease-out forwards',
                        'stagger-fade-out': 'staggerFadeOut 0.3s ease-in forwards',
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'pulse-fast': 'pulseFast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'ripple': 'ripple 2s infinite'
                    },
                    keyframes: {
                        scaleIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        scaleOut: { '0%': { opacity: '1', transform: 'scale(1)' }, '100%': { opacity: '0', transform: 'scale(0.95)' } },
                        slideUpCard: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        slideDownCard: { '0%': { transform: 'translateY(0)' }, '100%': { transform: 'translateY(100%)' } },
                        staggerFade: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        staggerFadeOut: { '0%': { opacity: '1', transform: 'translateY(0)' }, '100%': { opacity: '0', transform: 'translateY(20px)' } },
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.5)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        pulseFast: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.4' } },
                        ripple: { '0%': { boxShadow: '0 0 0 0 rgba(148, 163, 184, 0.4)' }, '70%': { boxShadow: '0 0 0 15px rgba(148, 163, 184, 0)' }, '100%': { boxShadow: '0 0 0 0 rgba(148, 163, 184, 0)' } }
                    }
                }
            }
        }
    </script>

    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f8fafc; font-family: 'Fredoka', sans-serif; }
        * { -webkit-tap-highlight-color: transparent; }
        @media (prefers-color-scheme: dark) {
            body, html { background-color: #09090b; }
            .leaflet-container { background: #09090b !important; }
        }
        #root { height: 100%; display: flex; flex-direction: column; }
        .map-wrapper { position: relative; flex-grow: 1; width: 100%; height: 100%; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; background: transparent; }
        .list-wrapper { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 50; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .leaflet-container { background: #d4dadc; }
        .pie-icon { text-shadow: 0 1px 3px rgba(0,0,0,0.4); }
        .user-pin-ring { position: absolute; width: 20px; height: 20px; border-radius: 50%; background-color: #475569; opacity: 0.7; animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        .user-pin-dot { position: absolute; width: 10px; height: 10px; border-radius: 50%; background-color: white; border: 2px solid #475569; top: 5px; left: 5px; animation: pulse-dot 1.25s cubic-bezier(0.455, 0.03, 0.515, 0.955) -0.4s infinite; z-index: 2; }
        
        .marching-ants {
            stroke: #0ea5e9;
            stroke-width: 4;
            stroke-dasharray: 12 12;
            animation: march 1s linear infinite;
            filter: drop-shadow(0 0 3px rgba(14, 165, 233, 0.5));
        }
        @keyframes march { to { stroke-dashoffset: -24; } }
        
        .safe-pt { padding-top: env(safe-area-inset-top); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* --- OFFLINE BANNER --- */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ef4444;
            color: white;
            text-align: center;
            padding: calc(env(safe-area-inset-top) + 2px) 0 4px 0;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            z-index: 9999;
            transform: translateY(-100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .offline-banner.visible { transform: translateY(0); }
    </style>
</head>
<body class="bg-slate-50 dark:bg-zinc-950 text-slate-900 dark:text-zinc-100 transition-colors duration-300" ontouchstart="">
    <div id="root">
        <div class="h-full w-full flex flex-col items-center justify-center bg-slate-50 dark:bg-zinc-950 text-slate-400 p-6 text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-slate-600 dark:border-zinc-400 mb-4"></div>
            <h2 class="text-xl font-bold font-brand text-slate-600 dark:text-zinc-300">Starting Loocator...</h2>
        </div>
    </div>

    <script>
        // --- SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'loocator-v1';
                    const ASSETS = [
                        '${window.location.pathname}',
                        'icon.png',
                        'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
                        'https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap'
                    ];
                    self.addEventListener('install', e => {
                        e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(ASSETS)));
                    });
                    self.addEventListener('fetch', e => {
                        e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
                    });
                `;
                const blob = new Blob([swCode], {type: 'application/javascript'});
                navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => {});
            });
        }

        const html = htm.bind(React.createElement);
        const { useState, useEffect, useRef, useMemo, forwardRef, useImperativeHandle } = React;

        const SB_URL = 'https://jnjovmqfbelouittlvhh.supabase.co';
        const SB_KEY = 'sb_publishable_SYpOip4dUTH0yT6MNUYF6A_94uy9Snd';
        let supabaseClient = null;
        try { if (window.supabase) supabaseClient = window.supabase.createClient(SB_URL, SB_KEY); } catch (e) {}

        const ICONS = {
            toilet: `<span class="material-symbols-rounded icon-sm">wc</span>`,
            water: `<span class="material-symbols-rounded icon-sm">water_drop</span>`,
            baby: `<span class="material-symbols-rounded icon-sm">child_care</span>`,
            target: `<span class="material-symbols-rounded icon-md">my_location</span>`,
            list: `<span class="material-symbols-rounded icon-sm">format_list_bulleted</span>`,
            map: `<span class="material-symbols-rounded icon-sm">map</span>`,
            search: `<span class="material-symbols-rounded icon-sm">search</span>`,
            x: `<span class="material-symbols-rounded icon-md">close</span>`,
            check: `<span class="material-symbols-rounded icon-sm">check</span>`,
            pin: `<span class="material-symbols-rounded icon-sm">location_on</span>`,
            van: `<span class="material-symbols-rounded icon-sm">airport_shuttle</span>`,
            eye: `<span class="material-symbols-rounded icon-md">streetview</span>`,
            shower: `<span class="material-symbols-rounded icon-sm">shower</span>`,
            filter: `<span class="material-symbols-rounded icon-sm">tune</span>`,
            download: `<span class="material-symbols-rounded icon-sm">download</span>`,
            plus: `<span class="material-symbols-rounded icon-md">add</span>`,
            send: `<span class="material-symbols-rounded icon-sm">send</span>`,
            clock: `<span class="material-symbols-rounded icon-sm">history</span>`,
            walk: `<span class="material-symbols-rounded icon-md">directions_walk</span>`,
            car: `<span class="material-symbols-rounded icon-md">directions_car</span>`,
            share: `<span class="material-symbols-rounded icon-sm">share</span>`, 
            trash: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M19 19c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V9c0-1.1.9-2 2-2h12c1.1 0 2 .9 2 2v10zM7 5h4V3h2v2h4v2H7V5z"/><circle cx="12" cy="14" r="3" fill="white" opacity="0.3"/></svg>`,
            drop: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M3 3h18v18H3V3zm16 16V5H5v14h14zM7 7h2v10H7V7zm4 0h2v10h-2V7zm4 0h2v10h-2V7zm4 0h2v10h-2V7zm4 0h2v10h-2V7zm4 0h2v10h-2V7zm4 0h2v10h-2V7z" clip-rule="evenodd"/></svg>`
        };

        const TYPE_COLORS = { toilet: '#64748b', water: '#14b8a6', baby: '#fb7185', shower: '#0ea5e9', black: '#1e293b', grey: '#94a3b8' };
        
        const safeParse = (key, fallback) => {
            try { const item = localStorage.getItem(key); return item ? JSON.parse(item) : fallback; } catch (e) { return fallback; }
        };

        let ADDRESS_CACHE = safeParse('loocator_addr_cache', {});
        const saveToAddrCache = (id, address) => {
            if (!id || !address) return; ADDRESS_CACHE[id] = address;
            if (Object.keys(ADDRESS_CACHE).length > 500) delete ADDRESS_CACHE[Object.keys(ADDRESS_CACHE)[0]];
            try { localStorage.setItem('loocator_addr_cache', JSON.stringify(ADDRESS_CACHE)); } catch(e) {}
        };

        let MAP_CACHE = safeParse('loocator_map_cache', {});
        const getMapCacheKey = (bounds, isVan) => {
            const center = bounds.getCenter();
            return `${Math.round(center.lat * 100) / 100}_${Math.round(center.lng * 100) / 100}_${isVan ? 'van' : 'std'}`;
        };
        const saveToMapCache = (bounds, data, isVan) => {
            const key = getMapCacheKey(bounds, isVan);
            MAP_CACHE[key] = { timestamp: Date.now(), data };
            if (Object.keys(MAP_CACHE).length > 50) delete MAP_CACHE[Object.keys(MAP_CACHE)[0]];
            try { localStorage.setItem('loocator_map_cache', JSON.stringify(MAP_CACHE)); } catch(e) {}
        };

        function calculateDistance(lat1, lon1, lat2, lon2) {
            if (!lat1 || !lon1 || !lat2 || !lon2) return { text: 'Unknown', km: 99999 };
            const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const dist = R * c;
            return { text: dist < 1 ? Math.round(dist * 1000) + 'm' : dist.toFixed(1) + 'km', km: dist };
        }

        const formatAddressFromData = (data) => {
            const a = data.address || {};
            return (a.road || a.pedestrian || '') + (a.house_number ? ', ' + a.house_number : '') + (a.suburb ? ' (' + a.suburb + ')' : '');
        };

        const triggerHaptic = () => { if (navigator.vibrate) navigator.vibrate(10); };
        const debounce = (func, wait) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func(...args), wait); }; };

        const Toast = ({ msg, visible }) => html`<div class=${'fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-slate-800/95 dark:bg-zinc-800/95 backdrop-blur text-slate-100 px-6 py-3 rounded-full shadow-xl transition-all duration-300 z-[2000] flex items-center space-x-2 font-brand ' + (visible ? 'opacity-100 translate-y-0 scale-100' : 'opacity-0 translate-y-4 scale-95 pointer-events-none')}><span>${msg}</span></div>`;

        function App() {
            const [isOffline, setIsOffline] = useState(!navigator.onLine);
            const [view, setView] = useState('map');
            const [allLocations, setAllLocations] = useState([]);
            const [selectedLoc, setSelectedLoc] = useState(null);
            const [loading, setLoading] = useState(false);
            const [toast, setToast] = useState({ msg: '', visible: false });
            const [isCamperMode, setIsCamperMode] = useState(localStorage.getItem('loocator_van_mode') === 'true');
            const [userPos, setUserPos] = useState(safeParse('loocator_last_pos', [51.505, -0.09]));
            const [searchTerm, setSearchTerm] = useState('');
            const [statuses, setStatuses] = useState({});

            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef(null);
            const fetchController = useRef(null);

            const showToast = (msg) => { setToast({ msg, visible: true }); setTimeout(() => setToast(p => ({ ...p, visible: false })), 3000); };

            // Connectivity Monitor
            useEffect(() => {
                const onOnline = () => { setIsOffline(false); showToast("Back online!"); };
                const onOffline = () => { setIsOffline(true); };
                window.addEventListener('online', onOnline);
                window.addEventListener('offline', onOffline);
                return () => { window.removeEventListener('online', onOnline); window.removeEventListener('offline', onOffline); };
            }, []);

            const fetchOverpass = async (bounds, retryRadius = null) => {
                if (fetchController.current) fetchController.current.abort();
                const isVan = isCamperMode;
                const cacheKey = getMapCacheKey(bounds, isVan);
                
                // Pull from cache instantly
                if (MAP_CACHE[cacheKey] && !retryRadius) {
                    setAllLocations(MAP_CACHE[cacheKey].data);
                    if (!navigator.onLine) { setLoading(false); return; }
                }

                if (!navigator.onLine) { setLoading(false); return; }

                fetchController.current = new AbortController();
                setLoading(true);
                const center = bounds.getCenter();
                const radius = retryRadius || 2000;
                const queryArea = `(around:${radius},${center.lat},${center.lng})`;
                const queryBody = isVan ? `nwr["amenity"~"sanitary_dump_station|water_point|shower"]${queryArea};` : `nwr["amenity"~"toilets|drinking_water|shower"]${queryArea};`;
                const query = `[out:json][timeout:25];(${queryBody});out center;`;

                try {
                    const res = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: 'data=' + encodeURIComponent(query), signal: fetchController.current.signal });
                    const data = await res.json();
                    const mapped = data.elements.map(el => ({
                        id: el.id, lat: el.lat || el.center.lat, lon: el.lon || el.center.lon,
                        name: el.tags.name || (el.tags.amenity === 'toilets' ? 'Public Toilet' : 'Service Point'),
                        tags: el.tags,
                        displayType: el.tags.amenity === 'toilets' ? 'toilet' : 'water'
                    }));
                    setAllLocations(mapped);
                    saveToMapCache(bounds, mapped, isVan);
                } catch (e) { if (e.name !== 'AbortError') showToast("Fetch failed"); } finally { setLoading(false); }
            };

            const debouncedFetch = useMemo(() => debounce((b) => fetchOverpass(b), 1000), [isCamperMode]);

            useEffect(() => {
                if (!mapRef.current || mapInstanceRef.current) return;
                const map = L.map(mapRef.current, { zoomControl: false, attributionControl: false }).setView(userPos, 15);
                mapInstanceRef.current = map;
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
                markersRef.current = L.layerGroup().addTo(map);
                
                map.on('moveend', () => {
                    const b = map.getBounds();
                    const c = map.getCenter();
                    localStorage.setItem('loocator_last_pos', JSON.stringify([c.lat, c.lng]));
                    debouncedFetch(b);
                });

                // Initial fetch
                debouncedFetch(map.getBounds());
            }, []);

            // Render Markers
            useEffect(() => {
                if (!markersRef.current) return;
                markersRef.current.clearLayers();
                allLocations.forEach(loc => {
                    L.marker([loc.lat, loc.lon], {
                        icon: L.divIcon({
                            className: '',
                            html: `<div class="w-8 h-8 rounded-full bg-slate-600 border-2 border-white flex items-center justify-center text-white shadow-lg">${ICONS[loc.displayType] || ICONS.toilet}</div>`,
                            iconSize: [32, 32]
                        })
                    }).addTo(markersRef.current).on('click', () => setSelectedLoc(loc));
                });
            }, [allLocations]);

            return html`
                <div class=${`offline-banner ${isOffline ? 'visible' : ''}`}>
                    No Connection â€” Using Offline Cache
                </div>

                <div class="bg-white/95 dark:bg-zinc-900/95 backdrop-blur z-[1700] shadow-sm safe-pt">
                    <div class="flex items-center justify-between px-5 pt-4 pb-2">
                        <h1 class="text-2xl font-brand font-semibold text-slate-700 dark:text-zinc-100">Loocator</h1>
                        <div class="flex gap-2">
                            <button onClick=${() => setIsCamperMode(!isCamperMode)} class=${`px-3 py-2 rounded-full text-xs font-bold transition-colors ${isCamperMode ? 'bg-rose-500 text-white' : 'bg-slate-100 text-slate-500'}`}>
                                <div class="flex items-center gap-1">${ICONS.van} <span>Van</span></div>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="map-wrapper relative bg-slate-200">
                    <div id="map" ref=${mapRef}></div>
                    ${loading && html`<div class="absolute top-4 left-1/2 -translate-x-1/2 z-[1000] bg-white px-4 py-2 rounded-full shadow-md text-xs font-bold animate-pulse">Scanning...</div>`}
                </div>

                <${Toast} msg=${toast.msg} visible=${toast.visible} />
            `;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(html`<${App} />`);
    </script>
</body>
</html>
