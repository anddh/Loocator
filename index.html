<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Loocator">
    <meta name="mobile-web-app-capable" content="yes">
    
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#09090b" media="(prefers-color-scheme: dark)">
    
    <title>Loocator</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media', 
            theme: {
                extend: {
                    fontFamily: { sans: ['Fredoka', 'sans-serif'], brand: ['Fredoka', 'sans-serif'] },
                    animation: {
                        'scale-in': 'scaleIn 0.2s ease-out forwards',
                        'scale-out': 'scaleOut 0.2s ease-in forwards',
                        'slide-up-card': 'slideUpCard 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-down-card': 'slideDownCard 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards'
                    },
                    keyframes: {
                        scaleIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        scaleOut: { '0%': { opacity: '1', transform: 'scale(1)' }, '100%': { opacity: '0', transform: 'scale(0.95)' } },
                        slideUpCard: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        slideDownCard: { '0%': { transform: 'translateY(0)' }, '100%': { transform: 'translateY(100%)' } }
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --sab: env(safe-area-inset-bottom); }
        body, html { 
            height: 100%; margin: 0; padding: 0; overflow: hidden; 
            background-color: #f8fafc; font-family: 'Fredoka', sans-serif;
            overscroll-behavior-y: none; /* Pull-to-refresh prevention */
            -webkit-tap-highlight-color: transparent;
        }
        @media (prefers-color-scheme: dark) { body, html { background-color: #09090b; } }
        #root { height: 100%; display: flex; flex-direction: column; }
        .map-wrapper { position: relative; flex-grow: 1; width: 100%; height: 100%; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; }
        .user-pin-ring { position: absolute; width: 24px; height: 24px; border-radius: 50%; background-color: #3b82f6; opacity: 0.3; animation: pulse-ring 2s infinite; }
        .user-pin-dot { position: absolute; width: 14px; height: 14px; border-radius: 50%; background-color: #3b82f6; border: 2.5px solid white; top: 5px; left: 5px; box-shadow: 0 0 8px rgba(0,0,0,0.2); }
        @keyframes pulse-ring { 0% { transform: scale(0.5); opacity: 0.8; } 100% { transform: scale(2.5); opacity: 0; } }
    </style>
</head>
<body class="bg-slate-50 dark:bg-zinc-950 transition-colors duration-300">
    <div id="root"></div>

    <script>
        const html = htm.bind(React.createElement);
        const { useState, useEffect, useRef, useMemo } = React;

        // --- SUPABASE ---
        const SB_URL = 'https://jnjovmqfbelouittlvhh.supabase.co';
        const SB_KEY = 'sb_publishable_SYpOip4dUTH0yT6MNUYF6A_94uy9Snd';
        let supabaseClient = null;
        try { if (window.supabase) supabaseClient = window.supabase.createClient(SB_URL, SB_KEY); } catch (e) {}

        const triggerHaptic = () => { if (navigator.vibrate) navigator.vibrate(12); };

        const OfflineBanner = ({ isOffline }) => html`
            <div class=${`fixed top-0 left-0 right-0 z-[4000] bg-rose-500 text-white text-[10px] font-bold text-center py-1.5 safe-pt transition-transform duration-500 ${isOffline ? 'translate-y-0' : '-translate-y-full'}`}>
                MODO OFFLINE (OFFLINE MODE) â€” Check local data only
            </div>`;

        const DetailsCard = ({ loc, userLoc, onClose, minimized, setMinimized, onReportStatus, statusData }) => {
            if (!loc) return null;
            const [isRatingMode, setIsRatingMode] = useState(false);
            const [userRating, setUserRating] = useState(0);

            const handleShare = async (e) => {
                e.stopPropagation(); triggerHaptic();
                const url = `${window.location.origin}${window.location.pathname}?lat=${loc.lat}&lon=${loc.lon}&id=${loc.id}`;
                if (navigator.share) { try { await navigator.share({ title: loc.name, url }); } catch(err){} }
                else { navigator.clipboard.writeText(url); alert("Link copied!"); }
            };

            const submitReport = (status) => {
                onReportStatus(loc.id, status, userRating);
                setIsRatingMode(false);
            };

            return html`
                <div style=${{ transform: minimized ? 'translateY(calc(100% - 140px))' : 'translateY(0)' }} 
                    class="fixed bottom-0 left-0 right-0 bg-white dark:bg-zinc-900 rounded-t-[32px] shadow-2xl z-[1500] transition-transform duration-500 ease-[cubic-bezier(0.16,1,0.3,1)]"
                    style="padding-bottom: calc(1rem + var(--sab))">
                    <div class="w-full flex justify-center py-4 cursor-pointer" onClick=${() => setMinimized(!minimized)}>
                        <div class="w-12 h-1 bg-slate-200 dark:bg-zinc-700 rounded-full"></div>
                    </div>
                    <div class="px-6">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-2xl font-bold tracking-tight">${loc.name}</h2>
                            <button onClick=${onClose} class="p-2 bg-slate-100 dark:bg-zinc-800 rounded-full text-slate-400">
                                <span class="material-symbols-rounded">close</span>
                            </button>
                        </div>
                        
                        <div class="flex items-center justify-between bg-slate-50 dark:bg-zinc-800/50 p-4 rounded-2xl mb-4 border border-slate-100 dark:border-zinc-800">
                            <div>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Status</span>
                                <div class="flex items-center gap-2">
                                    <span class=${`w-2.5 h-2.5 rounded-full ${statusData?.status === 'broken' ? 'bg-rose-500' : 'bg-emerald-500'}`}></span>
                                    <span class="text-sm font-bold">${statusData?.status === 'broken' ? 'Broken' : 'Working'}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                ${statusData?.rating && html`
                                    <div class="flex items-center gap-1 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 px-3 py-1 rounded-full font-bold text-sm">
                                        <span>${parseFloat(statusData.rating).toFixed(1)}</span>
                                        <span class="material-symbols-rounded text-base">star</span>
                                    </div>
                                `}
                                <button onClick=${() => setIsRatingMode(!isRatingMode)} class="px-4 py-2 bg-slate-800 dark:bg-zinc-200 text-white dark:text-zinc-900 rounded-xl text-xs font-bold active:scale-95 transition-transform">Verify</button>
                            </div>
                        </div>

                        ${isRatingMode && html`
                            <div class="mb-4 space-y-4 animate-scale-in bg-slate-100 dark:bg-zinc-800 p-4 rounded-2xl">
                                <div class="flex justify-center gap-2">
                                    ${[1,2,3,4,5].map(s => html`
                                        <button onClick=${() => setUserRating(s)} class=${`text-3xl transition-colors ${s <= userRating ? 'text-amber-400' : 'text-slate-300 dark:text-zinc-600'}`}>
                                            <span class="material-symbols-rounded text-4xl">star</span>
                                        </button>
                                    `)}
                                </div>
                                <div class="flex gap-2">
                                    <button onClick=${() => submitReport('working')} class="flex-1 py-3 bg-emerald-500 text-white rounded-xl font-bold active:scale-95 transition-all">Working</button>
                                    <button onClick=${() => submitReport('broken')} class="flex-1 py-3 bg-rose-500 text-white rounded-xl font-bold active:scale-95 transition-all">Broken</button>
                                </div>
                            </div>
                        `}

                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <button onClick=${() => window.open(`http://maps.apple.com/?daddr=${loc.lat},${loc.lon}`)} class="py-4 bg-zinc-100 dark:bg-zinc-800 rounded-2xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-all"><span class="material-symbols-rounded">directions_car</span> Drive</button>
                            <button onClick=${() => window.open(`https://www.google.com/maps/dir/?api=1&destination=${loc.lat},${loc.lon}&travelmode=walking`)} class="py-4 bg-zinc-100 dark:bg-zinc-800 rounded-2xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-all"><span class="material-symbols-rounded">directions_walk</span> Walk</button>
                        </div>
                        <button onClick=${handleShare} class="w-full py-4 bg-slate-800 text-white dark:bg-zinc-200 dark:text-zinc-900 rounded-2xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-all mb-4"><span class="material-symbols-rounded">share</span> Share Spot</button>
                    </div>
                </div>`;
        };

        function App() {
            const [allLocations, setAllLocations] = useState([]);
            const [selectedLoc, setSelectedLoc] = useState(null);
            const [cardMinimized, setCardMinimized] = useState(false);
            const [statuses, setStatuses] = useState({});
            const [isOffline, setIsOffline] = useState(!navigator.onLine);
            
            const savedPos = safeParse('loocator_last_pos', [51.505, -0.09]);
            const [userPos, setUserPos] = useState(savedPos);
            
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const markersRef = useRef(null);

            // SYNC STATUSES
            const fetchStatuses = async () => {
                if(!supabaseClient || !navigator.onLine) return;
                const { data } = await supabaseClient.from('amenity_status').select('*');
                const map = {}; if(data) data.forEach(s => map[s.id] = s); setStatuses(map);
            };

            const reportStatus = async (osmId, newStatus, rating = null) => {
                triggerHaptic();
                if(!supabaseClient || !navigator.onLine) return;

                const current = statuses[osmId] || { rating_sum: 0, rating_count: 0 };
                const prevSum = Number(current.rating_sum || 0);
                const prevCount = Number(current.rating_count || 0);

                let payload = { id: String(osmId), status: newStatus, last_verified: new Date().toISOString() };
                if (rating) {
                    const count = prevCount + 1;
                    const sum = prevSum + rating;
                    payload.rating_count = count;
                    payload.rating_sum = sum;
                    payload.rating = Number((sum / count).toFixed(2));
                }

                await supabaseClient.from('amenity_status').upsert(payload);
                setStatuses(prev => ({ ...prev, [osmId]: payload }));
            };

            useEffect(() => {
                // Register Service Worker
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js').catch(() => {});
                }

                // Listen for network changes
                window.addEventListener('online', () => setIsOffline(false));
                window.addEventListener('offline', () => setIsOffline(true));

                if (!mapRef.current) return;
                const map = L.map(mapRef.current, { zoomControl: false, attributionControl: false }).setView(userPos, 15);
                mapInstance.current = map;
                
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
                markersRef.current = L.layerGroup().addTo(map);

                const fetchNearby = async () => {
                    if (!navigator.onLine) return;
                    const c = map.getCenter();
                    const query = `[out:json];(nwr["amenity"="toilets"](around:3000,${c.lat},${c.lng}););out center;`;
                    try {
                        const res = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: 'data=' + encodeURIComponent(query) });
                        const data = await res.json();
                        setAllLocations(data.elements.map(el => ({
                            id: el.id, lat: el.lat || el.center.lat, lon: el.lon || el.center.lon,
                            name: el.tags.name || "Public Toilet", tags: el.tags
                        })));
                    } catch(e){}
                };

                map.on('moveend', () => {
                    const c = map.getCenter();
                    localStorage.setItem('loocator_last_pos', JSON.stringify([c.lat, c.lng]));
                    fetchNearby();
                });

                navigator.geolocation.getCurrentPosition(pos => {
                    const coords = [pos.coords.latitude, pos.coords.longitude];
                    setUserPos(coords);
                    map.flyTo(coords, 17, { duration: 1.5 });
                    L.marker(coords, { icon: L.divIcon({ className: '', html: '<div class="user-pin-ring"></div><div class="user-pin-dot"></div>' }) }).addTo(map);
                });

                fetchNearby(); fetchStatuses();
            }, []);

            useEffect(() => {
                if (!markersRef.current) return;
                markersRef.current.clearLayers();
                allLocations.forEach(loc => {
                    const s = statuses[loc.id]?.status;
                    const color = s === 'broken' ? '#f43f5e' : '#10b981';
                    L.circleMarker([loc.lat, loc.lon], { radius: 9, color: 'white', weight: 2.5, fillOpacity: 1, fillColor: color })
                     .addTo(markersRef.current).on('click', () => { triggerHaptic(); setSelectedLoc(loc); setCardMinimized(false); });
                });
            }, [allLocations, statuses]);

            return html`
                <div class="bg-white dark:bg-zinc-950 flex-1 flex flex-col overflow-hidden relative">
                    <${OfflineBanner} isOffline=${isOffline} />
                    
                    <div class="safe-pt px-6 pt-6 pb-2 flex justify-between items-center z-[2000]">
                        <h1 class="text-3xl font-brand font-bold tracking-tighter">Loocator</h1>
                        <button onClick=${() => window.location.reload()} class="p-2 bg-slate-100 dark:bg-zinc-800 rounded-full active:rotate-180 transition-transform duration-500">
                            <span class="material-symbols-rounded">refresh</span>
                        </button>
                    </div>

                    <div class="map-wrapper flex-1">
                        <div id="map" ref=${mapRef}></div>
                        <button onClick=${() => mapInstance.current.flyTo(userPos, 18)} class="absolute right-4 bottom-40 z-[1000] w-14 h-14 bg-slate-800 text-white rounded-full shadow-2xl flex items-center justify-center active:scale-90 transition-all">
                            <span class="material-symbols-rounded text-2xl">my_location</span>
                        </button>
                    </div>

                    ${selectedLoc && html`
                        <${DetailsCard} loc=${selectedLoc} statusData=${statuses[selectedLoc.id]}
                            onClose=${() => setSelectedLoc(null)} onReportStatus=${reportStatus}
                            minimized=${cardMinimized} setMinimized=${setCardMinimized} />
                    `}
                </div>`;
        }

        ReactDOM.createRoot(document.getElementById('root')).render(html`<${App} />`);
    </script>
</body>
</html>
