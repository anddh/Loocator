<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#18181b" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#f8fafc" media="(prefers-color-scheme: light)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Loocator">
    
    <title>Loocator</title>

    <link rel="manifest" href="manifest.json">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">

    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Fredoka', 'sans-serif'],
                        brand: ['Fredoka', 'sans-serif'],
                    },
                    animation: {
                        'scale-in': 'scaleIn 0.2s ease-out forwards',
                        'scale-out': 'scaleOut 0.2s ease-in forwards',
                        'slide-up-card': 'slideUpCard 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-down-card': 'slideDownCard 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'stagger-fade': 'staggerFade 0.4s ease-out forwards',
                        'stagger-fade-out': 'staggerFadeOut 0.3s ease-in forwards',
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'pulse-fast': 'pulseFast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'ripple': 'ripple 2s infinite'
                    },
                    keyframes: {
                        scaleIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        scaleOut: { '0%': { opacity: '1', transform: 'scale(1)' }, '100%': { opacity: '0', transform: 'scale(0.95)' } },
                        slideUpCard: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        slideDownCard: { '0%': { transform: 'translateY(0)' }, '100%': { transform: 'translateY(100%)' } },
                        staggerFade: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        staggerFadeOut: { '0%': { opacity: '1', transform: 'translateY(0)' }, '100%': { opacity: '0', transform: 'translateY(20px)' } },
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.5)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        pulseFast: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.4' } },
                        ripple: { '0%': { boxShadow: '0 0 0 0 rgba(148, 163, 184, 0.4)' }, '70%': { boxShadow: '0 0 0 15px rgba(148, 163, 184, 0)' }, '100%': { boxShadow: '0 0 0 0 rgba(148, 163, 184, 0)' } }
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-C5W3F59SDX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-C5W3F59SDX');
    </script>
    <style>
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f8fafc; font-family: 'Fredoka', sans-serif; }
        * { -webkit-tap-highlight-color: transparent; }
        @media (prefers-color-scheme: dark) {
            body, html { background-color: #09090b; }
            .leaflet-container { background: #09090b !important; }
        }
        #root { height: 100%; display: flex; flex-direction: column; }
        .map-wrapper { position: relative; flex-grow: 1; width: 100%; height: 100%; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; background: transparent; }
        .list-wrapper { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 50; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .leaflet-container { background: #d4dadc; }
        .pie-icon { text-shadow: 0 1px 3px rgba(0,0,0,0.4); }
        .user-pin-ring { position: absolute; width: 20px; height: 20px; border-radius: 50%; background-color: #475569; opacity: 0.7; animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        .user-pin-dot { position: absolute; width: 10px; height: 10px; border-radius: 50%; background-color: white; border: 2px solid #475569; top: 5px; left: 5px; animation: pulse-dot 1.25s cubic-bezier(0.455, 0.03, 0.515, 0.955) -0.4s infinite; }
        @media (prefers-color-scheme: dark) { .user-pin-ring { background-color: #a1a1aa; } .user-pin-dot { border-color: #a1a1aa; } }
        @keyframes pulse-ring { 0% { transform: scale(0.33); opacity: 1; } 80%, 100% { opacity: 0; } }
        @keyframes pulse-dot { 0% { transform: scale(0.8); } 50% { transform: scale(1); } 100% { transform: scale(0.8); } }
        .safe-pt { padding-top: env(safe-area-inset-top); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>

    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="bg-slate-50 dark:bg-zinc-950 text-slate-900 dark:text-zinc-100 transition-colors duration-300" ontouchstart="">
    <div id="root">
        <div class="h-full w-full flex flex-col items-center justify-center bg-slate-50 dark:bg-zinc-950 text-slate-400 p-6 text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-slate-600 dark:border-zinc-400 mb-4"></div>
            <h2 class="text-xl font-bold font-brand text-slate-600 dark:text-zinc-300">Starting Loocator...</h2>
        </div>
    </div>

    <script>
        const html = htm.bind(React.createElement);
        const { useState, useEffect, useRef, useMemo, forwardRef, useImperativeHandle } = React;

        const ICONS = {
            toilet: `<span class="material-symbols-rounded icon-sm">wc</span>`,
            water: `<span class="material-symbols-rounded icon-sm">water_drop</span>`,
            baby: `<span class="material-symbols-rounded icon-sm">child_care</span>`,
            target: `<span class="material-symbols-rounded icon-md">my_location</span>`,
            list: `<span class="material-symbols-rounded icon-sm">format_list_bulleted</span>`,
            map: `<span class="material-symbols-rounded icon-sm">map</span>`,
            search: `<span class="material-symbols-rounded icon-sm">search</span>`,
            nav: `<span class="material-symbols-rounded icon-md">near_me</span>`,
            x: `<span class="material-symbols-rounded icon-md">close</span>`,
            check: `<span class="material-symbols-rounded icon-sm">check</span>`,
            pin: `<span class="material-symbols-rounded icon-sm">location_on</span>`,
            van: `<span class="material-symbols-rounded icon-sm">airport_shuttle</span>`,
            eye: `<span class="material-symbols-rounded icon-md">streetview</span>`,
            shower: `<span class="material-symbols-rounded icon-sm">shower</span>`,
            filter: `<span class="material-symbols-rounded icon-sm">tune</span>`,
            download: `<span class="material-symbols-rounded icon-sm">download</span>`,
            plus: `<span class="material-symbols-rounded icon-md">add</span>`,
            edit: `<span class="material-symbols-rounded icon-sm">edit</span>`,
            note: `<span class="material-symbols-rounded icon-sm">rate_review</span>`,
            send: `<span class="material-symbols-rounded icon-sm">send</span>`,
            clock: `<span class="material-symbols-rounded icon-sm">history</span>`,
            walk: `<span class="material-symbols-rounded icon-md">directions_walk</span>`,
            car: `<span class="material-symbols-rounded icon-md">directions_car</span>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M19 19c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V9c0-1.1.9-2 2-2h12c1.1 0 2 .9 2 2v10zM7 5h4V3h2v2h4v2H7V5z"/><circle cx="12" cy="14" r="3" fill="white" opacity="0.3"/></svg>`,
            drop: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M3 3h18v18H3V3zm16 16V5H5v14h14zM7 7h2v10H7V7zm4 0h2v10h-2V7zm4 0h2v10h-2V7zm4 0h2v10h-2V7zm4 0h2v10h-2V7z" clip-rule="evenodd"/></svg>`
        };

        const TYPE_COLORS = { toilet: '#64748b', water: '#14b8a6', baby: '#fb7185', shower: '#0ea5e9', black: '#1e293b', grey: '#94a3b8' };
        const ADDRESS_CACHE = {};

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            if (!lat1 || !lon1 || !lat2 || !lon2) return { text: 'Unknown', km: 99999 };
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return { text: (R * c) < 1 ? Math.round(R * c * 1000) + 'm' : (R * c).toFixed(1) + 'km', km: R * c };
        }

        const DetailsCard = ({ loc, userLoc, navAppDrive, navAppWalk, onClose, minimized, setMinimized }) => {
            if (!loc) return null;
            const [address, setAddress] = useState('Loading...');
            const [imageUrl, setImageUrl] = useState(null);
            const [isClosing, setIsClosing] = useState(false);
            const [animationFinished, setAnimationFinished] = useState(false);

            useEffect(() => {
                const timer = setTimeout(() => setAnimationFinished(true), 500);
                return () => clearTimeout(timer);
            }, []);

            const handleClose = () => { setIsClosing(true); setTimeout(onClose, 300); };
            const handleContainerClick = () => { if (minimized) setMinimized(false); };

            const handleDrive = (e) => { e.preventDefault(); e.stopPropagation(); let url = ''; const {lat, lon} = loc; if (navAppDrive === 'apple') url = `http://maps.apple.com/?daddr=${lat},${lon}&dirflg=d`; else if (navAppDrive === 'waze') url = `https://www.waze.com/ul?ll=${lat},${lon}&navigate=yes`; else url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`; window.open(url, '_blank'); };
            const handleWalk = (e) => { e.preventDefault(); e.stopPropagation(); let url = ''; const {lat, lon} = loc; if (navAppWalk === 'apple') url = `http://maps.apple.com/?daddr=${lat},${lon}&dirflg=w`; else url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=walking`; window.open(url, '_blank'); };

            useEffect(() => { if (ADDRESS_CACHE[loc.id]) { setAddress(ADDRESS_CACHE[loc.id]); return; } const fetchAddr = async () => { try { const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${loc.lat}&lon=${loc.lon}&zoom=18&addressdetails=1`); const data = await res.json(); const a = data.address || {}; const formatted = (a.road || a.pedestrian || '') + (a.house_number ? ', ' + a.house_number : '') + (a.suburb ? ' (' + a.suburb + ')' : ''); setAddress(formatted || "Address unavailable"); ADDRESS_CACHE[loc.id] = formatted || "Address unavailable"; } catch (e) { setAddress("Address unavailable"); } }; fetchAddr(); }, [loc]);
            useEffect(() => { setImageUrl(null); const fetchImage = async () => { if (loc.tags.image) { setImageUrl(loc.tags.image); return; } if (loc.tags.wikidata) { try { const res = await fetch(`https://www.wikidata.org/w/api.php?action=wbgetclaims&property=P18&entity=${loc.tags.wikidata}&format=json&origin=*`); const data = await res.json(); const claims = data.claims.P18; if (claims && claims.length) setImageUrl(`https://commons.wikimedia.org/wiki/Special:FilePath/${encodeURIComponent(claims[0].mainsnak.datavalue.value)}?width=600`); } catch (e) {} } }; fetchImage(); }, [loc]);

            const distObj = userLoc ? calculateDistance(userLoc[0], userLoc[1], loc.lat, loc.lon) : null;
            const isPaid = loc.tags.fee === 'yes' || (loc.tags.fee && loc.tags.fee !== 'no');
            let headerBg = loc.displayType === 'water' ? 'bg-teal-50 text-teal-700 dark:bg-teal-900/50 dark:text-teal-200' : loc.displayType === 'baby' ? 'bg-rose-50 text-rose-700 dark:bg-rose-900/50 dark:text-rose-200' : loc.displayType === 'shower' ? 'bg-sky-50 text-sky-700 dark:bg-sky-900/50 dark:text-sky-200' : 'bg-slate-100 text-slate-600 dark:bg-zinc-800 dark:text-zinc-300';
            const contentClass = `transition-opacity duration-300 ${minimized ? 'opacity-0 pointer-events-none' : 'opacity-100 delay-100'}`;

            return html`
                <div onClick=${handleContainerClick} style=${{ transform: minimized ? 'translateY(calc(100% - 160px))' : 'translateY(0)' }} 
                    class=${`fixed bottom-0 left-0 right-0 bg-white dark:bg-zinc-900 rounded-t-3xl shadow-2xl z-[1500] flex flex-col max-h-[85vh] safe-pb transition-transform duration-300 ease-in-out ${isClosing ? 'animate-slide-down-card' : (animationFinished ? '' : 'animate-slide-up-card')} ${minimized ? 'cursor-pointer' : ''}`}>
                    <div class="w-full flex justify-center pt-3 pb-1" onClick=${(e) => { e.stopPropagation(); if (!minimized) handleClose(); else setMinimized(false); }}><div class="w-12 h-1.5 bg-slate-200 dark:bg-zinc-700 rounded-full"></div></div>
                    ${imageUrl ? html`<div class="w-full h-48 bg-slate-100 dark:bg-zinc-800 relative overflow-hidden shrink-0"><img src=${imageUrl} class="w-full h-full object-cover"/><div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div><button onClick=${(e) => { e.stopPropagation(); handleClose(); }} class="absolute top-4 right-4 p-2 bg-black/30 backdrop-blur rounded-full text-white"><div class="w-5 h-5 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.x}}></div></button></div>` : html`<div class="absolute top-2 right-4 z-10"><button onClick=${(e) => { e.stopPropagation(); handleClose(); }} class="p-2 bg-slate-50 dark:bg-zinc-800 rounded-full text-slate-400 hover:bg-slate-100 dark:hover:bg-zinc-700"><div class="w-5 h-5 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.x}}></div></button></div>`}
                    <div class="p-6 pt-2 overflow-y-auto">
                        <div class="mb-4">
                            <div class="flex space-x-2 mb-2">
                                <div class=${'inline-flex items-center px-2.5 py-1 rounded-full text-[10px] uppercase font-bold tracking-wide ' + headerBg}>${loc.displayType.toUpperCase()}</div>
                                ${distObj && html`<div class="inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-bold tracking-wide bg-slate-100 text-slate-500 dark:bg-zinc-800 dark:text-zinc-400">${distObj.text} AWAY</div>`}
                            </div>
                            <h2 class="text-2xl font-brand font-semibold text-slate-800 dark:text-zinc-100 leading-tight">${loc.name}</h2>
                        </div>
                        <div class="mb-5 flex items-start space-x-2 text-slate-500 dark:text-zinc-400"><div class="w-4 h-4 mt-0.5 shrink-0 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.pin}}></div><p class="text-sm font-medium leading-tight">${address}</p></div>
                        <div class=${contentClass}>
                            <div class="flex flex-wrap gap-2 mb-6">
                                <div class=${'px-3 py-1.5 rounded-lg text-sm font-semibold flex items-center gap-1 ' + (isPaid ? 'bg-orange-50 text-orange-700 border border-orange-100 dark:bg-orange-900/30 dark:text-orange-200 dark:border-orange-900/50' : 'bg-emerald-50 text-emerald-700 border border-emerald-100 dark:bg-emerald-900/30 dark:text-emerald-200 dark:border-emerald-900/50')}>${isPaid ? 'Pay to use' : 'Free entry'}</div>
                                ${loc.isToilet && html`<div class="px-3 py-1.5 rounded-lg text-sm font-semibold bg-slate-100 text-slate-700 border border-slate-200 dark:bg-zinc-800 dark:text-zinc-300 dark:border-zinc-700 flex items-center gap-1"><span class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.toilet}}></span> Toilet</div>`}
                                ${loc.isWater && html`<div class="px-3 py-1.5 rounded-lg text-sm font-semibold bg-teal-50 text-teal-700 border border-teal-100 dark:bg-teal-900/30 dark:text-teal-200 dark:border-teal-900/50 flex items-center gap-1"><span class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.water}}></span> Water</div>`}
                                ${loc.hasBaby && html`<div class="px-3 py-1.5 rounded-lg text-sm font-semibold bg-rose-50 text-rose-700 border border-rose-100 dark:bg-rose-900/30 dark:text-rose-200 dark:border-rose-900/50 flex items-center gap-1"><span class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.baby}}></span> Baby Change</div>`}
                                ${loc.hasShower && html`<div class="px-3 py-1.5 rounded-lg text-sm font-semibold bg-sky-50 text-sky-700 border border-sky-100 dark:bg-sky-900/30 dark:text-sky-200 dark:border-sky-900/50 flex items-center gap-1"><span class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.shower}}></span> Shower</div>`}
                            </div>
                            <div class="space-y-3 mb-4">
                                <div class="flex gap-2">
                                    <button onClick=${handleDrive} class="flex-1 bg-slate-800 text-white dark:bg-zinc-700 font-semibold font-brand text-lg py-4 rounded-2xl flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform"><div class="w-6 h-6 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.car}}></div><span>Drive</span></button>
                                    <button onClick=${handleWalk} class="flex-1 bg-emerald-600 text-white dark:bg-emerald-700 font-semibold font-brand text-lg py-4 rounded-2xl flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform"><div class="w-6 h-6 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.walk}}></div><span>Walk</span></button>
                                </div>
                                <a href=${`https://www.google.com/maps/@?api=1&map_action=streetview&location=${loc.lat},${loc.lon}`} target="_blank" class="w-full bg-white text-slate-700 dark:bg-zinc-800 dark:text-zinc-300 font-semibold font-brand text-lg py-4 rounded-2xl flex items-center justify-center gap-2 shadow-sm active:scale-95 transition-transform border border-slate-200 dark:border-zinc-700"><div class="w-6 h-6 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.eye}}></div><span>Street Preview</span></a>
                            </div>
                        </div>
                    </div>
                </div>`;
        };

        const FilterBtn = ({ type, label, active, onClick, color = 'slate' }) => {
            const colors = { slate: 'bg-slate-800 dark:bg-zinc-600 border-slate-800', teal: 'bg-teal-500 dark:bg-teal-600 border-teal-500', rose: 'bg-rose-400 dark:bg-rose-500 border-rose-400', black: 'bg-slate-800 dark:bg-zinc-700 border-slate-800', grey: 'bg-slate-400 dark:bg-zinc-500 border-slate-400', sky: 'bg-sky-500 dark:bg-sky-600 border-sky-500' };
            return html`<div onClick=${onClick} class=${`flex items-center space-x-2 px-4 py-3 rounded-full text-xs font-bold shrink-0 transition-all duration-200 active:scale-90 border cursor-pointer select-none ${active ? colors[color] + ' text-white shadow-md' : 'bg-slate-50 dark:bg-zinc-800 text-slate-700 dark:text-zinc-300 border-slate-200 dark:border-zinc-700 shadow-sm'}`}><div class="flex items-center justify-center w-5 h-5" dangerouslySetInnerHTML=${{__html: ICONS[type]}}></div><span>${label}</span></div>`;
        };

        function App() {
            const [view, setView] = useState('map');
            const [isListExiting, setIsListExiting] = useState(false);
            const [allLocations, setAllLocations] = useState([]);
            const [selectedLoc, setSelectedLoc] = useState(null);
            const [cardMinimized, setCardMinimized] = useState(false);
            const [loading, setLoading] = useState(false);
            const [toast, setToast] = useState({ msg: '', visible: false });
            const [zoomWarning, setZoomWarning] = useState(false);
            const [showFilters, setShowFilters] = useState(false);
            const [isCamperMode, setIsCamperMode] = useState(false);
            const [stdFilters, setStdFilters] = useState({ toilet: true, water: true, baby: true });
            const [vanFilters, setVanFilters] = useState({ black: true, grey: true, water: true, shower: true });
            const [freeOnly, setFreeOnly] = useState(false);
            const [bottleOnly, setBottleOnly] = useState(false);
            const [accessOnly, setAccessOnly] = useState(false);
            const [keyOnly, setKeyOnly] = useState(false);
            const [navAppDrive, setNavAppDriveState] = useState('google');
            const [navAppWalk, setNavAppWalkState] = useState('google');
            const [searchTerm, setSearchTerm] = useState('');
            const [userPos, setUserPos] = useState([51.505, -0.09]);
            const [searchHistory, setSearchHistory] = useState([]);
            const [showHistory, setShowHistory] = useState(false);
            const [apiSuggestions, setApiSuggestions] = useState([]);
            const [historyMatches, setHistoryMatches] = useState([]);
            const [showContribute, setShowContribute] = useState(false);
            const [isPickingLocation, setIsPickingLocation] = useState(false);
            const [contributeCoords, setContributeCoords] = useState(null);
            const [gpsStatus, setGpsStatus] = useState('idle');
            const [isDarkMode, setIsDarkMode] = useState(window.matchMedia('(prefers-color-scheme: dark)').matches);

            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef(null);
            const userMarkerRef = useRef(null);
            const tileLayerRef = useRef(null);
            const fetchController = useRef(null);
            const selectedLocRef = useRef(null); 
            const cardMinimizedRef = useRef(false);

            useEffect(() => { selectedLocRef.current = selectedLoc; }, [selectedLoc]);
            useEffect(() => { cardMinimizedRef.current = cardMinimized; }, [cardMinimized]);

            useEffect(() => {
                const savedHistory = localStorage.getItem('loocator_history');
                if (savedHistory) setSearchHistory(JSON.parse(savedHistory));
                setNavAppDriveState(localStorage.getItem('loocator_nav_drive') || 'google');
                setNavAppWalkState(localStorage.getItem('loocator_nav_walk') || 'google');
                const mq = window.matchMedia('(prefers-color-scheme: dark)');
                const handleDark = (e) => setIsDarkMode(e.matches);
                mq.addEventListener('change', handleDark);
                return () => mq.removeEventListener('change', handleDark);
            }, []);

            // FIX: Robust Tile Loading Logic
            useEffect(() => {
                if (!mapInstanceRef.current) return;
                if (tileLayerRef.current) mapInstanceRef.current.removeLayer(tileLayerRef.current);
                const tileUrl = isDarkMode ? 'https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
                tileLayerRef.current = L.tileLayer(tileUrl, { attribution: '', subdomains: 'abcd', maxZoom: 20 }).addTo(mapInstanceRef.current);
            }, [isDarkMode]);

            const showToast = (msg) => { setToast({ msg, visible: true }); setTimeout(() => setToast(prev => ({ ...prev, visible: false })), 3000); };
            const addToHistory = (term) => { if (!term) return; const newHist = [term, ...searchHistory.filter(h => h.toLowerCase() !== term.toLowerCase())].slice(0, 5); setSearchHistory(newHist); localStorage.setItem('loocator_history', JSON.stringify(newHist)); };
            const fetchSuggestions = useMemo(() => debounce(async (term) => { if (!term || term.length < 3) { setApiSuggestions([]); return; } try { const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(term)}&addressdetails=1&limit=5`); const data = await res.json(); setApiSuggestions(data); } catch (e) {} }, 500), []);
            const handleInput = (e) => { const val = e.target.value; setSearchTerm(val); setShowHistory(true); if (val) { const fuse = new Fuse(searchHistory, { threshold: 0.4 }); setHistoryMatches(fuse.search(val).map(r => r.item)); } else setHistoryMatches([]); fetchSuggestions(val); };
            
            const fetchOverpass = async (bounds) => {
                if (fetchController.current) fetchController.current.abort();
                fetchController.current = new AbortController();
                const center = bounds.getCenter();
                const query = `[out:json][timeout:25];(nwr["amenity"~"toilets|drinking_water|water_point|sanitary_dump_station|shower"](around:5000,${center.lat},${center.lng});nwr["diaper"="yes"](around:5000,${center.lat},${center.lng}););out center;`;
                try {
                    const res = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: 'data=' + encodeURIComponent(query), signal: fetchController.current.signal });
                    const data = await res.json();
                    setAllLocations(data.elements.map(el => {
                        const lat = el.lat || el.center.lat, lon = el.lon || el.center.lon;
                        let baseName = el.tags.amenity === 'toilets' ? "Public Toilet" : el.tags.amenity === 'shower' ? "Shower" : "Service Point";
                        return { id: el.id, lat, lon, tags: el.tags, isToilet: el.tags.amenity === 'toilets', isWater: el.tags.amenity?.includes('water'), hasBaby: el.tags.diaper === 'yes', hasShower: el.tags.amenity === 'shower', isBlack: el.tags.amenity === 'sanitary_dump_station', name: el.tags.name || baseName, displayType: el.tags.amenity === 'shower' ? 'shower' : el.tags.amenity?.includes('water') ? 'water' : 'toilet' };
                    }));
                    setLoading(false);
                } catch (e) { if (e.name !== 'AbortError') setLoading(false); }
            };

            const debouncedFetch = useMemo(() => debounce((b) => fetchOverpass(b), 1000), []);

            useEffect(() => {
                if (mapInstanceRef.current) return;
                const map = L.map(mapRef.current, { zoomControl: false, attributionControl: false }).setView([51.505, -0.09], 13);
                mapInstanceRef.current = map;
                markersRef.current = L.layerGroup().addTo(map);
                map.on('click', () => { if (selectedLocRef.current) setCardMinimized(!cardMinimizedRef.current); });
                map.on('moveend', () => { if (map.getZoom() < 13) { setZoomWarning(true); setAllLocations([]); markersRef.current.clearLayers(); } else { setZoomWarning(false); setLoading(true); debouncedFetch(map.getBounds()); } });
                navigator.geolocation.getCurrentPosition(pos => {
                    const coords = [pos.coords.latitude, pos.coords.longitude];
                    setUserPos(coords);
                    map.setView(coords, 15);
                    userMarkerRef.current = L.marker(coords, { icon: L.divIcon({ className: '', html: '<div class="user-pin-ring"></div><div class="user-pin-dot"></div>' }) }).addTo(map);
                });
            }, []);

            useEffect(() => {
                if (!markersRef.current) return;
                markersRef.current.clearLayers();
                allLocations.forEach(loc => {
                    L.marker([loc.lat, loc.lon], { icon: L.divIcon({ className: '', html: `<div class="w-9 h-9 rounded-full flex items-center justify-center border-2 border-white dark:border-zinc-700 text-white shadow-sm" style="background-color: ${TYPE_COLORS[loc.displayType] || '#64748b'}"><span class="material-symbols-rounded text-sm">${loc.displayType === 'water' ? 'water_drop' : 'wc'}</span></div>`, iconSize: [36, 36], iconAnchor: [18, 36] }) })
                    .addTo(markersRef.current).on('click', () => { setSelectedLoc(loc); setCardMinimized(false); });
                });
            }, [allLocations]);

            return html`
                <div class="bg-white/95 dark:bg-zinc-900/95 backdrop-blur z-[1700] shadow-sm safe-pt">
                    <div class="flex items-center justify-between px-5 pt-4 pb-2">
                        <h1 onClick=${() => setShowAbout(true)} class="text-2xl font-brand font-semibold text-slate-700 dark:text-zinc-100 cursor-pointer">Loocator</h1>
                        <div class="flex gap-2">
                            <button onClick=${() => setIsCamperMode(!isCamperMode)} class=${'px-3 py-2 rounded-full text-xs font-bold flex items-center gap-2 ' + (isCamperMode ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-500')}>Van Mode</button>
                            <button onClick=${() => setShowFilters(true)} class="bg-slate-100 dark:bg-zinc-800 px-3 py-2 rounded-full text-slate-500"><div class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.filter}}></div></button>
                        </div>
                    </div>
                    <div class="px-4 pb-2 relative z-[1001]">
                        <form onSubmit=${(e) => { e.preventDefault(); searchWithTerm(searchTerm); }} class="relative">
                            <input type="search" name="q" id="search-input" inputmode="search" placeholder="Search city..." 
                                class="w-full bg-slate-50 dark:bg-zinc-800 rounded-2xl py-3 pl-10 pr-4 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-slate-500 dark:text-zinc-200" 
                                value=${searchTerm} onInput=${handleInput} onFocus=${() => setShowHistory(true)} onBlur=${() => setTimeout(() => setShowHistory(false), 200)} autocomplete="off"/>
                            <div class="absolute left-3.5 top-3 text-slate-400 w-5 h-5 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.search}}></div>
                        </form>
                    </div>
                    <div class="px-4 flex space-x-2 overflow-x-auto no-scrollbar pb-2">
                        <${FilterBtn} type="toilet" label="Toilets" active=${stdFilters.toilet} onClick=${() => setStdFilters({...stdFilters, toilet: !stdFilters.toilet})} />
                        <${FilterBtn} type="water" label="Water" active=${stdFilters.water} color="teal" onClick=${() => setStdFilters({...stdFilters, water: !stdFilters.water})} />
                    </div>
                </div>
                <div class="map-wrapper relative">
                    <div id="map" ref=${mapRef}></div>
                </div>
                ${selectedLoc && html`<${DetailsCard} loc=${selectedLoc} userLoc=${userPos} navAppDrive=${navAppDrive} navAppWalk=${navAppWalk} onClose=${() => setSelectedLoc(null)} minimized=${cardMinimized} setMinimized=${setCardMinimized} />`}
                <${Toast} msg=${toast.msg} visible=${toast.visible} />
            `;
        }
        ReactDOM.createRoot(document.getElementById('root')).render(html`<${App} />`);
    </script>
</body>
</html>
