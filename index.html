<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#18181b" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#f8fafc" media="(prefers-color-scheme: light)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Loocator">
    
    <title>Loocator</title>

    <link rel="manifest" href="manifest.json">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">

    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media', 
            theme: {
                extend: {
                    fontFamily: { sans: ['Fredoka', 'sans-serif'], brand: ['Fredoka', 'sans-serif'] },
                    animation: {
                        'scale-in': 'scaleIn 0.2s ease-out forwards',
                        'scale-out': 'scaleOut 0.2s ease-in forwards',
                        'slide-up-card': 'slideUpCard 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-down-card': 'slideDownCard 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'stagger-fade': 'staggerFade 0.4s ease-out forwards',
                        'stagger-fade-out': 'staggerFadeOut 0.3s ease-in forwards',
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'pulse-fast': 'pulseFast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'ripple': 'ripple 2s infinite'
                    },
                    keyframes: {
                        scaleIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        scaleOut: { '0%': { opacity: '1', transform: 'scale(1)' }, '100%': { opacity: '0', transform: 'scale(0.95)' } },
                        slideUpCard: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        slideDownCard: { '0%': { transform: 'translateY(0)' }, '100%': { transform: 'translateY(100%)' } },
                        staggerFade: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        staggerFadeOut: { '0%': { opacity: '1', transform: 'translateY(0)' }, '100%': { opacity: '0', transform: 'translateY(20px)' } },
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.5)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        pulseFast: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.4' } },
                        ripple: { '0%': { boxShadow: '0 0 0 0 rgba(148, 163, 184, 0.4)' }, '70%': { boxShadow: '0 0 0 15px rgba(148, 163, 184, 0)' }, '100%': { boxShadow: '0 0 0 0 rgba(148, 163, 184, 0)' } }
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-C5W3F59SDX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-C5W3F59SDX');
    </script>
    <style>
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f8fafc; font-family: 'Fredoka', sans-serif; }
        * { -webkit-tap-highlight-color: transparent; }
        @media (prefers-color-scheme: dark) {
            body, html { background-color: #09090b; }
            .leaflet-container { background: #09090b !important; }
        }
        #root { height: 100%; display: flex; flex-direction: column; }
        .map-wrapper { position: relative; flex-grow: 1; width: 100%; height: 100%; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; background: transparent; }
        .list-wrapper { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 50; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .leaflet-container { background: #d4dadc; }
        .pie-icon { text-shadow: 0 1px 3px rgba(0,0,0,0.4); }
        .user-pin-ring { position: absolute; width: 20px; height: 20px; border-radius: 50%; background-color: #475569; opacity: 0.7; animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        .user-pin-dot { position: absolute; width: 10px; height: 10px; border-radius: 50%; background-color: white; border: 2px solid #475569; top: 5px; left: 5px; animation: pulse-dot 1.25s cubic-bezier(0.455, 0.03, 0.515, 0.955) -0.4s infinite; z-index: 2; }
        
        /* --- ANIMATED BREADCRUMB CSS --- */
        .marching-ants {
            stroke: #0ea5e9; /* Tailwind Sky-500 */
            stroke-width: 4;
            stroke-dasharray: 12 12;
            animation: march 1s linear infinite;
            filter: drop-shadow(0 0 3px rgba(14, 165, 233, 0.5));
        }
        @media (prefers-color-scheme: dark) {
            .marching-ants { stroke: #38bdf8; } /* Sky-400 for dark mode */
        }
        @keyframes march {
            to { stroke-dashoffset: -24; }
        }
        
        .user-beam {
            position: absolute;
            top: -90px;  
            left: -40px; 
            width: 100px;
            height: 100px;
            background: radial-gradient(circle at 50% 100%, rgba(14, 165, 233, 0.4), transparent 70%);
            transform-origin: 50% 100%; 
            clip-path: polygon(0 0, 100% 0, 50% 100%); 
            pointer-events: none;
            z-index: -1;
            transition: transform 0.1s linear; 
            display: none;
        }

        @media (prefers-color-scheme: dark) { .user-pin-ring { background-color: #a1a1aa; } .user-pin-dot { border-color: #a1a1aa; } }
        @keyframes pulse-ring { 0% { transform: scale(0.33); opacity: 1; } 80%, 100% { opacity: 0; } }
        @keyframes pulse-dot { 0% { transform: scale(0.8); } 50% { transform: scale(1); } 100% { transform: scale(0.8); } }
        .safe-pt { padding-top: env(safe-area-inset-top); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-zinc-950 text-slate-900 dark:text-zinc-100 transition-colors duration-300" ontouchstart="">
    <div id="root">
        <div class="h-full w-full flex flex-col items-center justify-center bg-slate-50 dark:bg-zinc-950 text-slate-400 p-6 text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-slate-600 dark:border-zinc-400 mb-4"></div>
            <h2 class="text-xl font-bold font-brand text-slate-600 dark:text-zinc-300">Starting Loocator...</h2>
        </div>
    </div>

    <script>
        const html = htm.bind(React.createElement);
        const { useState, useEffect, useRef, useMemo, forwardRef, useImperativeHandle } = React;

        // --- GLOBAL SUPABASE INIT (Fault Tolerant) ---
        const SB_URL = 'https://jnjovmqfbelouittlvhh.supabase.co';
        const SB_KEY = 'sb_publishable_SYpOip4dUTH0yT6MNUYF6A_94uy9Snd';
        let supabaseClient = null;

        try {
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);
            }
        } catch (e) { console.error("Supabase load failed", e); }
        // ---------------------------------------------

        const ICONS = {
            toilet: `<span class="material-symbols-rounded icon-sm">wc</span>`,
            water: `<span class="material-symbols-rounded icon-sm">water_drop</span>`,
            baby: `<span class="material-symbols-rounded icon-sm">child_care</span>`,
            target: `<span class="material-symbols-rounded icon-md">my_location</span>`,
            list: `<span class="material-symbols-rounded icon-sm">format_list_bulleted</span>`,
            map: `<span class="material-symbols-rounded icon-sm">map</span>`,
            search: `<span class="material-symbols-rounded icon-sm">search</span>`,
            nav: `<span class="material-symbols-rounded icon-md">near_me</span>`,
            x: `<span class="material-symbols-rounded icon-md">close</span>`,
            check: `<span class="material-symbols-rounded icon-sm">check</span>`,
            pin: `<span class="material-symbols-rounded icon-sm">location_on</span>`,
            van: `<span class="material-symbols-rounded icon-sm">airport_shuttle</span>`,
            eye: `<span class="material-symbols-rounded icon-md">streetview</span>`,
            shower: `<span class="material-symbols-rounded icon-sm">shower</span>`,
            filter: `<span class="material-symbols-rounded icon-sm">tune</span>`,
            download: `<span class="material-symbols-rounded icon-sm">download</span>`,
            plus: `<span class="material-symbols-rounded icon-md">add</span>`,
            edit: `<span class="material-symbols-rounded icon-sm">edit</span>`,
            note: `<span class="material-symbols-rounded icon-sm">rate_review</span>`,
            send: `<span class="material-symbols-rounded icon-sm">send</span>`,
            clock: `<span class="material-symbols-rounded icon-sm">history</span>`,
            walk: `<span class="material-symbols-rounded icon-md">directions_walk</span>`,
            car: `<span class="material-symbols-rounded icon-md">directions_car</span>`,
            report: `<span class="material-symbols-rounded icon-sm">flag</span>`,
            share: `<span class="material-symbols-rounded icon-sm">share</span>`, 
            trash: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M19 19c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V9c0-1.1.9-2 2-2h12c1.1 0 2 .9 2 2v10zM7 5h4V3h2v2h4v2H7V5z"/><circle cx="12" cy="14" r="3" fill="white" opacity="0.3"/></svg>`,
            drop: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M3 3h18v18H3V3zm16 16V5H5v14h14zM7 7h2v10H7V7zm4 0h2v10h-2V7zm4 0h2v10h-2V7zm4 0h2v10h-2V7zm4 0h2v10h-2V7z" clip-rule="evenodd"/></svg>`
        };

        const TYPE_COLORS = { toilet: '#64748b', water: '#14b8a6', baby: '#fb7185', shower: '#0ea5e9', black: '#1e293b', grey: '#94a3b8' };
        
        const safeParse = (key, fallback) => {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : fallback;
            } catch (e) {
                return fallback;
            }
        };

        let ADDRESS_CACHE = safeParse('loocator_addr_cache', {});

        const saveToAddrCache = (id, address) => {
            if (!id || !address) return;
            ADDRESS_CACHE[id] = address;
            const keys = Object.keys(ADDRESS_CACHE);
            if (keys.length > 500) for(let i=0; i<50; i++) delete ADDRESS_CACHE[keys[i]];
            try { localStorage.setItem('loocator_addr_cache', JSON.stringify(ADDRESS_CACHE)); } catch(e) {}
        };

        let MAP_CACHE = safeParse('loocator_map_cache', {});
        try {
            const now = Date.now();
            Object.keys(MAP_CACHE).forEach(key => {
                if (now - MAP_CACHE[key].timestamp > 86400000) delete MAP_CACHE[key];
            });
        } catch(e) {}

        const getMapCacheKey = (bounds, isVan) => {
            const center = bounds.getCenter();
            return `${Math.round(center.lat * 100) / 100}_${Math.round(center.lng * 100) / 100}_${isVan ? 'van' : 'std'}`;
        };

        const saveToMapCache = (bounds, data, isVan) => {
            const key = getMapCacheKey(bounds, isVan);
            MAP_CACHE[key] = { timestamp: Date.now(), data };
            const keys = Object.keys(MAP_CACHE);
            if (keys.length > 50) delete MAP_CACHE[keys[0]]; 
            try { localStorage.setItem('loocator_map_cache', JSON.stringify(MAP_CACHE)); } catch(e) {}
        };

        const formatAddressFromData = (data) => {
            const a = data.address || {};
            return (a.road || a.pedestrian || '') + (a.house_number ? ', ' + a.house_number : '') + (a.suburb ? ' (' + a.suburb + ')' : '');
        };

        // --- NEW TIME HELPER ---
        const formatTimeAgo = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return days === 1 ? 'yesterday' : `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return 'just now';
        };
        // -----------------------

        const triggerHaptic = () => { if (navigator.vibrate) navigator.vibrate(10); };
        const triggerSuccess = () => { if (navigator.vibrate) navigator.vibrate(50); };

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            if (!lat1 || !lon1 || !lat2 || !lon2) return { text: 'Unknown', km: 99999 };
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return { text: (R * c) < 1 ? Math.round(R * c * 1000) + 'm' : (R * c).toFixed(1) + 'km', km: R * c };
        }

        function checkOpeningStatus(openingHours) {
            if (!openingHours) return null;
            if (openingHours === '24/7') return { status: 'open', text: 'Open 24/7', color: 'text-emerald-600 bg-emerald-100 dark:bg-emerald-900/30 dark:text-emerald-400' };
            
            const now = new Date();
            const days = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
            const currentDay = days[now.getDay()];
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            try {
                const hasSpecificDays = /[A-Z][a-z]/.test(openingHours);
                if (hasSpecificDays && !openingHours.includes(currentDay)) {
                    return { status: 'closed', text: 'Closed today', color: 'text-rose-600 bg-rose-100 dark:bg-rose-900/30 dark:text-rose-400' };
                }

                const timeMatch = openingHours.match(/(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/);
                if (timeMatch) {
                    const [_, h1, m1, h2, m2] = timeMatch;
                    const openMins = parseInt(h1) * 60 + parseInt(m1);
                    const closeMins = parseInt(h2) * 60 + parseInt(m2);
                    
                    if (currentMinutes >= openMins && currentMinutes < closeMins) {
                        const remaining = closeMins - currentMinutes;
                        if (remaining <= 30) return { status: 'closing', text: `Closing in ${remaining}m`, color: 'text-orange-600 bg-orange-100 dark:bg-orange-900/30 dark:text-orange-400' };
                        return { status: 'open', text: 'Open', color: 'text-emerald-600 bg-emerald-100 dark:bg-emerald-900/30 dark:text-emerald-400' };
                    }
                    return { status: 'closed', text: 'Closed', color: 'text-rose-600 bg-rose-100 dark:bg-rose-900/30 dark:text-rose-400' };
                }
            } catch (e) { return null; }
            return null;
        }

        const AlertPill = ({ msg }) => html`<div class="px-4 py-2 rounded-full shadow-lg text-sm font-medium font-brand z-[1000] bg-orange-100 text-orange-800 border-2 border-white/50 dark:bg-orange-900/80 dark:text-orange-200 dark:border-orange-800/50">${msg}</div>`;
        const Toast = ({ msg, visible }) => html`<div class=${'fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-slate-800/95 dark:bg-zinc-800/95 backdrop-blur text-slate-100 px-6 py-3 rounded-full shadow-xl transition-all duration-300 z-[2000] flex items-center space-x-2 font-brand ' + (visible ? 'opacity-100 translate-y-0 scale-100' : 'opacity-0 translate-y-4 scale-95 pointer-events-none')}><span>${msg}</span></div>`;

        // --- NEW COMPONENT: CamperDisclaimerModal ---
        const CamperDisclaimerModal = ({ onClose, onAccept }) => {
            const [isClosing, setIsClosing] = useState(false);
            const handleClose = () => { setIsClosing(true); setTimeout(onClose, 200); };
            const handleAccept = () => { setIsClosing(true); setTimeout(onAccept, 200); };

            return html`
            <div class="fixed inset-0 z-[2100] flex items-center justify-center p-4">
                <div class=${`absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300 ${isClosing ? 'opacity-0' : 'opacity-100'}`} onClick=${handleClose}></div>
                <div class=${`bg-rose-50 dark:bg-rose-950/20 w-full max-w-sm rounded-3xl shadow-2xl p-6 relative border-2 border-rose-100 dark:border-rose-900 ${isClosing ? 'animate-scale-out' : 'animate-scale-in'}`}>
                    <div class="flex flex-col items-center text-center space-y-4">
                        <div class="w-16 h-16 rounded-full bg-rose-100 dark:bg-rose-900/40 text-rose-600 dark:text-rose-400 flex items-center justify-center">
                            <span class="material-symbols-rounded text-3xl">airport_shuttle</span>
                        </div>
                        <h2 class="text-2xl font-bold font-brand text-rose-800 dark:text-rose-200">Camper Mode (Beta)</h2>
                        <div class="text-slate-600 dark:text-rose-200/80 text-sm leading-relaxed">
                            <p class="mb-2">You are entering experimental territory.</p>
                            <p>Data regarding chemical disposal and water points may be <strong>incomplete or inaccurate</strong>.</p>
                        </div>
                        <div class="flex flex-col w-full gap-2 mt-2">
                            <button onClick=${handleAccept} class="w-full py-3 bg-rose-500 hover:bg-rose-600 text-white font-bold rounded-xl shadow-lg shadow-rose-500/30 active:scale-95 transition-all">I Understand, Enable It</button>
                            <button onClick=${handleClose} class="w-full py-3 text-rose-600 dark:text-rose-300 font-bold hover:bg-rose-100/50 dark:hover:bg-rose-900/20 rounded-xl transition-colors">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>`;
        }
        // ---------------------------------------------

        const AboutModal = ({ onClose, onShowToast }) => {
            const [isClosing, setIsClosing] = useState(false);
            const [counts, setCounts] = useState({ addr: 0, map: 0 });

            useEffect(() => {
                setCounts({
                    addr: Object.keys(ADDRESS_CACHE).length,
                    map: Object.keys(MAP_CACHE).length
                });
            }, []);

            const handleClose = () => { setIsClosing(true); setTimeout(onClose, 200); };
            
            const handleClearCache = () => {
                if(confirm('Clear all saved data? This will remove offline addresses and map speed-ups.')) {
                    ADDRESS_CACHE = {};
                    MAP_CACHE = {};
                    localStorage.removeItem('loocator_addr_cache');
                    localStorage.removeItem('loocator_map_cache');
                    setCounts({ addr: 0, map: 0 });
                    if(onShowToast) onShowToast("All caches cleared");
                }
            };

            return html`
            <div class="fixed inset-0 z-[2000] flex items-center justify-center p-4">
                <div class=${`absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity duration-300 ${isClosing ? 'opacity-0' : 'opacity-100'}`} onClick=${handleClose}></div>
                <div class=${`bg-white dark:bg-zinc-900 w-full max-w-sm rounded-3xl shadow-2xl p-6 relative ${isClosing ? 'animate-scale-out' : 'animate-scale-in'}`}>
                    <button onClick=${handleClose} class="absolute top-4 right-4 p-2 bg-slate-50 dark:bg-zinc-800 rounded-full text-slate-400 hover:text-slate-600 dark:hover:text-zinc-200 transition-colors"><div class="w-5 h-5 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.x}}></div></button>
                    <div class="text-center mb-6">
                        <div class="inline-block w-24 h-24 rounded-3xl bg-slate-100 dark:bg-zinc-800 mb-4 shadow-sm overflow-hidden"><img src="icon.png" class="w-full h-full object-cover" alt="Loocator" /></div>
                        <h2 class="text-2xl font-bold font-brand text-slate-800 dark:text-zinc-100">Loocator</h2>
                        <p class="text-slate-500 dark:text-zinc-400 text-sm mt-1">v0.2.7</p>
                    </div>
                    <div class="space-y-4 text-center">
                        <div class="bg-slate-50 dark:bg-zinc-800 p-4 rounded-xl border border-slate-100 dark:border-zinc-700"><p class="text-slate-600 dark:text-zinc-300 font-medium text-sm">Made with love in Tenerife + England ‚ù§Ô∏è</p></div>
                        
                        <div class="bg-slate-50 dark:bg-zinc-800 p-3 rounded-xl border border-slate-100 dark:border-zinc-700 space-y-2">
                            <div class="flex justify-between items-center px-2">
                                <span class="text-xs text-slate-500 dark:text-zinc-400">Offline Addresses</span>
                                <span class="text-xs font-bold text-slate-700 dark:text-zinc-200">${counts.addr}</span>
                            </div>
                            <div class="flex justify-between items-center px-2">
                                <span class="text-xs text-slate-500 dark:text-zinc-400">Map Tiles Cached</span>
                                <span class="text-xs font-bold text-slate-700 dark:text-zinc-200">${counts.map}</span>
                            </div>
                            ${(counts.addr > 0 || counts.map > 0) && html`
                                <button onClick=${handleClearCache} class="w-full mt-2 py-2 text-[10px] font-bold text-rose-500 bg-rose-50 dark:bg-rose-900/20 rounded-lg uppercase tracking-wider">Clear Storage</button>
                            `}
                        </div>

                        <div class="text-xs text-slate-400 dark:text-zinc-500 space-y-2">
                            <p>Map Data ¬© <a href="https://www.openstreetmap.org/copyright" target="_blank" class="underline hover:text-slate-600 dark:hover:text-zinc-300">OpenStreetMap</a> contributors</p>
                            <p>Tiles courtesy of <a href="https://carto.com/attributions" target="_blank" class="underline hover:text-slate-600 dark:hover:text-zinc-300">CARTO</a></p>
                            <p>Powered by <a href="https://leafletjs.com" target="_blank" class="underline hover:text-slate-600 dark:hover:text-zinc-300">Leaflet</a> <span aria-label="Ukraine Flag">üá∫üá¶</span></p>
                            <p>Data available under ODbL.</p>
                            <p class="mt-4">¬© ${new Date().getFullYear()} Loocator</p>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        const ToggleCard = ({ label, subtext, icon, active, onClick, color }) => {
            const activeClass = active ? 'bg-slate-800 text-white border-slate-800 dark:bg-zinc-600 dark:border-zinc-500 transform' : 'bg-slate-50 text-slate-700 border-slate-200 dark:bg-zinc-800 dark:text-zinc-300 dark:border-zinc-700 transform';
            const activeIconBg = active ? 'bg-white/20' : 'bg-slate-200 dark:bg-zinc-700';
            return html`
                <div onClick=${() => { triggerHaptic(); onClick(); }} class=${`p-3 rounded-xl border transition-all duration-200 active:scale-95 flex flex-col justify-between h-20 ${activeClass}`}>
                    <div class="flex justify-between items-start w-full">
                        <div class=${`w-8 h-8 rounded-full flex items-center justify-center ${activeIconBg}`}><span class="material-symbols-rounded text-lg">${icon}</span></div>
                        <div class=${`w-10 h-6 rounded-full relative transition-colors duration-200 ${active ? 'bg-white/30' : 'bg-slate-300 dark:bg-zinc-600'}`}><div class=${`absolute top-1 left-1 bg-white w-4 h-4 rounded-full shadow transition-transform duration-200 ${active ? 'translate-x-4' : 'translate-x-0'}`}></div></div>
                    </div>
                    <div><div class="font-bold text-sm line-clamp-1">${label}</div>${subtext && html`<div class=${`text-[10px] leading-tight mt-0.5 ${active ? 'text-white/70' : 'text-slate-400 dark:text-zinc-500'} line-clamp-1`}>${subtext}</div>`}</div>
                </div>`;
        }

        const FilterSheet = forwardRef(({ freeOnly, setFreeOnly, bottleOnly, setBottleOnly, accessOnly, setAccessOnly, keyOnly, setKeyOnly, navAppDrive, setNavAppDrive, navAppWalk, setNavAppWalk, clearHistory, onClose, isCamperMode, toggleMode }, ref) => {
            const [isClosing, setIsClosing] = useState(false);
            const triggerClose = () => { setIsClosing(true); setTimeout(onClose, 300); };
            useImperativeHandle(ref, () => ({ triggerClose }));
            const handleClearHistory = () => { if (confirm('Clear all search history?')) { clearHistory(); } };
            return html`
            <div class="fixed inset-0 z-[1600] flex flex-col justify-end pointer-events-none">
                <div class=${`absolute inset-0 bg-black/30 backdrop-blur-sm pointer-events-auto transition-opacity duration-300 ${isClosing ? 'opacity-0' : 'opacity-100'}`} onClick=${triggerClose}></div>
                <div class=${`bg-white dark:bg-zinc-900 w-full rounded-t-3xl shadow-2xl p-5 pb-8 pointer-events-auto max-h-[85vh] overflow-y-auto ${isClosing ? 'animate-slide-down-card' : 'animate-slide-up-card'}`}>
                    <div class="flex justify-center mb-4"><div class="w-12 h-1.5 bg-slate-200 dark:bg-zinc-700 rounded-full"></div></div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold font-brand text-slate-800 dark:text-zinc-100">Options</h2>
                        <button onClick=${triggerClose} className="p-2 bg-slate-50 dark:bg-zinc-800 rounded-full text-slate-400"><div class="w-5 h-5 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.x}}></div></button>
                    </div>

                    <h3 class="text-xs font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-wider mb-2 px-1">App Mode</h3>
                    <div class="grid grid-cols-1 gap-2 mb-5">
                        <${ToggleCard} label="Camper Mode" subtext="Show chemical disposal, showers & tank refill" icon="airport_shuttle" active=${isCamperMode} onClick=${toggleMode} />
                    </div>

                    <h3 class="text-xs font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-wider mb-2 px-1">Map Filters</h3>
                    <div class="grid grid-cols-2 gap-2 mb-5">
                        <${ToggleCard} label="Free Use" icon="savings" active=${freeOnly} onClick=${() => setFreeOnly(!freeOnly)} />
                        <${ToggleCard} label="Accessible" subtext="Wheelchair friendly" icon="accessible" active=${accessOnly} onClick=${() => setAccessOnly(!accessOnly)} />
                        <${ToggleCard} label="Bottle Refill" subtext="Water points only" icon="water_bottle" active=${bottleOnly} onClick=${() => setBottleOnly(!bottleOnly)} />
                        <${ToggleCard} label="Key Access" subtext="Radar / Eurokey" icon="key" active=${keyOnly} onClick=${() => setKeyOnly(!keyOnly)} />
                    </div>

                    <h3 class="text-xs font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-wider mb-2 px-1">Navigation Defaults</h3>
                    <div class="space-y-2 mb-5">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold w-12 text-slate-500 dark:text-zinc-400">Drive</span>
                            <div class="flex-1 bg-slate-100 dark:bg-zinc-800 p-1 rounded-lg flex gap-1">
                                <button onClick=${() => setNavAppDrive('google')} class=${'flex-1 py-2 rounded-md text-xs font-bold transition-all flex items-center justify-center gap-1 transform active:scale-95 duration-200 ' + (navAppDrive === 'google' ? 'bg-white dark:bg-zinc-700 text-slate-800 dark:text-zinc-100 shadow-sm' : 'text-slate-500 dark:text-zinc-400 hover:text-slate-700 dark:hover:text-zinc-300')}><span>Google</span></button>
                                <button onClick=${() => setNavAppDrive('apple')} class=${'flex-1 py-2 rounded-md text-xs font-bold transition-all flex items-center justify-center gap-1 transform active:scale-95 duration-200 ' + (navAppDrive === 'apple' ? 'bg-white dark:bg-zinc-700 text-slate-800 dark:text-zinc-100 shadow-sm' : 'text-slate-500 dark:text-zinc-400 hover:text-slate-700 dark:hover:text-zinc-300')}><span>Apple</span></button>
                                <button onClick=${() => setNavAppDrive('waze')} class=${'flex-1 py-2 rounded-md text-xs font-bold transition-all flex items-center justify-center gap-1 transform active:scale-95 duration-200 ' + (navAppDrive === 'waze' ? 'bg-white dark:bg-zinc-700 text-slate-800 dark:text-zinc-100 shadow-sm' : 'text-slate-500 dark:text-zinc-400 hover:text-slate-700 dark:hover:text-zinc-300')}><span>Waze</span></button>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold w-12 text-slate-500 dark:text-zinc-400">Walk</span>
                            <div class="flex-1 bg-slate-100 dark:bg-zinc-800 p-1 rounded-lg flex gap-1">
                                <button onClick=${() => setNavAppWalk('google')} class=${'flex-1 py-2 rounded-md text-xs font-bold transition-all flex items-center justify-center gap-1 transform active:scale-95 duration-200 ' + (navAppWalk === 'google' ? 'bg-white dark:bg-zinc-700 text-slate-800 dark:text-zinc-100 shadow-sm' : 'text-slate-500 dark:text-zinc-400 hover:text-slate-700 dark:hover:text-zinc-300')}><span>Google</span></button>
                                <button onClick=${() => setNavAppWalk('apple')} class=${'flex-1 py-2 rounded-md text-xs font-bold transition-all flex items-center justify-center gap-1 transform active:scale-95 duration-200 ' + (navAppWalk === 'apple' ? 'bg-white dark:bg-zinc-700 text-slate-800 dark:text-zinc-100 shadow-sm' : 'text-slate-500 dark:text-zinc-400 hover:text-slate-700 dark:hover:text-zinc-300')}><span>Apple</span></button>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-slate-100 dark:border-zinc-800 pt-5">
                        <button onClick=${handleClearHistory} class="w-full py-3 text-rose-500 font-bold bg-rose-50 dark:bg-rose-900/20 rounded-xl hover:bg-rose-100 dark:hover:bg-rose-900/30 transition-all active:scale-95 duration-200 text-xs flex items-center justify-center gap-2 transform"><span class="material-symbols-rounded text-base">delete_history</span><span>Clear Search History</span></button>
                    </div>
                </div>
            </div>`;
        });

        const ContributeSheet = ({ lat, lon, onClose, onShowToast, isCorrection = false, correctionId = null, correctionName = '' }) => {
            const [text, setText] = useState('');
            const [sending, setSending] = useState(false);
            const [sent, setSent] = useState(false);
            const [isClosing, setIsClosing] = useState(false);
            const handleClose = () => { setIsClosing(true); setTimeout(onClose, 300); };
            const handleSubmit = async (e) => {
                e.preventDefault(); if (!text.trim()) return; setSending(true);
                try {
                    const formData = new FormData();
                    formData.append('lat', lat); formData.append('lon', lon);
                    let noteText = text + ' #LoocatorApp';
                    if (isCorrection) noteText = `Correction for ${correctionName} (ID: ${correctionId}): ` + noteText;
                    formData.append('text', noteText);
                    const res = await fetch('https://api.openstreetmap.org/api/0.6/notes.json', { method: 'POST', body: formData });
                    if (res.ok) { setSent(true); triggerSuccess(); setTimeout(handleClose, 2000); } else { throw new Error("Failed"); }
                } catch (err) { onShowToast("Failed to send note. Try again."); setSending(false); }
            };
            return html`
            <div class="fixed inset-0 z-[1600] flex flex-col justify-end pointer-events-none">
                <div class=${`absolute inset-0 bg-black/30 backdrop-blur-sm pointer-events-auto transition-opacity duration-300 ${isClosing ? 'opacity-0' : 'opacity-100'}`} onClick=${handleClose}></div>
                <div class=${`bg-white dark:bg-zinc-900 w-full rounded-t-3xl shadow-2xl p-6 pb-12 pointer-events-auto ${isClosing ? 'animate-slide-down-card' : 'animate-slide-up-card'}`}>
                    <div class="flex justify-center mb-4"><div class="w-12 h-1.5 bg-slate-200 dark:bg-zinc-700 rounded-full"></div></div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold font-brand text-slate-800 dark:text-zinc-100">${isCorrection ? 'Report Issue' : 'Add Missing Spot'}</h2>
                        <button onClick=${handleClose} className="p-2 bg-slate-50 dark:bg-zinc-800 rounded-full text-slate-400"><div class="w-5 h-5 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.x}}></div></button>
                    </div>
                    ${!sent ? html`
                        <div class="space-y-4">
                            <p class="text-slate-500 dark:text-zinc-400 text-sm">${isCorrection ? `What is wrong with "${correctionName}"? (e.g. wrong price, closed, doesn't exist)` : 'Describe what is here (e.g. "Public toilet, 50p fee"). This will be sent anonymously to OpenStreetMap volunteers.'}</p>
                            <textarea class="w-full bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 rounded-xl p-3 text-slate-700 dark:text-zinc-200 font-medium focus:outline-none focus:ring-2 focus:ring-slate-500 min-h-[100px]" placeholder="Type description here..." value=${text} onInput=${(e) => setText(e.target.value)} disabled=${sending}></textarea>
                            <button onClick=${handleSubmit} disabled=${sending || !text.trim()} class=${'w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 shadow-md transition-all ' + (sending || !text.trim() ? 'bg-slate-200 dark:bg-zinc-800 text-slate-400 dark:text-zinc-600 cursor-not-allowed' : 'bg-slate-800 text-white active:scale-95 dark:bg-zinc-700')}>${sending ? html`<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>` : html`<div class="w-5 h-5 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.send}}></div>`}<span>${sending ? 'Sending...' : (isCorrection ? 'Send Report' : 'Send Note')}</span></button>
                        </div>` : html`
                        <div class="flex flex-col items-center justify-center py-8 text-center animate-pulse"><div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-4"><span class="material-symbols-rounded text-3xl">check</span></div><h3 class="text-xl font-bold text-slate-800 dark:text-zinc-100">Thank you!</h3><p class="text-slate-500 dark:text-zinc-400">Your contribution helps everyone.</p></div>`}
                </div>
            </div>`;
        }

        const DetailsCard = ({ loc, userLoc, navAppDrive, navAppWalk, onClose, minimized, setMinimized, onReport, onShowToast, onReportStatus, statusData }) => {
            if (!loc) return null;
            const [address, setAddress] = useState('Loading...');
            const [imageUrl, setImageUrl] = useState(null);
            const [isClosing, setIsClosing] = useState(false);
            const [animationFinished, setAnimationFinished] = useState(false);
            useEffect(() => {
                const timer = setTimeout(() => setAnimationFinished(true), 500);
                return () => clearTimeout(timer);
            }, []);
            const handleClose = () => { setIsClosing(true); setTimeout(onClose, 300); };
            const handleContainerClick = () => { if (minimized) setMinimized(false); };
            
            const handleShare = (e) => {
                e.stopPropagation();
                triggerHaptic();
                const url = `${window.location.origin}${window.location.pathname}?lat=${loc.lat}&lon=${loc.lon}&id=${loc.id}`;
                if (navigator.share) {
                    navigator.share({ title: `Loocator: ${loc.name}`, text: `Check out this spot: ${loc.name}`, url: url }).catch(() => {});
                } else {
                    navigator.clipboard.writeText(url).then(() => onShowToast("Link copied to clipboard!"));
                }
            };

            const handleDrive = (e) => { e.preventDefault(); e.stopPropagation(); let url = ''; const {lat, lon} = loc; if (navAppDrive === 'apple') url = `http://maps.apple.com/?daddr=${lat},${lon}&dirflg=d`; else if (navAppDrive === 'waze') url = `https://www.waze.com/ul?ll=${lat},${lon}&navigate=yes`; else url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`; window.open(url, '_blank'); };
            const handleWalk = (e) => { e.preventDefault(); e.stopPropagation(); let url = ''; const {lat, lon} = loc; if (navAppWalk === 'apple') url = `http://maps.apple.com/?daddr=${lat},${lon}&dirflg=w`; else url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=walking`; window.open(url, '_blank'); };
            useEffect(() => { if (ADDRESS_CACHE[loc.id]) { setAddress(ADDRESS_CACHE[loc.id]); return; } const fetchAddr = async () => { try { const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${loc.lat}&lon=${loc.lon}&zoom=18&addressdetails=1`); const data = await res.json(); const formatted = formatAddressFromData(data); setAddress(formatted || "Address unavailable"); ADDRESS_CACHE[loc.id] = formatted || "Address unavailable"; } catch (e) { setAddress("Address unavailable"); } }; fetchAddr(); }, [loc]);
            useEffect(() => { setImageUrl(null); const fetchImage = async () => { if (loc.tags.image) { setImageUrl(loc.tags.image); return; } if (loc.tags.wikidata) { try { const res = await fetch(`https://www.wikidata.org/w/api.php?action=wbgetclaims&property=P18&entity=${loc.tags.wikidata}&format=json&origin=*`); const data = await res.json(); const claims = data.claims.P18; if (claims && claims.length) setImageUrl(`https://commons.wikimedia.org/wiki/Special:FilePath/${encodeURIComponent(claims[0].mainsnak.datavalue.value)}?width=600`); } catch (e) {} } }; fetchImage(); }, [loc]);
            const distObj = userLoc ? calculateDistance(userLoc[0], userLoc[1], loc.lat, loc.lon) : null;
            const isPaid = loc.tags.fee === 'yes' || (loc.tags.fee && loc.tags.fee !== 'no');
            let headerBg = loc.displayType === 'water' ? 'bg-teal-50 text-teal-700 dark:bg-teal-900/50 dark:text-teal-200' : loc.displayType === 'baby' ? 'bg-rose-50 text-rose-700 dark:bg-rose-900/50 dark:text-rose-200' : loc.displayType === 'shower' ? 'bg-sky-50 text-sky-700 dark:bg-sky-900/50 dark:text-sky-200' : 'bg-slate-100 text-slate-600 dark:bg-zinc-800 dark:text-zinc-300';
            const contentClass = `transition-opacity duration-300 ${minimized ? 'opacity-0 pointer-events-none' : 'opacity-100 delay-100'}`;
            
            const openStatus = checkOpeningStatus(loc.tags.opening_hours);

            // FIX: Disable slide-up animation if card is minimized on mount
            const animClass = isClosing ? 'animate-slide-down-card' : (minimized ? '' : (animationFinished ? '' : 'animate-slide-up-card'));

            // Show status buttons for van-specific types: Black/Grey disposal, Water, Showers
            const isVanFacility = loc.isBlack || loc.isGrey || loc.isWater || loc.hasShower;

            return html`
                <div onClick=${handleContainerClick} style=${{ transform: minimized ? 'translateY(calc(100% - 160px))' : 'translateY(0)' }} 
                    class=${`fixed bottom-0 left-0 right-0 bg-white dark:bg-zinc-900 rounded-t-3xl shadow-2xl z-[1500] flex flex-col max-h-[85vh] safe-pb transition-transform duration-300 ease-in-out ${animClass} ${minimized ? 'cursor-pointer' : ''}`}>
                    <div class="w-full flex justify-center pt-3 pb-1" onClick=${(e) => { e.stopPropagation(); if (!minimized) handleClose(); else setMinimized(false); }}><div class="w-12 h-1.5 bg-slate-200 dark:bg-zinc-700 rounded-full"></div></div>
                    ${imageUrl ? html`<div class="w-full h-48 bg-slate-100 dark:bg-zinc-800 relative overflow-hidden shrink-0"><img src=${imageUrl} class="w-full h-full object-cover"/><div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div><button onClick=${(e) => { e.stopPropagation(); handleClose(); }} class="absolute top-4 right-4 p-2 bg-black/30 backdrop-blur rounded-full text-white"><div class="w-5 h-5 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.x}}></div></button></div>` : html`<div class="absolute top-2 right-4 z-10"><button onClick=${(e) => { e.stopPropagation(); handleClose(); }} class="p-2 bg-slate-50 dark:bg-zinc-800 rounded-full text-slate-400 hover:bg-slate-100 dark:hover:bg-zinc-700"><div class="w-5 h-5 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.x}}></div></button></div>`}
                    <div class="p-6 pt-2 overflow-y-auto">
                        <div class="mb-4">
                            <div class="flex space-x-2 mb-2">
                                <div class=${'inline-flex items-center px-2.5 py-1 rounded-full text-[10px] uppercase font-bold tracking-wide ' + headerBg}>${loc.displayType.toUpperCase()}</div>
                                ${distObj && html`<div class="inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-bold tracking-wide bg-slate-100 text-slate-500 dark:bg-zinc-800 dark:text-zinc-400">${distObj.text} AWAY</div>`}
                                ${openStatus && openStatus.color && html`<div class=${`inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-bold tracking-wide ${openStatus.color}`}><span class="w-1.5 h-1.5 rounded-full bg-current mr-1.5 animate-pulse"></span>${openStatus.text}</div>`}
                            </div>
                            <h2 class="text-2xl font-brand font-semibold text-slate-800 dark:text-zinc-100 leading-tight">${loc.name}</h2>
                            ${statusData && statusData.status === 'working' && isVanFacility && html`
                                <div class="flex items-center gap-1 mt-1 text-emerald-600 dark:text-emerald-400 text-xs font-bold">
                                    <span class="material-symbols-rounded text-sm">verified</span>
                                    <span>Verified working ${formatTimeAgo(statusData.last_verified)}</span>
                                </div>
                            `}
                            ${statusData && statusData.status === 'broken' && isVanFacility && html`
                                <div class="flex items-center gap-1 mt-1 text-rose-500 dark:text-rose-400 text-xs font-bold">
                                    <span class="material-symbols-rounded text-sm">warning</span>
                                    <span>Reported broken ${formatTimeAgo(statusData.last_verified)}</span>
                                </div>
                            `}
                        </div>
                        <div class="mb-5">
                            <div class="flex items-start space-x-2 text-slate-500 dark:text-zinc-400"><div class="w-4 h-4 mt-0.5 shrink-0 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.pin}}></div><p class="text-sm font-medium leading-tight">${address}</p></div>
                        </div>
                        <div class=${contentClass}>
                            ${loc.tags && loc.tags.opening_hours && html`
                                <div class="mb-5 mt-1 bg-slate-50 dark:bg-zinc-800/50 rounded-xl p-3 flex items-start gap-3 border border-slate-100 dark:border-zinc-800">
                                    <div class=${`w-5 h-5 rounded-full flex items-center justify-center shrink-0 ${openStatus && openStatus.color ? openStatus.color.replace('text-', 'bg-').split(' ')[0] + '/20 ' + openStatus.color.split(' ')[0] : 'text-slate-400 bg-slate-200'}`}>
                                        <span class="material-symbols-rounded text-[14px]">schedule</span>
                                    </div>
                                    <div class="flex-1">
                                        ${openStatus && openStatus.color && html`<div class=${`text-xs font-bold mb-0.5 ${openStatus.color.split(' ')[0]}`}>${openStatus.text}</div>`}
                                        <div class="text-xs text-slate-500 dark:text-zinc-400 leading-relaxed whitespace-pre-line">${String(loc.tags.opening_hours).replace(/;/g, '\n')}</div>
                                    </div>
                                </div>
                            `}
                            <div class="flex flex-wrap gap-2 mb-6">
                                <div class=${'px-3 py-1.5 rounded-lg text-sm font-semibold flex items-center gap-1 ' + (isPaid ? 'bg-orange-50 text-orange-700 border border-orange-100 dark:bg-orange-900/30 dark:text-orange-200 dark:border-orange-900/50' : 'bg-emerald-50 text-emerald-700 border border-emerald-100 dark:bg-emerald-900/30 dark:text-emerald-200 dark:border-emerald-900/50')}>${isPaid ? 'Pay to use' : 'Free entry'}</div>
                                ${loc.isToilet && html`<div class="px-3 py-1.5 rounded-lg text-sm font-semibold bg-slate-100 text-slate-700 border border-slate-200 dark:bg-zinc-800 dark:text-zinc-300 dark:border-zinc-700 flex items-center gap-1"><span class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.toilet}}></span> Toilet</div>`}
                                ${loc.isWater && html`<div class="px-3 py-1.5 rounded-lg text-sm font-semibold bg-teal-50 text-teal-700 border border-teal-100 dark:bg-teal-900/30 dark:text-teal-200 dark:border-teal-900/50 flex items-center gap-1"><span class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.water}}></span> Water</div>`}
                                ${loc.hasBaby && html`<div class="px-3 py-1.5 rounded-lg text-sm font-semibold bg-rose-50 text-rose-700 border border-rose-100 dark:bg-rose-900/30 dark:text-rose-200 dark:border-rose-900/50 flex items-center gap-1"><span class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.baby}}></span> Baby Change</div>`}
                                ${loc.hasShower && html`<div class="px-3 py-1.5 rounded-lg text-sm font-semibold bg-sky-50 text-sky-700 border border-sky-100 dark:bg-sky-900/30 dark:text-sky-200 dark:border-sky-900/50 flex items-center gap-1"><span class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.shower}}></span> Shower</div>`}
                            </div>
                            
                            ${isVanFacility && html`
                                <div class="flex gap-2 mb-4">
                                    <button onClick=${() => onReportStatus(loc.id, 'working')} class="flex-1 py-3 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-300 rounded-xl text-xs font-bold border border-emerald-100 dark:border-emerald-800 active:scale-95 transition-transform flex items-center justify-center gap-2 shadow-sm"><span class="material-symbols-rounded text-sm">check_circle</span> Working</button>
                                    <button onClick=${() => onReportStatus(loc.id, 'broken')} class="flex-1 py-3 bg-rose-50 dark:bg-rose-900/20 text-rose-700 dark:text-rose-300 rounded-xl text-xs font-bold border border-rose-100 dark:border-rose-800 active:scale-95 transition-transform flex items-center justify-center gap-2 shadow-sm"><span class="material-symbols-rounded text-sm">cancel</span> Broken</button>
                                </div>
                            `}

                            <div class="space-y-3 mb-2">
                                <div class="flex gap-2">
                                    <button onClick=${handleDrive} class="flex-1 bg-slate-800 text-white dark:bg-zinc-700 font-semibold font-brand text-lg py-4 rounded-2xl flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform"><div class="w-6 h-6 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.car}}></div><span>Drive</span></button>
                                    <button onClick=${handleWalk} class="flex-1 bg-emerald-600 text-white dark:bg-emerald-700 font-semibold font-brand text-lg py-4 rounded-2xl flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform"><div class="w-6 h-6 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.walk}}></div><span>Walk</span></button>
                                </div>
                                <div class="flex gap-2">
                                    <a href=${`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${loc.lat},${loc.lon}`} target="_blank" class="flex-[3] bg-white text-slate-700 dark:bg-zinc-800 dark:text-zinc-300 font-semibold font-brand text-lg py-4 rounded-2xl flex items-center justify-center gap-2 shadow-sm active:scale-95 transition-transform border border-slate-200 dark:border-zinc-700"><div class="w-6 h-6 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.eye}}></div><span>Street Preview</span></a>
                                    <button onClick=${handleShare} class="flex-1 bg-slate-100 text-slate-600 dark:bg-zinc-700 dark:text-zinc-300 font-semibold font-brand text-lg py-4 rounded-2xl flex items-center justify-center gap-2 shadow-sm active:scale-95 transition-transform border border-slate-200 dark:border-zinc-600"><div class="w-6 h-6 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.share}}></div></button>
                                </div>
                            </div>
                            <div class="flex justify-center mt-4">
                                <button onClick=${(e) => { e.stopPropagation(); onReport(loc); }} class="text-xs text-slate-400 dark:text-zinc-500 font-medium hover:text-rose-500 dark:hover:text-rose-400 transition-colors">Something wrong?</button>
                            </div>
                        </div>
                    </div>
                </div>`;
        };

        const FilterBtn = ({ type, label, active, onClick, color = 'slate' }) => {
            const colors = { slate: 'bg-slate-800 dark:bg-zinc-600 border-slate-800 dark:border-zinc-600', teal: 'bg-teal-500 dark:bg-teal-600 border-teal-500 dark:border-teal-600', rose: 'bg-rose-400 dark:bg-rose-500 border-rose-400 dark:border-rose-500', black: 'bg-slate-800 dark:bg-zinc-700 border-slate-800 dark:border-zinc-700', grey: 'bg-slate-400 dark:bg-zinc-500 border-slate-400 dark:border-zinc-500', sky: 'bg-sky-500 dark:bg-sky-600 border-sky-500 dark:border-sky-600' };
            const baseClass = "flex items-center space-x-2 px-4 py-3 rounded-full text-xs font-bold shrink-0 transition-all duration-200 ease-out active:scale-90 border transform-gpu cursor-pointer select-none touch-manipulation";
            const inactiveClass = "bg-slate-50 dark:bg-zinc-800 text-slate-700 dark:text-zinc-300 border-slate-200 dark:border-zinc-700 shadow-sm hover:border-slate-300 dark:hover:border-zinc-600";
            const activeClass = `${colors[color]} text-white shadow-md`;
            return html`
                <div onClick=${onClick} onTouchStart=${() => {}} class=${`${baseClass} ${active ? activeClass : inactiveClass}`}>
                    <div class="flex items-center justify-center w-5 h-5" dangerouslySetInnerHTML=${{__html: ICONS[type]}}></div><span>${label}</span>
                </div>`;
        };

        const ListItem = ({ loc, onClick, userPos, index, isExiting, statusData }) => {
            let iconHtml = loc.displayType === 'black' ? ICONS.trash : loc.displayType === 'grey' ? ICONS.drop : ICONS[loc.displayType] || ICONS.toilet;
            const types = [];
            if (loc.isToilet) types.push('toilet'); if (loc.isWater) types.push('water'); if (loc.hasBaby) types.push('baby'); if (loc.hasShower) types.push('shower'); if (loc.isBlack) types.push('black'); if (loc.isGrey) types.push('grey'); if (types.length === 0) types.push('toilet');
            let backgroundStyle = '';
            if (types.length === 1) { backgroundStyle = `background-color: ${TYPE_COLORS[types[0]]};`; } else { const segmentSize = 100 / types.length; const gradientParts = types.map((t, i) => { const color = TYPE_COLORS[t]; const start = i * segmentSize; const end = (i + 1) * segmentSize; return `${color} ${start}% ${end}%`; }); backgroundStyle = `background: conic-gradient(${gradientParts.join(', ')});`; }
            
            const [fetchedAddr, setFetchedAddr] = useState(ADDRESS_CACHE[loc.id] || null);
            
            useEffect(() => {
                if (fetchedAddr || loc.rawAddress) return; 
                if (ADDRESS_CACHE[loc.id]) { setFetchedAddr(ADDRESS_CACHE[loc.id]); return; }

                const delay = index * 1200; 
                const timer = setTimeout(async () => {
                    try {
                        if (ADDRESS_CACHE[loc.id]) { setFetchedAddr(ADDRESS_CACHE[loc.id]); return; }
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${loc.lat}&lon=${loc.lon}&zoom=18&addressdetails=1`);
                        if (!res.ok) return;
                        const data = await res.json();
                        const formatted = formatAddressFromData(data);
                        const finalAddr = formatted || "Address unavailable";
                        setFetchedAddr(finalAddr);
                        saveToAddrCache(loc.id, finalAddr); 
                    } catch (e) { }
                }, delay);

                return () => clearTimeout(timer);
            }, [loc, index, fetchedAddr]);

            const displayAddress = fetchedAddr || loc.rawAddress;
            const openStatus = checkOpeningStatus(loc.tags.opening_hours);
            return html`
                <div onClick=${() => { triggerHaptic(); onClick(); }} class=${`bg-white dark:bg-zinc-900 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-zinc-800 flex items-center justify-between mb-3 active:scale-[0.98] transition-transform ${isExiting ? 'animate-stagger-fade-out pointer-events-none' : 'animate-stagger-fade opacity-0'}`} style=${{ animationDelay: isExiting ? `${index * 30}ms` : `${index * 50}ms` }}>
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white shrink-0 shadow-sm pie-icon relative" style=${{ cssText: backgroundStyle }}>
                            <div dangerouslySetInnerHTML=${{__html: iconHtml}}></div>
                            ${openStatus && openStatus.color && html`<div class=${`absolute -bottom-1 -right-1 w-3.5 h-3.5 rounded-full border-2 border-white dark:border-zinc-900 ${openStatus.color.split(' ')[0].replace('text-', 'bg-')}`}></div>`}
                        </div>
                        <div class="flex flex-col overflow-hidden min-w-0">
                            <div class="flex items-center gap-1">
                                <h4 class="font-semibold text-slate-700 dark:text-zinc-200 font-brand text-base leading-tight truncate">${loc.name}</h4>
                                ${statusData && statusData.status === 'working' && html`<span class="material-symbols-rounded text-emerald-500 text-sm">verified</span>`}
                            </div>
                            ${displayAddress ? html`<p class="text-xs text-slate-400 dark:text-zinc-500 truncate mt-0.5">${displayAddress}</p>` : html`<div class="h-3 w-24 bg-slate-100 dark:bg-zinc-800 rounded animate-pulse mt-1"></div>`}
                        </div>
                    </div>
                    <span class="text-[10px] font-bold bg-slate-100 text-slate-500 dark:bg-zinc-800 dark:text-zinc-400 px-2 py-0.5 rounded-full ml-2 shrink-0">${calculateDistance(userPos[0], userPos[1], loc.lat, loc.lon).text}</span>
                </div>`;
        }

        function App() {
            const [view, setView] = useState('map');
            const [isListExiting, setIsListExiting] = useState(false);
            const [allLocations, setAllLocations] = useState([]);
            const [selectedLoc, setSelectedLoc] = useState(null);
            const [cardMinimized, setCardMinimized] = useState(false);
            const [loading, setLoading] = useState(false);
            const [toast, setToast] = useState({ msg: '', visible: false });
            const [zoomWarning, setZoomWarning] = useState(false);
            const [showFilters, setShowFilters] = useState(false);
            const [isCamperMode, setIsCamperMode] = useState(localStorage.getItem('loocator_van_mode') === 'true');
            const [showCamperDisclaimer, setShowCamperDisclaimer] = useState(false);
            const [statuses, setStatuses] = useState({});
            
            const [stdFilters, setStdFilters] = useState(() => safeParse('loocator_std_filters', { toilet: true, water: true, baby: true }));
            const [vanFilters, setVanFilters] = useState(() => safeParse('loocator_van_filters', { black: true, grey: true, water: true, shower: true }));
            const [freeOnly, setFreeOnly] = useState(localStorage.getItem('loocator_filter_free') === 'true');
            const [bottleOnly, setBottleOnly] = useState(localStorage.getItem('loocator_filter_bottle') === 'true');
            const [accessOnly, setAccessOnly] = useState(localStorage.getItem('loocator_filter_access') === 'true');
            const [keyOnly, setKeyOnly] = useState(localStorage.getItem('loocator_filter_key') === 'true');

            useEffect(() => localStorage.setItem('loocator_van_mode', isCamperMode), [isCamperMode]);
            useEffect(() => localStorage.setItem('loocator_std_filters', JSON.stringify(stdFilters)), [stdFilters]);
            useEffect(() => localStorage.setItem('loocator_van_filters', JSON.stringify(vanFilters)), [vanFilters]);
            useEffect(() => localStorage.setItem('loocator_filter_free', freeOnly), [freeOnly]);
            useEffect(() => localStorage.setItem('loocator_filter_bottle', bottleOnly), [bottleOnly]);
            useEffect(() => localStorage.setItem('loocator_filter_access', accessOnly), [accessOnly]);
            useEffect(() => localStorage.setItem('loocator_filter_key', keyOnly), [keyOnly]);

            const [navAppDrive, setNavAppDriveState] = useState('google');
            const [navAppWalk, setNavAppWalkState] = useState('google');
            const [searchTerm, setSearchTerm] = useState('');
            const [mapCenter, setMapCenter] = useState([51.505, -0.09]); 
            const [userPos, setUserPos] = useState([51.505, -0.09]); 
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [searchBounds, setSearchBounds] = useState(null); 
            const [isInstalled, setIsInstalled] = useState(false);
            const [showAbout, setShowAbout] = useState(false);
            const [searchHistory, setSearchHistory] = useState([]);
            const [showHistory, setShowHistory] = useState(false);
            const [apiSuggestions, setApiSuggestions] = useState([]);
            const [historyMatches, setHistoryMatches] = useState([]);
            const [showContribute, setShowContribute] = useState(false);
            const [isPickingLocation, setIsPickingLocation] = useState(false);
            const [contributeCoords, setContributeCoords] = useState(null);
            const [showCorrection, setShowCorrection] = useState(false);
            const [correctionData, setCorrectionData] = useState(null);
            const [showInstallButton, setShowInstallButton] = useState(false);
            const [gpsStatus, setGpsStatus] = useState('idle');
            const [isDarkMode, setIsDarkMode] = useState(window.matchMedia('(prefers-color-scheme: dark)').matches);
            const routeLayerRef = useRef(null); 

            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef(null);
            const userMarkerRef = useRef(null);
            const tileLayerRef = useRef(null);
            const camperModeRef = useRef(isCamperMode);
            const fetchController = useRef(null);
            const filterSheetRef = useRef(null);
            const selectedLocRef = useRef(null); 
            const cardMinimizedRef = useRef(false);

            const params = new URLSearchParams(window.location.search);
            const sharedLat = params.get('lat');
            const sharedLon = params.get('lon');
            const sharedId = params.get('id');
            const [targetId, setTargetId] = useState(sharedId);

            // Fetch Statuses logic
            const fetchStatuses = async () => {
                if(!supabaseClient) return; // Silent fail if offline
                try {
                    const { data } = await supabaseClient.from('amenity_status').select('*');
                    const statusMap = {};
                    if(data) data.forEach(s => { statusMap[s.id] = s; });
                    setStatuses(statusMap);
                } catch(e) { console.warn("Fetch failed"); }
            };

            useEffect(() => {
                if(!supabaseClient) return;
                fetchStatuses();
                const channel = supabaseClient.channel('status_updates')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'amenity_status' }, (payload) => {
                        setStatuses(prev => ({ ...prev, [payload.new.id]: payload.new }));
                    })
                    .subscribe();
                return () => supabaseClient.removeChannel(channel);
            }, []);

            const reportStatus = async (osmId, newStatus) => {
                triggerHaptic();
                if (!supabaseClient) {
                    showToast("Offline mode: status not saved.");
                    return;
                }
                const { error } = await supabaseClient.from('amenity_status').upsert({ 
                    id: String(osmId), 
                    status: newStatus, 
                    last_verified: new Date().toISOString() 
                });
                if (!error) {
                    showToast(newStatus === 'working' ? "Verified working!" : "Reported as broken");
                    // Optimistic UI update
                    setStatuses(prev => ({ 
                        ...prev, 
                        [osmId]: { id: String(osmId), status: newStatus, last_verified: new Date().toISOString() } 
                    }));
                } else {
                    console.error("Supabase Error:", error);
                    showToast("Error saving status.");
                }
            };

            // --- BREADCRUMB LOGIC (Aggressive OSRM) ---
            useEffect(() => {
                if (!mapInstanceRef.current || !selectedLoc || !userPos) {
                    if (routeLayerRef.current) {
                        mapInstanceRef.current.removeLayer(routeLayerRef.current);
                        routeLayerRef.current = null;
                    }
                    return;
                }

                const dist = calculateDistance(userPos[0], userPos[1], selectedLoc.lat, selectedLoc.lon);
                
                // 1. Sanity Check: Don't route if > 5km (waste of bandwidth)
                if (dist.km > 5) {
                    if (routeLayerRef.current) {
                        mapInstanceRef.current.removeLayer(routeLayerRef.current);
                        routeLayerRef.current = null;
                    }
                    return;
                }

                // 2. Aggressive API Call
                const url = `https://router.project-osrm.org/route/v1/foot/${userPos[1]},${userPos[0]};${selectedLoc.lon},${selectedLoc.lat}?overview=full&geometries=geojson&alternatives=true&continue_straight=false`;

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        let bestRoute = null;

                        if (data.routes && data.routes.length > 0) {
                            // 3. AGGRESSIVE SORTING:
                            bestRoute = data.routes.sort((a, b) => a.distance - b.distance)[0];
                        }

                        // Fallback
                        const coords = bestRoute 
                            ? bestRoute.geometry.coordinates.map(c => [c[1], c[0]]) 
                            : [[userPos[0], userPos[1]], [selectedLoc.lat, selectedLoc.lon]];

                        if (routeLayerRef.current) {
                            mapInstanceRef.current.removeLayer(routeLayerRef.current);
                        }

                        routeLayerRef.current = L.polyline(coords, {
                            className: 'marching-ants', // Uses your CSS animation
                            interactive: false,
                            opacity: 0.8,
                            weight: 5
                        }).addTo(mapInstanceRef.current);
                    })
                    .catch(err => {
                        // Fallback on error (e.g. server busy): Draw straight line
                        const coords = [[userPos[0], userPos[1]], [selectedLoc.lat, selectedLoc.lon]];
                        if (routeLayerRef.current) mapInstanceRef.current.removeLayer(routeLayerRef.current);
                        routeLayerRef.current = L.polyline(coords, { className: 'marching-ants', interactive: false }).addTo(mapInstanceRef.current);
                    });

            }, [selectedLoc, userPos]); 

            useEffect(() => { selectedLocRef.current = selectedLoc; }, [selectedLoc]);
            useEffect(() => { cardMinimizedRef.current = cardMinimized; }, [cardMinimized]);

            useEffect(() => {
                try {
                    const savedHistory = localStorage.getItem('loocator_history');
                    if (savedHistory) setSearchHistory(JSON.parse(savedHistory));
                    const savedNavDrive = localStorage.getItem('loocator_nav_drive');
                    if (savedNavDrive) setNavAppDriveState(savedNavDrive);
                    const savedNavWalk = localStorage.getItem('loocator_nav_walk');
                    if (savedNavWalk) setNavAppWalkState(savedNavWalk);
                } catch(e) {}
            }, []);
            
            const setNavAppDrive = (app) => { setNavAppDriveState(app); localStorage.setItem('loocator_nav_drive', app); };
            const setNavAppWalk = (app) => { setNavAppWalkState(app); localStorage.setItem('loocator_nav_walk', app); };
            const clearHistory = () => { setSearchHistory([]); localStorage.removeItem('loocator_history'); showToast("History cleared"); };
            const fuse = useMemo(() => new Fuse(searchHistory, { threshold: 0.4, distance: 100 }), [searchHistory]);
            const addToHistory = (term) => { if (!term) return; const newHist = [term, ...searchHistory.filter(h => h.toLowerCase() !== term.toLowerCase())].slice(0, 5); setSearchHistory(newHist); localStorage.setItem('loocator_history', JSON.stringify(newHist)); };
            const fetchSuggestions = useMemo(() => debounce(async (term) => { if (!term || term.length < 3) { setApiSuggestions([]); return; } try { const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(term)}&addressdetails=1&limit=5`); if (res.ok) { const data = await res.json(); setApiSuggestions(data); } } catch (e) { console.error(e); } }, 500), []);
            const handleInput = (e) => { const val = e.target.value; setSearchTerm(val); setShowHistory(true); if (val && fuse) { const results = fuse.search(val); setHistoryMatches(results.map(r => r.item)); } else { setHistoryMatches([]); } fetchSuggestions(val); };
            useEffect(() => { const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)'); const handleChange = (e) => setIsDarkMode(e.matches); mediaQuery.addEventListener('change', handleChange); return () => mediaQuery.removeEventListener('change', handleChange); }, []);
            useEffect(() => { if (view === 'map' && mapInstanceRef.current) setTimeout(() => mapInstanceRef.current.invalidateSize(), 100); }, [view]);
            
            useEffect(() => { 
                camperModeRef.current = isCamperMode; 
                localStorage.setItem('loocator_van_mode', isCamperMode);

                setSelectedLoc(null);
                setCardMinimized(false);

                if (mapInstanceRef.current) { 
                    setLoading(true); 
                    debouncedFetch(mapInstanceRef.current.getBounds()); 
                } 
            }, [isCamperMode]);
            
            useEffect(() => { 
                if (!mapInstanceRef.current) return; 
                if (tileLayerRef.current) { mapInstanceRef.current.removeLayer(tileLayerRef.current); } 
                const tileUrl = isDarkMode ? 'https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png'; 
                tileLayerRef.current = L.tileLayer(tileUrl, { attribution: '', subdomains: 'abcd', maxZoom: 20 }).addTo(mapInstanceRef.current); 
            }, [isDarkMode]);

            const showToast = (msg) => { setToast({ msg, visible: true }); setTimeout(() => setToast(prev => ({ ...prev, visible: false })), 3000); };
            
            const closeAllMenus = () => {
                setShowFilters(false);
                setShowAbout(false);
                setShowContribute(false);
                setShowCorrection(false);
                setSelectedLoc(null);
                setCardMinimized(false);
            };

            const toggleMode = () => {
                if (isCamperMode) {
                    setIsCamperMode(false);
                } else {
                    // Trigger the disclaimer modal instead of switching immediately
                    setShowCamperDisclaimer(true);
                }
            };
            
            const confirmCamperMode = () => {
                setIsCamperMode(true);
                setShowCamperDisclaimer(false);
            };

            const handleFilterClick = () => { if (showFilters) { if (filterSheetRef.current) { filterSheetRef.current.triggerClose(); } } else { closeAllMenus(); setShowFilters(true); } };
            const handleAboutClick = () => { if (showAbout) { setShowAbout(false); } else { closeAllMenus(); setShowAbout(true); } };
            const handleViewToggle = () => { if (view === 'list') { setIsListExiting(true); setTimeout(() => { setIsListExiting(false); setView('map'); }, 300); } else { closeAllMenus(); setView('list'); } };
            const handleViewChange = () => { closeAllMenus(); setView('list'); }

            const visibleLocations = useMemo(() => { return allLocations.filter(loc => { if (freeOnly && (loc.tags.fee === 'yes' || (loc.tags.fee && loc.tags.fee !== 'no'))) return false; if (bottleOnly && loc.isWater && !loc.isToilet && !loc.hasBaby) { if (loc.tags.amenity !== 'drinking_water' && loc.tags.bottle !== 'yes') return false; } if (accessOnly) { const w = loc.tags.wheelchair; if (w !== 'yes' && w !== 'limited' && w !== 'designated') return false; } if (keyOnly) { const radar = loc.tags.radar_key; const central = loc.tags.centralkey; if (radar !== 'yes' && !central) return false; } return isCamperMode ? (vanFilters.black && loc.isBlack) || (vanFilters.grey && loc.isGrey) || (vanFilters.water && loc.isWater) || (vanFilters.shower && loc.hasShower) : (stdFilters.toilet && loc.isToilet) || (stdFilters.water && loc.isWater) || (stdFilters.baby && loc.hasBaby); }).map(loc => { let displayType = loc.baseType; if (isCamperMode) { if (vanFilters.black && loc.isBlack) displayType = 'black'; else if (vanFilters.grey && loc.isGrey) displayType = 'grey'; else if (vanFilters.shower && loc.hasShower) displayType = 'shower'; else if (vanFilters.water && loc.isWater) displayType = 'water'; } else if (stdFilters.baby && loc.hasBaby && !stdFilters.toilet) displayType = 'baby'; return { ...loc, displayType }; }).sort((a, b) => calculateDistance(userPos[0], userPos[1], a.lat, a.lon).km - calculateDistance(userPos[0], userPos[1], b.lat, b.lon).km); }, [allLocations, isCamperMode, stdFilters, vanFilters, userPos, freeOnly, bottleOnly, accessOnly, keyOnly]);
            const [inAreaLocs, furtherLocs] = useMemo(() => { if (!searchBounds) return [visibleLocations, []]; const inArea = []; const further = []; visibleLocations.forEach(loc => { if (searchBounds.contains([loc.lat, loc.lon])) { inArea.push(loc); } else { further.push(loc); } }); return [inArea, further]; }, [visibleLocations, searchBounds]);
            const showListHint = !loading && view === 'map' && visibleLocations.length > 0 && inAreaLocs.length === 0;

            const fetchOverpass = async (bounds, retryRadius = null) => { if (fetchController.current) { fetchController.current.abort(); } 
                const isVan = camperModeRef.current;
                const cacheKey = getMapCacheKey(bounds, isVan);
                
                if (MAP_CACHE[cacheKey] && !retryRadius) {
                    setAllLocations(MAP_CACHE[cacheKey].data);
                    setLoading(false);
                    return;
                }
                fetchController.current = new AbortController(); const signal = fetchController.current.signal; const center = bounds.getCenter(); 
                let radius; 
                if (retryRadius) { 
                    radius = retryRadius; 
                } else { 
                    const ne = bounds.getNorthEast(); 
                    const dist = calculateDistance(center.lat, center.lng, ne.lat, ne.lng); 
                    // Base radius: standard 2km, van 15km
                    radius = Math.max(dist.km * 1500, isVan ? 15000 : 2000); 
                } 
                const queryArea = `(around:${radius},${center.lat},${center.lng})`; 
                
                // Construct optimized query based on mode to allow larger scan area without timeout
                let queryBody = '';
                if (isVan) {
                    // Van mode: Search only dump stations, water, showers. Skip generic toilets to save load.
                    queryBody = `(nwr["amenity"="sanitary_dump_station"]${queryArea};nwr["amenity"="water_point"]${queryArea};nwr["amenity"="drinking_water"]${queryArea};nwr["amenity"="shower"]${queryArea};);`;
                } else {
                    // Standard mode: Search toilets, baby change, showers, water.
                    queryBody = `(nwr["amenity"="toilets"]["access"!~"customers|private|no|employees|permit"]${queryArea};nwr["amenity"="drinking_water"]${queryArea};nwr["amenity"="water_point"]${queryArea};nwr["amenity"="shower"]${queryArea};nwr["diaper"]${queryArea};nwr["changing_table"]${queryArea};);`;
                }

                const query = `[out:json][timeout:25];${queryBody}out center;`; 
                
                try { 
                    const res = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: 'data=' + encodeURIComponent(query), signal: signal }); 
                    const data = await res.json(); 
                    if (data.elements.length === 0) { 
                        const nextRadius = radius * 2; 
                        // Increase max scan range for Van Mode (up to 150km), keep standard at 50km
                        const maxRange = isVan ? 150000 : 50000;
                        if (nextRadius <= maxRange) { 
                            showToast(`Scanning ${Math.round(nextRadius/1000)}km...`); 
                            fetchOverpass(bounds, nextRadius); 
                            return; 
                        } 
                        setLoading(false); 
                        return; 
                    } 
                    const mapped = data.elements.map(el => { const lat = el.lat || (el.center && el.center.lat); const lon = el.lon || (el.center && el.center.lon); if (!lat || !lon) return null; let baseName = "Service Point"; if (el.tags.amenity === 'toilets') baseName = "Public Toilet"; else if (el.tags.amenity === 'drinking_water' || el.tags.amenity === 'water_point') baseName = "Water Point"; else if (el.tags.amenity === 'shower') baseName = "Public Shower"; else if (el.tags.amenity === 'sanitary_dump_station') baseName = "Chemical Disposal"; else if (el.tags.diaper === 'yes') baseName = "Baby Change"; const street = el.tags['addr:street'] || el.tags['addr:place']; const city = el.tags['addr:city'] || el.tags['addr:town'] || el.tags['addr:village']; const house = el.tags['addr:housenumber']; let rawAddress = ''; if (house) rawAddress += house + ' '; if (street) rawAddress += street; if (city) rawAddress += (rawAddress ? ', ' : '') + city; let finalName = el.tags.name; if (!finalName) { const operator = el.tags.operator; if (street) { finalName = `${street} ${baseName}`; } else if (operator) { finalName = `${operator} ${baseName}`; } else if (el.tags.ref) { finalName = `${baseName} (${el.tags.ref})`; } else if (el.tags.fee) { const feeText = el.tags.fee === 'no' ? 'Free' : 'Paid'; finalName = `${feeText} ${baseName}`; } else if (el.tags.description) { const descWords = el.tags.description.split(' '); if (descWords.length > 0) { finalName = descWords.slice(0, 4).join(' ') + (descWords.length > 4 ? '...' : ''); } else { finalName = baseName; } } else { finalName = baseName; } } return { id: el.id, lat: lat, lon: lon, tags: el.tags, isToilet: el.tags.amenity === 'toilets' || el.tags.toilets === 'yes', isWater: el.tags.amenity === 'drinking_water' || el.tags.amenity === 'water_point' || el.tags.drinking_water === 'yes', hasBaby: el.tags.diaper === 'yes' || el.tags.changing_table === 'yes', hasShower: el.tags.amenity === 'shower' || el.tags.shower === 'yes', isBlack: (el.tags.amenity === 'sanitary_dump_station' && el.tags['sanitary_dump_station:chemical_toilet'] !== 'no') || (el.tags.amenity === 'toilets' && el.tags.sanitary_dump_station === 'yes'), isGrey: el.tags.amenity === 'sanitary_dump_station' && el.tags['sanitary_dump_station:grey_water'] !== 'no', baseType: el.tags.amenity === 'sanitary_dump_station' ? 'dump' : el.tags.amenity === 'shower' ? 'shower' : el.tags.amenity === 'drinking_water' ? 'water' : 'toilet', name: finalName, rawAddress: rawAddress }; }).filter(Boolean);
                    setAllLocations(mapped); saveToMapCache(bounds, mapped, isVan); setLoading(false); } catch (e) { if (e.name !== 'AbortError') { setLoading(false); } } };
            const debouncedFetch = useMemo(() => debounce((b) => fetchOverpass(b), 1000), []);
            const updateUserLocation = (coords, source) => { setUserPos(coords); setMapCenter(coords); setGpsStatus('success'); setTimeout(() => setGpsStatus('idle'), 2500); if (source === 'GPS') { setAllLocations([]); } if (mapInstanceRef.current) { const zoom = source === 'GPS' ? 17 : 13; mapInstanceRef.current.setView(coords, zoom); if (!userMarkerRef.current) { userMarkerRef.current = L.marker(coords, { icon: L.divIcon({ className: '', html: '<div class="user-pin-ring"></div><div class="user-pin-dot"></div><div class="user-beam" id="user-heading-beam"></div>', iconSize: [20, 20] }) }).addTo(mapInstanceRef.current); } else { userMarkerRef.current.setLatLng(coords); } setSearchBounds(mapInstanceRef.current.getBounds()); debouncedFetch(mapInstanceRef.current.getBounds()); } };
            
            // INSTALL PROMPT LOGIC
            useEffect(() => { 
                const handler = (e) => { e.preventDefault(); setDeferredPrompt(e); setShowInstallButton(true); }; 
                window.addEventListener('beforeinstallprompt', handler); 
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
                if (isIOS && !isStandalone) { setShowInstallButton(true); }
                window.addEventListener('appinstalled', () => { setShowInstallButton(false); setIsInstalled(true); }); 
                return () => { window.removeEventListener('beforeinstallprompt', handler); window.removeEventListener('appinstalled', () => setIsInstalled(true)); } 
            }, []);

            const handleInstall = () => { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then((choiceResult) => { if (choiceResult.outcome === 'accepted') { setDeferredPrompt(null); setShowInstallButton(false); setIsInstalled(true); } }); } else { const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; if (isIOS) { showToast("Tap 'Share' then 'Add to Home Screen'"); } else { showToast("Use browser menu to Install App"); } } };
            
            // INITIALIZE MAP & HANDLE SHARED LINKS
            useEffect(() => { if (!mapRef.current || mapInstanceRef.current) return; 
                const initialCenter = sharedLat && sharedLon ? [parseFloat(sharedLat), parseFloat(sharedLon)] : mapCenter;
                const initialZoom = sharedLat ? 17 : 13;
                const map = L.map(mapRef.current, { zoomControl: false, attributionControl: false }).setView(initialCenter, initialZoom); 
                mapInstanceRef.current = map; 
                const tileUrl = isDarkMode ? 'https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png'; 
                tileLayerRef.current = L.tileLayer(tileUrl, { attribution: '', subdomains: 'abcd', maxZoom: 20 }).addTo(map);
                markersRef.current = L.layerGroup().addTo(map); 
                const handleMove = () => { if (map.getZoom() < 13) { setZoomWarning(true); setAllLocations([]); markersRef.current.clearLayers(); } else { setZoomWarning(false); setLoading(true); const b = map.getBounds(); setSearchBounds(b); debouncedFetch(b); } }; 
                map.on('click', () => { if (selectedLocRef.current) { setCardMinimized(!cardMinimizedRef.current); } });
                map.on('moveend', handleMove); 
                if (sharedLat) { setLoading(true); debouncedFetch(map.getBounds()); } else { setLoading(true); const findLocation = async () => { let gpsResolved = false; try { const res = await fetch('https://ipapi.co/json/'); if (res.ok) { const data = await res.json(); if (!gpsResolved && data.latitude && data.longitude) { updateUserLocation([data.latitude, data.longitude], 'IP'); } } } catch (e) { console.log('IP Loc failed'); } navigator.geolocation.getCurrentPosition( (pos) => { gpsResolved = true; updateUserLocation([pos.coords.latitude, pos.coords.longitude], 'GPS'); }, (err) => { console.log('GPS denied'); }, { enableHighAccuracy: true, timeout: 10000 } ); }; findLocation(); }
            }, []);
            
            useEffect(() => {
                if (targetId && allLocations.length > 0) {
                    const found = allLocations.find(l => l.id == targetId);
                    if (found) { setSelectedLoc(found); setTargetId(null); }
                }
            }, [allLocations, targetId]);

            // UPDATED: Marker rendering with Supabase status glow
            useEffect(() => { 
                if (!markersRef.current) return; 
                markersRef.current.clearLayers(); 
                visibleLocations.forEach(loc => { 
                    let iconHtml = loc.displayType === 'black' ? ICONS.trash : loc.displayType === 'grey' ? ICONS.drop : ICONS[loc.displayType] || ICONS.toilet; 
                    const types = []; 
                    if (loc.isToilet) types.push('toilet'); if (loc.isWater) types.push('water'); if (loc.hasBaby) types.push('baby'); if (loc.hasShower) types.push('shower'); if (loc.isBlack) types.push('black'); if (loc.isGrey) types.push('grey'); if (types.length === 0) types.push('toilet'); 
                    
                    let backgroundStyle = ''; 
                    if (types.length === 1) { backgroundStyle = `background-color: ${TYPE_COLORS[types[0]]};`; } else { const segmentSize = 100 / types.length; const gradientParts = types.map((t, i) => { const color = TYPE_COLORS[t]; const start = i * segmentSize; const end = (i + 1) * segmentSize; return `${color} ${start}% ${end}%`; }); backgroundStyle = `background: conic-gradient(${gradientParts.join(', ')});`; } 
                    
                    // --- STATUS STYLING LOGIC ---
                    const status = statuses[loc.id] ? statuses[loc.id].status : null;
                    let borderClass = 'border-white dark:border-zinc-700';
                    let glowStyle = '';
                    let opacityStyle = '';

                    if (status === 'working') {
                        borderClass = 'border-emerald-500';
                        glowStyle = 'box-shadow: 0 0 10px rgba(16, 185, 129, 0.6);';
                    } else if (status === 'broken') {
                        borderClass = 'border-slate-500';
                        opacityStyle = 'opacity: 0.6; filter: grayscale(100%);';
                    }
                    // ---------------------------

                    L.marker([loc.lat, loc.lon], { 
                        icon: L.divIcon({ 
                            className: '', 
                            html: `<div class="relative w-9 h-9" style="${opacityStyle}"><div class="w-9 h-9 rounded-full flex items-center justify-center border-2 ${borderClass} text-white z-10 relative shadow-sm" style="${backgroundStyle} ${glowStyle}"><div class="pie-icon flex items-center justify-center">${iconHtml}</div></div></div>`, 
                            iconSize: [36, 36], 
                            iconAnchor: [18, 36] 
                        }) 
                    }).addTo(markersRef.current).on('click', () => { goToLoc(loc); triggerHaptic(); }); 
                }); 
            }, [visibleLocations, isDarkMode, statuses]); // Re-render when statuses change
            
            const handleSearch = async (e) => { e.preventDefault(); if (!searchTerm) return; setLoading(true); try { const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(searchTerm)); const data = await res.json(); if (data && data.length > 0) { const result = data[0]; mapInstanceRef.current.flyTo([result.lat, result.lon], 16); addToHistory(searchTerm); setSearchTerm(''); setShowHistory(false); showToast(`Welcome to ${result.display_name.split(',')[0]}`); } else { showToast('Place not found.'); } } catch (err) { showToast('Search failed.'); } finally { setLoading(false); } };
            const handleHistoryClick = (term) => { setSearchTerm(term); setTimeout(() => { searchWithTerm(term); }, 0); };
            const searchWithTerm = async (term) => { if (!term) return; setLoading(true); try { const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(term)); const data = await res.json(); if (data && data.length > 0) { const result = data[0]; mapInstanceRef.current.flyTo([result.lat, result.lon], 16); addToHistory(term); setSearchTerm(''); setShowHistory(false); showToast(`Welcome to ${result.display_name.split(',')[0]}`); } else { showToast('Place not found.'); } } catch (err) { showToast('Search failed.'); } finally { setLoading(false); } };
            const selectSuggestion = (sugg) => { mapInstanceRef.current.flyTo([sugg.lat, sugg.lon], 16); addToHistory(sugg.display_name.split(',')[0]); setSearchTerm(''); setShowHistory(false); showToast(`Welcome to ${sugg.display_name.split(',')[0]}`); }
            
            const handleOrientation = (e) => { let heading = 0; if (e.webkitCompassHeading) { heading = e.webkitCompassHeading; } else if (e.alpha) { heading = 360 - e.alpha; } const beam = document.getElementById('user-heading-beam'); if (beam) { beam.style.display = 'block'; beam.style.transform = `rotate(${heading}deg)`; } };
            const requestCompass = async () => { if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') { try { const response = await DeviceOrientationEvent.requestPermission(); if (response === 'granted') { window.addEventListener('deviceorientation', handleOrientation); } } catch (e) { console.error(e); } } else { window.addEventListener('deviceorientation', handleOrientation); } };
            const handleGPS = () => { triggerHaptic(); requestCompass(); const map = mapInstanceRef.current; if (!map || !userPos) return; const center = map.getCenter(); const distInfo = calculateDistance(center.lat, center.lng, userPos[0], userPos[1]); if (distInfo.km > 0.05) { map.flyTo(userPos, 17); navigator.geolocation.getCurrentPosition( (pos) => { updateUserLocation([pos.coords.latitude, pos.coords.longitude], 'GPS'); }, (err) => { }, { enableHighAccuracy: true, timeout: 10000 } ); return; } if (!navigator.geolocation) { showToast('GPS not supported'); return; } setGpsStatus('searching'); navigator.geolocation.getCurrentPosition( (pos) => { const coords = [pos.coords.latitude, pos.coords.longitude]; updateUserLocation(coords, 'GPS'); }, (err) => { setGpsStatus('idle'); showToast('GPS Access Denied'); }, { enableHighAccuracy: true } ); };
            
            const startPickingLocation = () => { triggerHaptic(); closeAllMenus(); setIsPickingLocation(true); if (mapInstanceRef.current && mapInstanceRef.current.getZoom() < 18) { mapInstanceRef.current.flyTo(mapInstanceRef.current.getCenter(), 18, { duration: 0.5 }); } };
            const confirmLocation = () => { if (mapInstanceRef.current) { const center = mapInstanceRef.current.getCenter(); setContributeCoords({ lat: center.lat, lon: center.lng }); setIsPickingLocation(false); setShowContribute(true); } };
            const cancelPicking = () => { setIsPickingLocation(false); };

            // --- UPDATED GO-TO-LOC (SMART ZOOM) ---
            const goToLoc = (loc) => { 
                closeAllMenus(); 
                setCardMinimized(true); // SET TO MINIMIZED DEFAULT
                setSelectedLoc(loc); 
                setView('map'); 
                
                if (!mapInstanceRef.current) return;
                
                const map = mapInstanceRef.current;
                const dist = userPos ? calculateDistance(userPos[0], userPos[1], loc.lat, loc.lon) : { km: 99999 };
                
                if (dist.km <= 2 && userPos) {
                    // Fit start and end points if close
                    const bounds = L.latLngBounds([userPos, [loc.lat, loc.lon]]);
                    map.fitBounds(bounds, {
                        paddingTopLeft: [50, 50],
                        paddingBottomRight: [50, 300], // Accommodate card at bottom
                        animate: true,
                        maxZoom: 17
                    });
                } else {
                    // Fly to location (Far away behavior)
                    const targetZoom = 17; 
                    const point = map.project([loc.lat, loc.lon], targetZoom); 
                    const offsetY = map.getSize().y * 0.25; // Shift map center up so pin is lower (above card)
                    const targetPoint = L.point(point.x, point.y + offsetY); 
                    const newCenter = map.unproject(targetPoint, targetZoom); 
                    map.flyTo(newCenter, targetZoom); 
                }
            }
            const openReport = (loc) => { setCorrectionData(loc); setShowCorrection(true); };

            return html`
                <div class="bg-white/95 dark:bg-zinc-900/95 backdrop-blur z-[1700] shadow-sm safe-pt transition-colors duration-300">
                    <div class="flex items-center justify-between px-5 pt-4 pb-2">
                        <div class="flex items-center">
                            <h1 onClick=${handleAboutClick} class="text-2xl font-brand font-semibold text-slate-700 dark:text-zinc-100 tracking-tight cursor-pointer hover:text-slate-900 dark:hover:text-white transition-colors">Loocator</h1>
                            ${isCamperMode && html`
                                <div class="ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold bg-rose-500 text-white leading-none self-start mt-1">BETA</div>
                            `}
                        </div>
                        <div class="flex gap-2">
                            ${showInstallButton && html`<button onClick=${handleInstall} class="bg-slate-200 dark:bg-zinc-700 text-slate-800 dark:text-zinc-200 px-3 py-2 rounded-full text-xs font-bold flex items-center gap-2"><div class="flex items-center justify-center w-4 h-4" dangerouslySetInnerHTML=${{__html: ICONS.download}}></div><span>Install</span></button>`}
                            <button onClick=${handleFilterClick} class="bg-slate-100 dark:bg-zinc-800 text-slate-500 dark:text-zinc-400 px-3 py-2 rounded-full text-xs font-bold"><div class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.filter}}></div></button>
                            <button onClick=${handleViewToggle} class="bg-slate-100 dark:bg-zinc-800 text-slate-500 dark:text-zinc-400 px-3 py-2 rounded-full text-xs font-bold"><div class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: view === 'map' ? ICONS.list : ICONS.map}}></div></button>
                        </div>
                    </div>
                    <div class="px-4 pb-2 relative z-[1001]">
                        <form onSubmit=${handleSearch} class="relative z-[1001]">
                            <input type="search" name="q" id="search-input" inputmode="search" placeholder="Search city..." class="w-full bg-slate-50 dark:bg-zinc-800 rounded-2xl py-3 pl-10 pr-4 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-slate-500 dark:focus:ring-zinc-600 focus:bg-white dark:focus:bg-zinc-700 shadow-inner text-slate-600 dark:text-zinc-200 placeholder-slate-400 dark:placeholder-zinc-500 transition-colors" value=${searchTerm} onInput=${handleInput} onFocus=${() => setShowHistory(true)} onBlur=${() => setTimeout(() => setShowHistory(false), 200)} autocomplete="off" />
                            <button type="submit" class="absolute left-3.5 top-3 text-slate-400 dark:text-zinc-500 w-5 h-5 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.search}}></button>
                        </form>
                        ${showHistory && ((searchTerm && historyMatches.length > 0) || (!searchTerm && searchHistory.length > 0) || apiSuggestions.length > 0) && html`
                            <div class="absolute top-full left-4 right-4 mt-2 bg-white dark:bg-zinc-800 rounded-xl shadow-xl border border-slate-100 dark:border-zinc-700 overflow-hidden z-[2000] animate-fade-in-down max-h-[60vh] overflow-y-auto">
                                ${searchTerm && historyMatches.length > 0 && html`<div class="px-4 py-2 text-[10px] font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-wider bg-slate-50 dark:bg-zinc-900/50">History</div>${historyMatches.map(term => html`<div class="px-4 py-3 flex items-center gap-3 hover:bg-slate-50 dark:hover:bg-zinc-700 cursor-pointer border-b border-slate-50 dark:border-zinc-700/50 last:border-0" onMouseDown=${(e) => e.preventDefault()} onClick=${() => handleHistoryClick(term)}><div class="w-4 h-4 text-slate-400 dark:text-zinc-500 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.clock}}></div><span class="text-sm font-medium text-slate-700 dark:text-zinc-200">${term}</span></div>`)}`}
                                ${!searchTerm && searchHistory.length > 0 && html`<div class="px-4 py-2 text-[10px] font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-wider bg-slate-50 dark:bg-zinc-900/50">Recent</div>${searchHistory.map(term => html`<div class="px-4 py-3 flex items-center gap-3 hover:bg-slate-50 dark:hover:bg-zinc-700 cursor-pointer border-b border-slate-50 dark:border-zinc-700/50 last:border-0" onMouseDown=${(e) => e.preventDefault()} onClick=${() => handleHistoryClick(term)}><div class="w-4 h-4 text-slate-400 dark:text-zinc-500 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.clock}}></div><span class="text-sm font-medium text-slate-700 dark:text-zinc-200">${term}</span></div>`)}`}
                                ${apiSuggestions.length > 0 && html`<div class="px-4 py-2 text-[10px] font-bold text-slate-400 dark:text-zinc-500 uppercase tracking-wider bg-slate-50 dark:bg-zinc-900/50">Suggestions</div>${apiSuggestions.map(sugg => html`<div class="px-4 py-3 flex items-center gap-3 hover:bg-slate-50 dark:hover:bg-zinc-700 cursor-pointer border-b border-slate-50 dark:border-zinc-700/50 last:border-0" onMouseDown=${(e) => e.preventDefault()} onClick=${() => selectSuggestion(sugg)}><div class="w-4 h-4 text-slate-400 dark:text-zinc-500 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.pin}}></div><div class="flex flex-col"><span class="text-sm font-medium text-slate-700 dark:text-zinc-200">${sugg.address.city || sugg.address.town || sugg.address.village || sugg.name}</span><span class="text-xs text-slate-400 dark:text-zinc-500 truncate max-w-[200px]">${sugg.display_name}</span></div></div>`)}`}
                            </div>
                        `}
                    </div>
                    <div class="px-4 flex space-x-2 overflow-x-auto no-scrollbar pb-2">
                        ${!isCamperMode ? html`<${FilterBtn} type="toilet" label="Toilets" active=${stdFilters.toilet} onClick=${() => setStdFilters({...stdFilters, toilet: !stdFilters.toilet})} /><${FilterBtn} type="water" label="Water" active=${stdFilters.water} color="teal" onClick=${() => setStdFilters({...stdFilters, water: !stdFilters.water})} /><${FilterBtn} type="baby" label="Baby" active=${stdFilters.baby} color="rose" onClick=${() => setStdFilters({...stdFilters, baby: !stdFilters.baby})} />` : html`<${FilterBtn} type="trash" label="Black" active=${vanFilters.black} color="black" onClick=${() => setVanFilters({...vanFilters, black: !vanFilters.black})} /><${FilterBtn} type="drop" label="Grey" active=${vanFilters.grey} color="grey" onClick=${() => setVanFilters({...vanFilters, grey: !vanFilters.grey})} /><${FilterBtn} type="water" label="Tank" active=${vanFilters.water} color="teal" onClick=${() => setVanFilters({...vanFilters, water: !vanFilters.water})} /><${FilterBtn} type="shower" label="Shower" active=${vanFilters.shower} color="sky" onClick=${() => setVanFilters({...vanFilters, shower: !vanFilters.shower})} />`}
                    </div>
                </div>
                <div class="map-wrapper relative bg-slate-200 dark:bg-zinc-900">
                    <div class="absolute top-4 left-0 right-0 flex justify-center z-[1000] pointer-events-none">
                        ${zoomWarning && !loading && html`<${AlertPill} msg="Zoom in to find spots" />`}
                        ${showListHint && html`<button onClick=${handleViewChange} class="bg-white dark:bg-zinc-800 text-slate-800 dark:text-zinc-300 px-5 py-2.5 rounded-full shadow-lg text-sm font-bold font-brand z-[1000] pointer-events-auto active:scale-95 transition-transform flex items-center gap-2 mt-2 animate-ripple"><span>Nothing nearby. View List</span><div class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.list}}></div></button>`}
                    </div>
                    ${isPickingLocation && html`<div class="absolute inset-0 z-[1100] pointer-events-none flex items-center justify-center"><div class="text-slate-800 dark:text-zinc-200 drop-shadow-xl -translate-y-1/2"><span class="material-symbols-rounded text-6xl">location_on</span></div></div><div class="absolute bottom-10 left-0 right-0 z-[1200] flex flex-col items-center space-y-3 px-6 pointer-events-auto"><div class="bg-slate-800/80 backdrop-blur text-white px-4 py-2 rounded-full text-sm font-semibold shadow-lg">Move map to position pin</div><div class="flex w-full gap-3 max-w-sm"><button onClick=${cancelPicking} class="flex-1 bg-white dark:bg-zinc-800 text-slate-600 dark:text-zinc-300 font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-transform">Cancel</button><button onClick=${confirmLocation} class="flex-[2] bg-slate-800 dark:bg-zinc-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-transform">Confirm Location</button></div></div>`}
                    <div id="map" ref=${mapRef} class="transition-opacity duration-500"></div>
                    ${(view === 'list' || isListExiting) && html`<div class="list-wrapper p-4 pb-24 safe-pb bg-slate-50 dark:bg-zinc-950 transition-colors duration-300">${inAreaLocs.length === 0 && furtherLocs.length === 0 && html`<div class="text-center text-slate-400 dark:text-zinc-600 mt-20"><div class="w-16 h-16 mx-auto mb-4 text-slate-300 dark:text-zinc-700 opacity-50 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS.search}}></div><p class="font-brand text-lg">No spots visible.</p></div>`}${inAreaLocs.map((loc, i) => html`<${ListItem} key=${loc.id} loc=${loc} userPos=${userPos} index=${i} isExiting=${isListExiting} onClick=${() => goToLoc(loc)} statusData=${statuses[loc.id]} />`)}${furtherLocs.length > 0 && html`<div class="py-4 flex items-center gap-4 animate-stagger-fade" style=${{ animationDelay: '300ms' }}><div class="h-px bg-slate-200 dark:bg-zinc-800 flex-1"></div><span class="text-xs font-bold text-slate-400 dark:text-zinc-600 uppercase tracking-wider">Further Afield</span><div class="h-px bg-slate-200 dark:bg-zinc-800 flex-1"></div></div>${furtherLocs.map((loc, i) => html`<${ListItem} key=${loc.id} loc=${loc} userPos=${userPos} index=${i + inAreaLocs.length} isExiting=${isListExiting} onClick=${() => goToLoc(loc)} statusData=${statuses[loc.id]} />`)}`}</div>`}
                </div>
                ${!isPickingLocation && !selectedLoc && html`${(gpsStatus !== 'idle' || loading) && html`<div class="absolute right-5 bottom-40 w-14 h-14 bg-white dark:bg-zinc-800 rounded-full shadow-lg z-[1000] flex items-center justify-center animate-pop-in border border-slate-100 dark:border-zinc-700">${(() => { if (gpsStatus === 'success') return html`<div class="w-5 h-5 text-emerald-500 flex items-center justify-center animate-scale-in" dangerouslySetInnerHTML=${{__html: ICONS.check}}></div>`; if (gpsStatus === 'searching') return html`<span class="material-symbols-rounded animate-pulse-fast text-sky-500 text-xl">my_location</span>`; if (loading) return html`<div class="w-5 h-5 border-2 border-slate-400 border-t-transparent rounded-full animate-spin"></div>`; return null; })()}</div>`}<button onClick=${() => { triggerHaptic(); closeAllMenus(); setIsPickingLocation(true); if (mapInstanceRef.current.getZoom() < 18) mapInstanceRef.current.flyTo(mapInstanceRef.current.getCenter(), 18); }} class="absolute right-5 w-14 h-14 bg-white dark:bg-zinc-800 text-slate-800 dark:text-zinc-200 rounded-full shadow-lg flex items-center justify-center z-[1000] active:scale-90 transition-all bottom-24" dangerouslySetInnerHTML=${{__html: ICONS.plus}}></button><button onClick=${handleGPS} class="absolute right-5 w-14 h-14 bg-slate-800 text-white rounded-full shadow-2xl flex items-center justify-center z-[1000] active:scale-90 transition-all bottom-8" dangerouslySetInnerHTML=${{__html: ICONS.target}}></button>`}
                ${showFilters && html`<${FilterSheet} ref=${filterSheetRef} freeOnly=${freeOnly} setFreeOnly=${setFreeOnly} bottleOnly=${bottleOnly} setBottleOnly=${setBottleOnly} accessOnly=${accessOnly} setAccessOnly=${setAccessOnly} keyOnly=${keyOnly} setKeyOnly=${setKeyOnly} navAppDrive=${navAppDrive} setNavAppDrive=${setNavAppDrive} navAppWalk=${navAppWalk} setNavAppWalk=${setNavAppWalk} clearHistory=${clearHistory} onClose=${() => setShowFilters(false)} isCamperMode=${isCamperMode} toggleMode=${toggleMode} />`}
                ${showAbout && html`<${AboutModal} onClose=${() => setShowAbout(false)} onShowToast=${showToast} />`}
                ${showCamperDisclaimer && html`<${CamperDisclaimerModal} onClose=${() => setShowCamperDisclaimer(false)} onAccept=${confirmCamperMode} />`}
                ${showContribute && contributeCoords && html`<${ContributeSheet} lat=${contributeCoords.lat} lon=${contributeCoords.lon} onClose=${() => setShowContribute(false)} onShowToast=${showToast} />`}
                ${showCorrection && correctionData && html`<${ContributeSheet} lat=${correctionData.lat} lon=${correctionData.lon} isCorrection=${true} correctionId=${correctionData.id} correctionName=${correctionData.name} onClose=${() => setShowCorrection(false)} onShowToast=${showToast} />`}
                ${selectedLoc && html`<${DetailsCard} loc=${selectedLoc} userLoc=${userPos} navAppDrive=${navAppDrive} navAppWalk=${navAppWalk} onClose=${() => setSelectedLoc(null)} minimized=${cardMinimized} setMinimized=${setCardMinimized} onReport=${openReport} onShowToast=${showToast} onReportStatus=${reportStatus} statusData=${statuses[selectedLoc.id]} />`}
                <${Toast} msg=${toast.msg} visible=${toast.visible} />
            `;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(html`<${App} />`);
    </script>
</body>
</html>
