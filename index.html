<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#18181b" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#f8fafc" media="(prefers-color-scheme: light)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Loocator">
    
    <title>Loocator</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media', 
            theme: {
                extend: {
                    fontFamily: { sans: ['Fredoka', 'sans-serif'], brand: ['Fredoka', 'sans-serif'] },
                    animation: {
                        'scale-in': 'scaleIn 0.2s ease-out forwards',
                        'slide-up-card': 'slideUpCard 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-down-card': 'slideDownCard 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'stagger-fade': 'staggerFade 0.4s ease-out forwards',
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                    },
                    keyframes: {
                        scaleIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        slideUpCard: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        slideDownCard: { '0%': { transform: 'translateY(0)' }, '100%': { transform: 'translateY(100%)' } },
                        staggerFade: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.5)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f8fafc; overscroll-behavior: none; }
        * { -webkit-tap-highlight-color: transparent; }
        @media (prefers-color-scheme: dark) { body, html { background-color: #09090b; } }
        #root { height: 100%; display: flex; flex-direction: column; }
        .map-wrapper { position: relative; flex-grow: 1; width: 100%; height: 100%; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; background: transparent; }
        .list-wrapper { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 50; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .pie-icon { text-shadow: 0 1px 3px rgba(0,0,0,0.4); }
        .user-pin-ring { position: absolute; width: 24px; height: 24px; border-radius: 50%; background-color: #3b82f6; opacity: 0.3; animation: pulse-ring 2s infinite; }
        .user-pin-dot { position: absolute; width: 14px; height: 14px; border-radius: 50%; background-color: #3b82f6; border: 2px solid white; top: 5px; left: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.3); z-index: 2; }
        @keyframes pulse-ring { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }
        .safe-pt { padding-top: env(safe-area-inset-top); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-zinc-950 transition-colors duration-300">
    <div id="root"></div>

    <script>
        const html = htm.bind(React.createElement);
        const { useState, useEffect, useRef, useMemo, forwardRef, useImperativeHandle } = React;

        const SB_URL = 'https://jnjovmqfbelouittlvhh.supabase.co';
        const SB_KEY = 'sb_publishable_SYpOip4dUTH0yT6MNUYF6A_94uy9Snd';
        let supabaseClient = null;
        try { if (window.supabase) supabaseClient = window.supabase.createClient(SB_URL, SB_KEY); } catch (e) {}

        const ICONS = {
            toilet: `<span class="material-symbols-rounded">wc</span>`,
            water: `<span class="material-symbols-rounded">water_drop</span>`,
            baby: `<span class="material-symbols-rounded">child_care</span>`,
            van: `<span class="material-symbols-rounded">airport_shuttle</span>`,
            shower: `<span class="material-symbols-rounded">shower</span>`,
            trash: `<span class="material-symbols-rounded">delete</span>`,
            drop: `<span class="material-symbols-rounded">opacity</span>`,
            search: `<span class="material-symbols-rounded">search</span>`,
            target: `<span class="material-symbols-rounded">my_location</span>`,
            list: `<span class="material-symbols-rounded">format_list_bulleted</span>`,
            map: `<span class="material-symbols-rounded">map</span>`,
            filter: `<span class="material-symbols-rounded">tune</span>`,
            share: `<span class="material-symbols-rounded">share</span>`,
            car: `<span class="material-symbols-rounded">directions_car</span>`,
            walk: `<span class="material-symbols-rounded">directions_walk</span>`,
            star: `<span class="material-symbols-rounded">star</span>`
        };

        const TYPE_COLORS = { toilet: '#64748b', water: '#14b8a6', baby: '#fb7185', shower: '#0ea5e9', black: '#1e293b', grey: '#94a3b8' };

        const safeParse = (key, fallback) => {
            try { const item = localStorage.getItem(key); return item ? JSON.parse(item) : fallback; } catch (e) { return fallback; }
        };

        const triggerHaptic = () => { if (navigator.vibrate) navigator.vibrate(10); };

        const OfflineBanner = ({ isOffline }) => html`
            <div class=${`fixed top-0 left-0 right-0 z-[4000] bg-rose-500 text-white text-[10px] font-bold text-center py-1 safe-pt transition-transform duration-500 ${isOffline ? 'translate-y-0' : '-translate-y-full'}`}>
                OFFLINE MODE (MODO DESCONECTADO)
            </div>`;

        const DetailsCard = ({ loc, userLoc, onClose, minimized, setMinimized, onReportStatus, statusData }) => {
            if (!loc) return null;
            const [isRatingMode, setIsRatingMode] = useState(false);
            const [userRating, setUserRating] = useState(0);

            const submitReport = (status) => {
                onReportStatus(loc.id, status, userRating);
                setIsRatingMode(false);
            };

            return html`
                <div style=${{ transform: minimized ? 'translateY(calc(100% - 150px))' : 'translateY(0)' }} 
                    class="fixed bottom-0 left-0 right-0 bg-white dark:bg-zinc-900 rounded-t-[32px] shadow-2xl z-[1500] safe-pb transition-transform duration-500 ease-[cubic-bezier(0.16,1,0.3,1)]">
                    <div class="w-full flex justify-center py-4 cursor-pointer" onClick=${() => setMinimized(!minimized)}>
                        <div class="w-12 h-1 bg-slate-200 dark:bg-zinc-700 rounded-full"></div>
                    </div>
                    <div class="px-6 pb-6 overflow-y-auto max-h-[75vh]">
                        <h2 class="text-2xl font-bold mb-1">${loc.name}</h2>
                        
                        <div class="flex items-center justify-between bg-slate-50 dark:bg-zinc-800/50 p-4 rounded-2xl mb-6 border border-slate-100 dark:border-zinc-800">
                            <div class="flex items-center gap-2">
                                <span class=${`w-2.5 h-2.5 rounded-full ${statusData?.status === 'broken' ? 'bg-rose-500' : 'bg-emerald-500'}`}></span>
                                <span class="text-sm font-bold">${statusData?.status === 'broken' ? 'Broken' : 'Verified Working'}</span>
                            </div>
                            ${statusData?.rating && html`
                                <div class="flex items-center gap-1 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 px-3 py-1 rounded-full font-bold text-sm">
                                    <span>${parseFloat(statusData.rating).toFixed(1)}</span>
                                    <span class="material-symbols-rounded text-base">star</span>
                                </div>
                            `}
                        </div>

                        <div class="mb-6">
                           ${!isRatingMode ? html`
                                <button onClick=${() => setIsRatingMode(true)} class="w-full py-3 bg-slate-100 dark:bg-zinc-800 rounded-xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-all">
                                    <span class="material-symbols-rounded text-amber-400">star</span> Verify & Rate
                                </button>
                           ` : html`
                                <div class="space-y-4 animate-scale-in">
                                    <div class="flex justify-center gap-2">
                                        ${[1,2,3,4,5].map(s => html`<button onClick=${() => setUserRating(s)} class=${`text-3xl ${s <= userRating ? 'text-amber-400' : 'text-slate-200 dark:text-zinc-700'}`}><span class="material-symbols-rounded text-4xl">star</span></button>`)}
                                    </div>
                                    <div class="flex gap-2">
                                        <button onClick=${() => submitReport('working')} class="flex-1 py-3 bg-emerald-500 text-white rounded-xl font-bold active:scale-95 transition-all">Working</button>
                                        <button onClick=${() => submitReport('broken')} class="flex-1 py-3 bg-rose-500 text-white rounded-xl font-bold active:scale-95 transition-all">Broken</button>
                                    </div>
                                </div>
                           `}
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <button onClick=${() => window.open(`http://maps.apple.com/?daddr=${loc.lat},${loc.lon}`)} class="py-4 bg-slate-800 text-white dark:bg-zinc-200 dark:text-zinc-900 rounded-2xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-all">Drive</button>
                            <button onClick=${() => window.open(`https://www.google.com/maps/dir/?api=1&destination=${loc.lat},${loc.lon}&travelmode=walking`)} class="py-4 bg-zinc-100 dark:bg-zinc-800 rounded-2xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-all">Walk</button>
                        </div>
                    </div>
                </div>`;
        };

        const FilterBtn = ({ type, label, active, onClick, color = 'slate' }) => {
            const colors = { slate: 'bg-slate-800 dark:bg-zinc-600', teal: 'bg-teal-500', rose: 'bg-rose-400', black: 'bg-slate-900', grey: 'bg-slate-400', sky: 'bg-sky-500' };
            return html`
                <button onClick=${onClick} class=${`flex items-center space-x-2 px-4 py-2.5 rounded-full text-xs font-bold shrink-0 transition-all active:scale-90 border ${active ? colors[color] + ' text-white border-transparent shadow-md' : 'bg-white dark:bg-zinc-800 text-slate-700 dark:text-zinc-300 border-slate-200 dark:border-zinc-700 shadow-sm'}`}>
                    <div class="w-4 h-4 flex items-center justify-center" dangerouslySetInnerHTML=${{__html: ICONS[type]}}></div>
                    <span>${label}</span>
                </button>`;
        };

        function App() {
            const [view, setView] = useState('map');
            const [allLocations, setAllLocations] = useState([]);
            const [selectedLoc, setSelectedLoc] = useState(null);
            const [cardMinimized, setCardMinimized] = useState(false);
            const [statuses, setStatuses] = useState({});
            const [isCamperMode, setIsCamperMode] = useState(localStorage.getItem('loocator_van_mode') === 'true');
            const [isOffline, setIsOffline] = useState(!navigator.onLine);
            
            const savedPos = safeParse('loocator_last_pos', [51.505, -0.09]);
            const [userPos, setUserPos] = useState(savedPos);
            
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const markersRef = useRef(null);

            const reportStatus = async (osmId, newStatus, rating = null) => {
                triggerHaptic();
                if(!supabaseClient || !navigator.onLine) return;
                const current = statuses[osmId] || { rating_sum: 0, rating_count: 0 };
                const prevSum = Number(current.rating_sum || 0);
                const prevCount = Number(current.rating_count || 0);

                let payload = { id: String(osmId), status: newStatus, last_verified: new Date().toISOString() };
                if (rating) {
                    const count = prevCount + 1;
                    const sum = prevSum + Number(rating);
                    payload.rating_count = count;
                    payload.rating_sum = sum;
                    payload.rating = sum / count;
                }
                await supabaseClient.from('amenity_status').upsert(payload);
                setStatuses(prev => ({ ...prev, [osmId]: payload }));
            };

            const fetchOverpass = async (bounds) => {
                if (!navigator.onLine) return;
                const c = bounds.getCenter();
                const query = `[out:json];(nwr["amenity"~"toilets|drinking_water|shower|sanitary_dump_station"](around:5000,${c.lat},${c.lng}););out center;`;
                try {
                    const res = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: 'data=' + encodeURIComponent(query) });
                    const data = await res.json();
                    setAllLocations(data.elements.map(el => ({
                        id: el.id, lat: el.lat || el.center.lat, lon: el.lon || el.center.lon,
                        name: el.tags.name || (el.tags.amenity === 'toilets' ? "Public Toilet" : "Water Point"),
                        type: el.tags.amenity
                    })));
                } catch(e){}
            };

            const debouncedFetch = useMemo(() => {
                let timeout;
                return (b) => { clearTimeout(timeout); timeout = setTimeout(() => fetchOverpass(b), 1000); };
            }, []);

            useEffect(() => {
                if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});
                window.addEventListener('online', () => setIsOffline(false));
                window.addEventListener('offline', () => setIsOffline(true));

                const map = L.map(mapRef.current, { zoomControl: false, attributionControl: false }).setView(savedPos, 15);
                mapInstance.current = map;
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
                markersRef.current = L.layerGroup().addTo(map);

                map.on('moveend', () => {
                    const c = map.getCenter();
                    localStorage.setItem('loocator_last_pos', JSON.stringify([c.lat, c.lng]));
                    debouncedFetch(map.getBounds());
                });

                navigator.geolocation.getCurrentPosition(pos => {
                    const coords = [pos.coords.latitude, pos.coords.longitude];
                    setUserPos(coords);
                    map.flyTo(coords, 17, { duration: 1.5 });
                    L.marker(coords, { icon: L.divIcon({ className: '', html: '<div class="user-pin-ring"></div><div class="user-pin-dot"></div>' }) }).addTo(map);
                });

                fetchOverpass(map.getBounds());
                if(supabaseClient) supabaseClient.from('amenity_status').select('*').then(({data}) => {
                    const map = {}; if(data) data.forEach(s => map[s.id] = s); setStatuses(map);
                });
            }, []);

            useEffect(() => {
                if (!markersRef.current) return;
                markersRef.current.clearLayers();
                allLocations.forEach(loc => {
                    const s = statuses[loc.id]?.status;
                    const border = s === 'broken' ? 'border-rose-500' : 'border-white';
                    const iconType = loc.type === 'drinking_water' ? 'water' : 'toilet';
                    L.marker([loc.lat, loc.lon], { 
                        icon: L.divIcon({
                            className: '',
                            html: `<div class="w-9 h-9 rounded-full bg-slate-600 border-2 ${border} flex items-center justify-center text-white shadow-lg pie-icon">${ICONS[iconType]}</div>`,
                            iconSize: [36, 36], iconAnchor: [18, 18]
                        })
                    }).addTo(markersRef.current).on('click', () => { triggerHaptic(); setSelectedLoc(loc); setCardMinimized(false); });
                });
            }, [allLocations, statuses]);

            return html`
                <div class="flex-1 flex flex-col overflow-hidden relative bg-white dark:bg-zinc-950">
                    <${OfflineBanner} isOffline=${isOffline} />
                    
                    <div class="safe-pt px-5 pt-4 pb-2 z-[1700] bg-white/80 dark:bg-zinc-900/80 backdrop-blur">
                        <div class="flex items-center justify-between mb-3">
                            <h1 class="text-2xl font-brand font-bold tracking-tight">Loocator ${isCamperMode && html`<span class="text-[10px] bg-rose-500 text-white px-1.5 py-0.5 rounded ml-1">BETA</span>`}</h1>
                            <div class="flex gap-2">
                                <button onClick=${() => setView(view === 'map' ? 'list' : 'map')} class="p-2 bg-slate-100 dark:bg-zinc-800 rounded-full text-slate-600 dark:text-zinc-300">
                                    <span class="material-symbols-rounded">${view === 'map' ? 'format_list_bulleted' : 'map'}</span>
                                </button>
                            </div>
                        </div>
                        <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                            <${FilterBtn} type="toilet" label="Toilets" active=${true} onClick=${()=>{}} />
                            <${FilterBtn} type="water" label="Water" active=${false} color="teal" onClick=${()=>{}} />
                            <${FilterBtn} type="van" label="Camper" active=${isCamperMode} color="rose" onClick=${() => { setIsCamperMode(!isCamperMode); localStorage.setItem('loocator_van_mode', !isCamperMode); }} />
                        </div>
                    </div>

                    <div class="map-wrapper flex-1 relative">
                        <div id="map" ref=${mapRef}></div>
                        ${view === 'list' && html`
                            <div class="list-wrapper bg-slate-50 dark:bg-zinc-950 p-4 safe-pb">
                                ${allLocations.map(loc => html`
                                    <div onClick=${() => { setSelectedLoc(loc); setView('map'); }} class="bg-white dark:bg-zinc-900 p-4 rounded-2xl mb-3 shadow-sm border border-slate-100 dark:border-zinc-800 flex justify-between items-center active:scale-95 transition-transform">
                                        <div class="font-bold">${loc.name}</div>
                                        <span class="material-symbols-rounded text-slate-300">chevron_right</span>
                                    </div>
                                `)}
                            </div>
                        `}
                        <button onClick=${() => mapInstance.current.flyTo(userPos, 18)} class="absolute right-4 bottom-40 z-[1000] w-14 h-14 bg-slate-800 text-white rounded-full shadow-2xl flex items-center justify-center active:scale-90 transition-all">
                            <span class="material-symbols-rounded text-2xl">my_location</span>
                        </button>
                    </div>

                    ${selectedLoc && html`
                        <${DetailsCard} loc=${selectedLoc} statusData=${statuses[selectedLoc.id]}
                            onClose=${() => setSelectedLoc(null)} onReportStatus=${reportStatus}
                            minimized=${cardMinimized} setMinimized=${setCardMinimized} />
                    `}
                </div>`;
        }

        ReactDOM.createRoot(document.getElementById('root')).render(html`<${App} />`);
    </script>
</body>
</html>
